<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CloudPAM</title>
    <style>
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --muted: #64748b;
        --text: #0f172a;
        --text-secondary: #475569;
        --border: #e2e8f0;
        --border-light: #f1f5f9;
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
        --primary-subtle: #eff6ff;
        --success: #059669;
        --success-light: #d1fae5;
        --danger: #dc2626;
        --danger-light: #fee2e2;
        --warning: #d97706;
        --warning-light: #fef3c7;
        --radius: 8px;
        --radius-lg: 12px;
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      }
      * { box-sizing: border-box; }
      [x-cloak] { display: none !important; }
      body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; font-size: 14px; line-height: 1.5; }

      /* Header */
      .header { background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
      .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; display: flex; align-items: center; height: 60px; gap: 2rem; }
      .logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 18px; color: var(--text); text-decoration: none; }
      .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
      .nav { display: flex; gap: 0.25rem; }
      .nav-item { padding: 0.5rem 1rem; border-radius: var(--radius); color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 14px; transition: all 0.15s ease; cursor: pointer; border: none; background: none; }
      .nav-item:hover { background: var(--border-light); color: var(--text); }
      .nav-item.active { background: var(--primary-subtle); color: var(--primary); }
      .header-actions { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }

      /* Main Content */
      .muted { color: var(--muted); }
      main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
      .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
      .page-title { font-size: 24px; font-weight: 600; margin: 0; }
      .page-subtitle { color: var(--muted); margin: 0.25rem 0 0 0; font-size: 14px; }

      /* Cards */
      .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); }
      .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
      .card-title { font-size: 15px; font-weight: 600; margin: 0; }
      .card-body { padding: 1.25rem; }
      .card-padded { padding: 1rem 1.25rem; }

      /* Form Elements */
      input, select { padding: 0.5rem 0.75rem; font-size: 14px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--card); color: var(--text); outline: none; transition: border-color 0.15s ease, box-shadow 0.15s ease; }
      input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
      input::placeholder { color: var(--muted); }
      .form-group { display: flex; flex-direction: column; gap: 0.375rem; }
      .form-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
      .form-hint { font-size: 12px; color: var(--muted); }

      /* Buttons */
      .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 14px; font-weight: 500; border-radius: var(--radius); border: 1px solid transparent; cursor: pointer; transition: all 0.15s ease; text-decoration: none; }
      .btn:hover { transform: translateY(-1px); }
      .btn:active { transform: translateY(0); }
      .btn:not(.ghost) { background: var(--primary); color: white; border-color: var(--primary); }
      .btn:not(.ghost):hover { background: var(--primary-hover); border-color: var(--primary-hover); }
      .btn.ghost { background: transparent; color: var(--primary); border-color: var(--border); }
      .btn.ghost:hover { background: var(--border-light); border-color: var(--border); }
      .btn.btn-secondary { background: var(--card); color: var(--text); border-color: var(--border); }
      .btn.btn-secondary:hover { background: var(--border-light); }
      .btn.btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
      .btn.btn-sm { padding: 0.375rem 0.75rem; font-size: 13px; }
      .btn[disabled] { opacity: 0.5; cursor: not-allowed; transform: none; }

      /* Tables */
      table { border-collapse: collapse; width: 100%; }
      th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
      th { background: var(--border-light); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
      thead th.sticky { position: sticky; top: 0; z-index: 1; }
      tbody tr:hover { background: var(--border-light); }
      tbody tr:nth-child(even) { background: rgba(248, 250, 252, 0.5); }
      tbody tr:nth-child(even):hover { background: var(--border-light); }
      .table-wrapper { overflow-x: auto; }

      /* Toolbar */
      .toolbar { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
      .toolbar-search { flex: 1; min-width: 200px; max-width: 300px; }
      .toolbar-divider { width: 1px; height: 24px; background: var(--border); }
      .toolbar-group { display: flex; align-items: center; gap: 0.5rem; }
      .toolbar-label { font-size: 13px; color: var(--muted); }

      /* Pagination */
      .pagination { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.25rem; border-top: 1px solid var(--border); background: var(--border-light); border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
      .pagination-info { font-size: 13px; color: var(--muted); }
      .pagination-controls { display: flex; align-items: center; gap: 0.25rem; }

      /* Badges */
      .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.625rem; font-size: 12px; font-weight: 500; border-radius: 9999px; }
      .badge-success { background: var(--success-light); color: var(--success); }
      .badge-danger { background: var(--danger-light); color: var(--danger); }
      .badge-warning { background: var(--warning-light); color: var(--warning); }
      .badge-muted { background: var(--border-light); color: var(--muted); }

      /* Stats Row */
      .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
      .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; }
      .stat-value { font-size: 24px; font-weight: 700; color: var(--text); }
      .stat-label { font-size: 12px; color: var(--muted); margin-top: 0.25rem; }

      /* Visualization Bar */
      .viz-bar { height: 40px; background: var(--border-light); border-radius: var(--radius); overflow: hidden; display: flex; position: relative; border: 1px solid var(--border); }
      .viz-segment { height: 100%; transition: all 0.2s ease; cursor: pointer; position: absolute; top: 0; }
      .viz-segment:hover { opacity: 0.85; }
      .viz-legend { display: flex; gap: 1.5rem; margin-top: 0.75rem; }
      .viz-legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 13px; color: var(--text-secondary); }
      .viz-legend-dot { width: 12px; height: 12px; border-radius: 3px; }

      /* Slide-out Panel */
      .detail-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 150; }
      .detail-panel { position: fixed; top: 0; right: 0; width: 100%; max-width: 900px; height: 100vh; background: var(--card); box-shadow: -4px 0 20px rgba(0,0,0,0.15); z-index: 200; display: flex; flex-direction: column; }
      .detail-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
      .detail-close { padding: 0.5rem; border: none; background: none; cursor: pointer; color: var(--muted); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; }
      .detail-close:hover { background: var(--border-light); color: var(--text); }
      .detail-title { font-size: 18px; font-weight: 600; margin: 0; }
      .detail-subtitle { font-size: 13px; color: var(--muted); }
      .detail-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
      .detail-section { margin-bottom: 1.5rem; }
      .detail-section-title { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 0.75rem; }

      /* Legacy support */
      .spinner { width:14px; height:14px; border:2px solid #c7d2fe; border-top-color:#4f46e5; border-radius:50%; display:inline-block; animation: spin .7s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .copy-btn { border:none; background:transparent; color: var(--primary); cursor:pointer; padding:0 4px; }
      .chip { display:inline-flex; align-items:center; gap:.35rem; padding:2px 8px; border-radius:999px; background:#eef2ff; border:1px solid var(--border); cursor:pointer; transition: all 0.15s ease; }
      .chip:hover { background: var(--primary-light); border-color: var(--primary-light); }
      .chip.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
      .row { display: flex; gap: 0.6rem; flex-wrap: wrap; }
      .status-used { color: var(--danger); font-weight: 600; }
      .status-free { color: var(--success); font-weight: 600; }

      /* Utilities */
      .font-mono { font-family: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace; }
      .text-sm { font-size: 13px; }
      .ml-auto { margin-left: auto; }
      .flex { display: flex; }
      .items-center { align-items: center; }
      .gap-2 { gap: 0.5rem; }
      .gap-3 { gap: 0.75rem; }
    </style>
    <!-- Sentry Browser SDK -->
    <script src="https://browser.sentry-cdn.com/8.0.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
      // Initialize Sentry for frontend error tracking
      // Meta tag is injected by backend before this script runs
      (function initSentry() {
        const sentryDSN = document.querySelector('meta[name="sentry-dsn"]')?.content;
        if (!sentryDSN) {
          console.log('Sentry DSN not configured');
          return;
        }
        if (!window.Sentry) {
          console.error('Sentry SDK failed to load');
          return;
        }
        try {
          window.Sentry.init({
            dsn: sentryDSN,
            integrations: [
              window.Sentry.browserTracingIntegration(),
              window.Sentry.replayIntegration({
                maskAllText: false,
                blockAllMedia: false,
              }),
            ],
            // Performance Monitoring
            tracesSampleRate: 1.0, // Capture 100% of transactions
            // Session Replay
            replaysSessionSampleRate: 0.1, // 10% of sessions
            replaysOnErrorSampleRate: 1.0, // 100% of sessions with errors
          });
          console.log('Sentry frontend initialized with DSN:', sentryDSN.substring(0, 30) + '...');
        } catch (err) {
          console.error('Failed to initialize Sentry:', err);
        }
      })();
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>
  <body>
    <div x-data="toaster()" x-init="init()" style="position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:10000;">
      <template x-for="t in toasts" :key="t.id">
        <div :style="'background:#fff;border:1px solid '+(t.type==='error'?'#fecaca':'#bfdbfe')+';padding:10px 12px;border-radius:8px;box-shadow:var(--shadow);min-width:240px;'">
          <strong x-text="t.type==='error'?'Error':'Info'"></strong>
          <div x-text="t.message"></div>
        </div>
      </template>
    </div>
    <div x-data="tabState()" x-init="init()" @keydown.window="onKey($event)">
    <header class="header">
      <div class="header-inner">
        <a href="#" class="logo" @click.prevent="tab='pools'">
          <div class="logo-icon">IP</div>
          <span>CloudPAM</span>
        </a>
        <nav class="nav">
          <button :class="'nav-item' + (tab==='pools' ? ' active' : '')" @click="tab='pools'">Pools</button>
          <button :class="'nav-item' + (tab==='accounts' ? ' active' : '')" @click="tab='accounts'">Accounts</button>
          <button :class="'nav-item' + (tab==='analytics' ? ' active' : '')" @click="tab='analytics'">Analytics</button>
        </nav>
        <div class="header-actions">
          <button class="btn btn-secondary btn-sm" @click="$dispatch('open-data-io')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Data
          </button>
        </div>
      </div>
    </header>
    <script>
      // Sentry test function for frontend
      window.testSentryFrontend = function() {
        if (!window.Sentry) {
          alert('Sentry is not loaded');
          return;
        }
        const choice = prompt('Test Sentry: 1=message, 2=error, 3=exception');
        if (choice === '1') {
          window.Sentry.captureMessage('Frontend test message from CloudPAM');
          alert('Message sent to Sentry (check console and Sentry dashboard)');
        } else if (choice === '2') {
          window.Sentry.captureException(new Error('Frontend test error'));
          alert('Error sent to Sentry (check console and Sentry dashboard)');
        } else if (choice === '3') {
          throw new Error('Frontend test exception - should be captured by Sentry');
        }
      };
    </script>

    <main>
    <template x-if="tab==='pools'">
    <section x-data="pools()" x-init="init()">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">IP Pools</h1>
          <p class="page-subtitle">Manage your IP address pools and allocations</p>
        </div>
        <div class="flex gap-2">
          <button class="btn" @click="showCreateForm = !showCreateForm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Pool
          </button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" x-text="topLevel.length"></div>
          <div class="stat-label">Total Pools</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="list.filter(p => p.parent_id).length"></div>
          <div class="stat-label">Sub-Allocations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.length"></div>
          <div class="stat-label">Accounts</div>
        </div>
      </div>

      <!-- Create Form (collapsible) -->
      <div x-show="showCreateForm" x-cloak class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
          <h3 class="card-title">Create New Pool</h3>
          <button class="btn ghost btn-sm" @click="showCreateForm = false">Ã—</button>
        </div>
        <div class="card-body">
          <div class="row" style="align-items: flex-start;">
            <div class="form-group" style="flex: 1; min-width: 150px;">
              <label class="form-label">Name</label>
              <input type="text" placeholder="e.g., Production VPC" x-model="form.name" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">CIDR Block</label>
              <input type="text" placeholder="e.g., 10.0.0.0/16" x-model="form.cidr" @blur="validateCIDR()" :style="cidrError ? 'border-color: var(--danger)' : ''" />
              <span class="form-hint" style="color: var(--danger);" x-show="cidrError" x-text="cidrError"></span>
            </div>
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">Account (optional)</label>
              <select x-model.number="form.account_id">
                <option :value="null">No Account</option>
                <template x-for="a in accounts" :key="a.id">
                  <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
                </template>
              </select>
            </div>
            <div class="form-group" style="justify-content: flex-end; padding-top: 1.5rem;">
              <button class="btn" @click="createTop()" :disabled="creating || !!cidrError">
                <span x-show="creating" class="spinner"></span>
                <span x-text="creating ? 'Creatingâ€¦' : 'Create Pool'"></span>
              </button>
            </div>
          </div>
          <span x-text="msg" class="muted text-sm"></span>
        </div>
      </div>

      <!-- Pools Table Card -->
      <div class="card">
        <!-- Toolbar -->
        <div class="toolbar">
          <input type="text" class="toolbar-search" placeholder="Search pools..." x-model="search" x-ref="poolSearch" />
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <span class="toolbar-label">Show:</span>
            <select x-model="pageSize" @change="page=1; load()" style="width: 80px;">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">All</option>
            </select>
          </div>
          <div class="toolbar-group ml-auto" x-data="{ bulkMenuOpen:false }" @click.outside="bulkMenuOpen=false">
            <span class="text-sm muted" x-show="selectedTop.length" x-text="selectedTop.length + ' selected'"></span>
            <div style="position: relative;">
              <button class="btn ghost btn-sm" @click="bulkMenuOpen=!bulkMenuOpen" :disabled="!selectedTop.length" title="Bulk actions">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
              </button>
              <div x-show="bulkMenuOpen" x-cloak style="position:absolute; right:0; top: 100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow-lg); z-index:9999; min-width:180px; margin-top: 4px;">
                <button class="btn ghost" style="display:block; width:100%; text-align:left; border-radius: 8px 8px 0 0;" @click="bulkMenuOpen=false; openBulkAssignTop()">Assign Accountâ€¦</button>
                <button class="btn ghost" style="display:block; width:100%; text-align:left; color:var(--danger); border-radius: 0 0 8px 8px;" @click="bulkMenuOpen=false; openBulkDeleteTop()">Deleteâ€¦</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
        <table style="min-width: 800px;">
          <thead>
            <tr>
              <th class="sticky" style="width:40px;"><input type="checkbox" @change="toggleSelectAllTop($event)" :checked="allTopSelected()" :indeterminate="indeterminateTop()" /></th>
              <th class="sticky"><a href="#" @click.prevent="sortTop('name')" style="text-decoration: none; color: inherit;">Name <span x-text="sortTopKey==='name'? (sortTopDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortTop('cidr')" style="text-decoration: none; color: inherit;">CIDR <span x-text="sortTopKey==='cidr'? (sortTopDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortTop('account')" style="text-decoration: none; color: inherit;">Account <span x-text="sortTopKey==='account'? (sortTopDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortTop('created')" style="text-decoration: none; color: inherit;">Created <span x-text="sortTopKey==='created'? (sortTopDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky" style="width: 100px;"></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="p in sortedTop()" :key="p.id">
              <tr>
                <td><input type="checkbox" :value="p.id" @change="toggleSelectTop(p.id)" :checked="selectedTop.includes(p.id)" /></td>
                <td><strong x-text="p.name"></strong></td>
                <td><code class="font-mono" x-text="p.cidr"></code></td>
                <td>
                  <span x-show="p.account_id" class="chip active" x-text="accountName(p.account_id)"></span>
                  <span x-show="!p.account_id" class="muted">â€”</span>
                </td>
                <td class="text-sm muted" x-text="new Date(p.created_at).toLocaleDateString()"></td>
                  <button class="btn ghost btn-sm" @click="selectPool(p)">View â†’</button>
                </td>
              </tr>
            </template>
            <tr x-show="topLevel.length === 0">
              <td colspan="6" style="text-align: center; padding: 3rem;">
                <div style="color: var(--muted);">
                  <div style="font-size: 48px; margin-bottom: 1rem;">ðŸ“¦</div>
                  <div style="font-size: 16px; font-weight: 500; margin-bottom: 0.5rem;">No pools yet</div>
                  <div class="text-sm">Create your first IP pool to get started</div>
                  <button class="btn" style="margin-top: 1rem;" @click="showCreateForm = true">Create Pool</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="pagination-info">
            <span x-show="topLevel.length > 0">Showing <strong x-text="sortedTop().length"></strong> of <strong x-text="topLevel.length"></strong> pools</span>
            <span x-show="topLevel.length === 0">No pools</span>
          </span>
        </div>
      </div><!-- end card -->

      <!-- Bulk Assign Top Pools -->
      <div x-show="bulkAssignTopOpen" x-cloak @click.self="bulkAssignTopOpen=false" @keydown.escape.window="bulkAssignTopOpen && (bulkAssignTopOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:420px; transform: translate(' + dx + 'px,' + dy + 'px)'"><h3 style="cursor:move" @mousedown.prevent="start($event)">Assign Account to Selected</h3>
          <div class="row" style="align-items:center;">
            <select x-model.number="bulkAccountId" style="min-width: 14rem;">
              <option :value="null">No Account</option>
              <template x-for="a in accounts" :key="a.id">
                <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
              </template>
            </select>
            <span class="muted" x-text="selectedTop.length + ' item(s)'" />
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:1rem;">
            <button class="btn ghost" @click="bulkAssignTopOpen=false">Cancel</button>
            <button class="btn" @click="performBulkAssignTop()">Apply</button>
          </div>
        </div>
      </div>

      <!-- Bulk Delete Top Pools -->
      <div x-show="bulkDeleteTopOpen" x-cloak @click.self="bulkDeleteTopOpen=false" @keydown.escape.window="bulkDeleteTopOpen && (bulkDeleteTopOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" style="width:460px;">
          <h3>Delete Selected Pools</h3>
          <p class="muted">This action can delete multiple pools. You may enable cascade to delete their descendants.</p>
          <label style="display:flex; gap:.4rem; align-items:center;"><input type="checkbox" x-model="bulkCascade" /> Cascade delete descendants</label>
          <label style="display:flex; gap:.4rem; align-items:center; margin-top:.5rem;"><input type="checkbox" x-model="confirmBulkDelete" /> I understand this cannot be undone</label>
          <div class="row" style="justify-content:flex-end; margin-top:1rem;">
            <button class="btn ghost" @click="bulkDeleteTopOpen=false">Cancel</button>
            <button class="btn" :disabled="!confirmBulkDelete" @click="performBulkDeleteTop()">Delete</button>
          </div>
        </div>
      </div>

      <!-- Pool Detail Slide-out Panel -->
      <template x-if="current">
        <div>
          <!-- Overlay -->
          <div class="detail-overlay" @click="current = null"></div>
          <!-- Panel -->
          <aside class="detail-panel">
            <div class="detail-header">
              <button class="detail-close" @click="current = null" title="Close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
              <div style="flex: 1;">
                <h2 class="detail-title" x-text="current.name"></h2>
                <span class="detail-subtitle">
                  <code class="font-mono" x-text="current.cidr"></code>
                  <span x-show="current.account_id"> Â· <span x-text="accountName(current.account_id)"></span></span>
                </span>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-sm" @click="loadBlocks()" :disabled="loadingBlocks">
                  <span x-show="loadingBlocks" class="spinner"></span>
                  <span x-text="loadingBlocks ? 'Loadingâ€¦' : 'Refresh'"></span>
                </button>
              </div>
            </div>

            <div class="detail-body">
              <!-- Pool Settings -->
              <div class="detail-section">
                <div class="detail-section-title">Pool Settings</div>
                <div class="row" style="align-items: flex-end; gap: 1rem;">
                  <div class="form-group" style="min-width: 180px;">
                    <label class="form-label">Account</label>
                    <select x-model.number="currentAccountId" style="width: 100%;">
                      <option :value="null">No Account</option>
                      <template x-for="a in accounts" :key="a.id">
                        <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
                      </template>
                    </select>
                  </div>
                  <button class="btn btn-secondary btn-sm" @click="updateCurrentPoolAccount()">Update</button>
                  <span class="muted text-sm" x-text="updateMsg"></span>
                </div>
              </div>

              <!-- IP Space Visualization -->
              <div class="detail-section">
                <div class="detail-section-title">IP Space Utilization</div>
                <div class="viz-bar">
                  <template x-for="seg in vizSegments" :key="seg.id">
                    <div class="viz-segment" :title="seg.title" :style="`left:${seg.left}%; width:${seg.width}%; background:${seg.color};`"></div>
                  </template>
                </div>
                <div class="viz-legend">
                  <template x-for="chip in vizLegend()" :key="chip.key">
                    <div class="viz-legend-item" @click="toggleVizChip(chip.key)" style="cursor: pointer;">
                      <div class="viz-legend-dot" :style="`background:${chip.color};`"></div>
                      <span x-text="chip.label"></span>
                    </div>
                  </template>
                  <div class="viz-legend-item" x-show="vizSegments.length === 0">
                    <span class="muted">No allocations yet</span>
                  </div>
                </div>
              </div>

              <!-- Blocks Filters -->
              <div class="detail-section">
                <div class="toolbar" style="padding: 0.75rem 0; border: none; border-bottom: 1px solid var(--border); margin: 0 -1.5rem; padding-left: 1.5rem; padding-right: 1.5rem;">
                  <div class="toolbar-group">
                    <span class="toolbar-label">Prefix:</span>
                    <select x-model.number="blockPrefix" @change="onBlockPrefixChange(); loadBlocks();" style="width: 80px;">
                      <template x-for="p in Array.from({length: 32 - (currentPrefixBits || 8)}, (_, i) => (currentPrefixBits || 8) + i + 1)" :key="p">
                        <option :value="p" x-text="'/' + p"></option>
                      </template>
                    </select>
                  </div>
                  <div class="toolbar-divider"></div>
                  <div class="toolbar-group">
                    <span class="toolbar-label">Per page:</span>
                    <select x-model="pageSize" @change="onPageSize()" style="width: 80px;">
                      <option value="10">10</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                      <option value="all">All</option>
                    </select>
                  </div>
                  <div class="toolbar-divider"></div>
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="showOnlyUsed" @change="filterBlocks()" /> Used only
                  </label>
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="hideUnavailable" @change="filterBlocks()" /> Hide N/A
                  </label>
                  <span x-text="subMsg" class="muted text-sm ml-auto"></span>
                </div>
              </div>

              <!-- Blocks Table -->
              <div class="detail-section">
                <div class="table-wrapper" style="border: 1px solid var(--border); border-radius: var(--radius); max-height: calc(100vh - 420px); overflow: auto;">
                  <table>
                    <thead>
                      <tr>
                        <th class="sticky"><a href="#" @click.prevent="sortBlocks('cidr')" style="text-decoration: none; color: inherit;">CIDR <span x-text="sortBlockKey==='cidr'? (sortBlockDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
                        <th class="sticky">Status</th>
                        <th class="sticky">Name</th>
                        <th class="sticky">Account</th>
                        <th class="sticky">Network</th>
                        <th class="sticky">Broadcast</th>
                        <th class="sticky"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="b in blocks" :key="b.cidr">
                        <tr>
                          <td>
                            <code class="font-mono" x-text="b.cidr"></code>
                            <button class="copy-btn" @click="copy(b.cidr)" title="Copy CIDR">âŽ˜</button>
                          </td>
                          <td>
                            <span x-show="b.used" class="badge badge-danger">Used</span>
                            <span x-show="!b.used && blockUnavailable(b.cidr)" class="badge badge-muted" :title="blockUnavailableReason(b.cidr)">N/A</span>
                            <span x-show="!b.used && !blockUnavailable(b.cidr)" class="badge badge-success">Free</span>
                          </td>
                          <td>
                            <template x-if="b.assigned_id">
                              <a href="#" @click.prevent="selectPoolById(b.assigned_id)" x-text="b.assigned_name"></a>
                            </template>
                            <template x-if="!b.assigned_id">
                              <span class="muted">â€”</span>
                            </template>
                          </td>
                          <td>
                            <span x-show="b.assigned_account_name || b.assigned_account_id" x-text="b.assigned_account_name || accountName(b.assigned_account_id)"></span>
                            <span x-show="!b.assigned_account_name && !b.assigned_account_id" class="muted">â€”</span>
                          </td>
                          <td class="font-mono text-sm muted">
                            <span x-text="b.network_ip || 'â€”'"></span>
                            <button class="copy-btn" x-show="b.network_ip" @click="copy(b.network_ip)" title="Copy">âŽ˜</button>
                          </td>
                          <td class="font-mono text-sm muted">
                            <span x-text="b.broadcast_ip || 'â€”'"></span>
                            <button class="copy-btn" x-show="b.broadcast_ip" @click="copy(b.broadcast_ip)" title="Copy">âŽ˜</button>
                          </td>
                          <td>
                            <button class="btn btn-sm" x-show="!b.used && !blockUnavailable(b.cidr)" :disabled="creatingSub" @click="createSub(b)">
                              <span x-show="creatingSub" class="spinner"></span> Allocate
                            </button>
                            <span x-show="b.used" class="muted text-sm">â€”</span>
                          </td>
                        </tr>
                      </template>
                      <tr x-show="blocks.length === 0">
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                          <div class="muted">
                            <div>No blocks loaded</div>
                            <button class="btn btn-sm" style="margin-top: 0.5rem;" @click="loadBlocks()">Load Blocks</button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" style="background: transparent; border: none; padding: 0.75rem 0; justify-content: space-between;">
                  <span class="pagination-info" x-show="total > 0">
                    Showing <strong x-text="fromItem"></strong>â€“<strong x-text="toItem"></strong> of <strong x-text="total"></strong> blocks
                  </span>
                  <div class="pagination-controls" x-show="totalPages > 1 && pageSize !== 'all'">
                    <button class="btn ghost btn-sm" @click="firstPage()" :disabled="page <= 1">Â«</button>
                    <button class="btn ghost btn-sm" @click="prevPage()" :disabled="page <= 1">â€¹</button>
                    <span class="text-sm" style="padding: 0 0.5rem;">Page <strong x-text="page"></strong> of <strong x-text="totalPages"></strong></span>
                    <button class="btn ghost btn-sm" @click="nextPage()" :disabled="page >= totalPages">â€º</button>
                    <button class="btn ghost btn-sm" @click="lastPage()" :disabled="page >= totalPages">Â»</button>
                  </div>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </template>

      <!-- Edit Pool Modal -->
      <div x-show="editPoolOpen" x-cloak @click.self="editPoolOpen=false" @keydown.escape.window="editPoolOpen && (editPoolOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" style="width:480px;">
          <h3>Edit Pool</h3>
          <div class="row">
            <input type="text" placeholder="Name" x-model="editPoolForm.name" style="flex:1;" />
            <select x-model.number="editPoolForm.account_id" style="flex:1;">
              <option :value="null">No Account</option>
              <template x-for="a in accounts" :key="a.id">
                <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
              </template>
            </select>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:1rem;">
            <button class="btn ghost" @click="editPoolOpen=false">Cancel</button>
            <button class="btn" @click="saveEditPool()">Save</button>
          </div>
        </div>
      </div>

      <!-- Delete Pool Confirm Modal -->
      <div x-show="deletePoolOpen" x-cloak @click.self="deletePoolOpen=false" @keydown.escape.window="deletePoolOpen && (deletePoolOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" style="width:420px;">
          <h3>Confirm Delete</h3>
          <p>Are you sure you want to delete <strong x-text="deletePoolTarget?.name"></strong>?</p>
          <template x-if="deletePoolChildren.length">
            <div>
              <p class="muted">This pool has the following child pools that will also be deleted:</p>
              <ul>
                <template x-for="c in deletePoolChildren" :key="c.id">
                  <li x-text="c.name + ' ('+c.cidr+')'"></li>
                </template>
              </ul>
              <label><input type="checkbox" x-model="deletePoolCascade" /> Delete all children</label>
            </div>
          </template>
          <div class="row" style="justify-content:space-between; align-items:center; margin-top:1rem;">
            <label style="display:flex; align-items:center; gap:.4rem;"><input type="checkbox" x-model="confirmPoolDelete" /> I understand this action cannot be undone</label>
            <button class="btn ghost" @click="deletePoolOpen=false">Cancel</button>
            <button class="btn" :disabled="(!confirmPoolDelete) || (deletePoolChildren.length && !deletePoolCascade)" @click="performDeletePool()">Delete</button>
          </div>
        </div>
      </div>
    </section>
    </template>
    
    <template x-if="tab==='accounts'">
    <section x-data="accountsView()" x-init="fetchAccounts()">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">Accounts</h1>
          <p class="page-subtitle">Manage cloud accounts and projects</p>
        </div>
        <div class="flex gap-2">
          <button class="btn" @click="showCreateForm = !showCreateForm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Account
          </button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.length"></div>
          <div class="stat-label">Total Accounts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.filter(a => a.provider === 'aws' || a.key?.startsWith('aws:')).length"></div>
          <div class="stat-label">AWS Accounts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.filter(a => a.provider === 'gcp' || a.key?.startsWith('gcp:')).length"></div>
          <div class="stat-label">GCP Projects</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.filter(a => a.tier === 'prd').length"></div>
          <div class="stat-label">Production</div>
        </div>
      </div>

      <!-- Create Form (collapsible) -->
      <div x-show="showCreateForm" x-cloak class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
          <h3 class="card-title">Create New Account</h3>
          <button class="btn ghost btn-sm" @click="showCreateForm = false">Ã—</button>
        </div>
        <div class="card-body">
          <div class="row" style="align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">Key *</label>
              <input type="text" placeholder="e.g., aws:123456789012" x-model="acctForm.key" />
              <span class="form-hint">Unique identifier (aws:id or gcp:project)</span>
            </div>
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">Name *</label>
              <input type="text" placeholder="e.g., Production AWS" x-model="acctForm.name" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label class="form-label">Provider</label>
              <select x-model="acctForm.provider">
                <option value="">Select...</option>
                <option value="aws">AWS</option>
                <option value="gcp">GCP</option>
                <option value="azure">Azure</option>
              </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label class="form-label">Tier</label>
              <select x-model="acctForm.tier">
                <option value="">Select...</option>
                <option value="prd">Production</option>
                <option value="stg">Staging</option>
                <option value="dev">Development</option>
                <option value="sbx">Sandbox</option>
              </select>
            </div>
          </div>
          <div class="row" style="align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">External ID</label>
              <input type="text" placeholder="e.g., 123456789012" x-model="acctForm.external_id" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 180px;">
              <label class="form-label">Platform</label>
              <input type="text" placeholder="e.g., kubernetes, serverless" x-model="acctForm.platform" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label class="form-label">Environment</label>
              <input type="text" placeholder="e.g., production" x-model="acctForm.environment" />
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label class="form-label">Regions</label>
              <input type="text" placeholder="e.g., us-east-1, us-west-2" x-model="acctForm.regions_text" />
              <span class="form-hint">Comma-separated list</span>
            </div>
          </div>
          <div class="row" style="align-items: flex-start; gap: 1rem;">
            <div class="form-group" style="flex: 2; min-width: 300px;">
              <label class="form-label">Description</label>
              <input type="text" placeholder="Optional description" x-model="acctForm.description" style="width: 100%;" />
            </div>
            <div class="form-group" style="justify-content: flex-end; padding-top: 1.5rem;">
              <button class="btn" @click="createAccount()" :disabled="creating">
                <span x-show="creating" class="spinner"></span>
                <span x-text="creating ? 'Creatingâ€¦' : 'Create Account'"></span>
              </button>
            </div>
          </div>
          <span x-text="acctMsg" class="muted text-sm"></span>
        </div>
      </div>

      <!-- Accounts Table Card -->
      <div class="card">
        <!-- Toolbar -->
        <div class="toolbar">
          <input type="text" class="toolbar-search" placeholder="Search accounts..." x-model="search" />
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <span class="toolbar-label">Provider:</span>
            <select x-model="filterProvider" style="width: 100px;">
              <option value="">All</option>
              <option value="aws">AWS</option>
              <option value="gcp">GCP</option>
              <option value="azure">Azure</option>
            </select>
          </div>
          <div class="toolbar-group">
            <span class="toolbar-label">Tier:</span>
            <select x-model="filterTier" style="width: 100px;">
              <option value="">All</option>
              <option value="prd">Production</option>
              <option value="stg">Staging</option>
              <option value="dev">Development</option>
              <option value="sbx">Sandbox</option>
            </select>
          </div>
          <div class="toolbar-group ml-auto" x-data="{ colsOpen: false }" @click.outside="colsOpen=false">
            <div style="position: relative;">
              <button class="btn ghost btn-sm" @click="colsOpen=!colsOpen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Columns
              </button>
              <div x-show="colsOpen" x-cloak style="position:absolute; right:0; top: 100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow-lg); z-index:10020; padding:12px; min-width:200px; margin-top: 4px;">
                <div class="text-sm" style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Toggle columns</div>
                <template x-for="col in Object.keys(visibleCols)" :key="col">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 0;">
                    <input type="checkbox" :checked="visibleCols[col]" @change="visibleCols[col]=!visibleCols[col]" />
                    <span x-text="colLabels[col] || col" style="font-size: 13px;"></span>
                  </label>
                </template>
              </div>
            </div>
          </div>
          <div class="toolbar-group" x-data="{ bulkMenuOpen:false }" @click.outside="bulkMenuOpen=false">
            <span class="text-sm muted" x-show="selectedAccounts.length" x-text="selectedAccounts.length + ' selected'"></span>
            <div style="position: relative;">
              <button class="btn ghost btn-sm" @click="bulkMenuOpen=!bulkMenuOpen" :disabled="!selectedAccounts.length" title="Bulk actions">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
              </button>
              <div x-show="bulkMenuOpen" x-cloak style="position:absolute; right:0; top: 100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow-lg); z-index:9999; min-width:160px; margin-top: 4px;">
                <button class="btn ghost" style="display:block; width:100%; text-align:left; color:var(--danger); border-radius: 8px;" @click="bulkMenuOpen=false; openBulkDelete()">Delete Selectedâ€¦</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
        <table style="min-width: 900px;">
          <thead>
            <tr>
              <th class="sticky" style="width:40px;"><input type="checkbox" @change="toggleSelectAll($event)" :checked="allSelected()" :indeterminate="indeterminate()" /></th>
              <th class="sticky"><a href="#" @click.prevent="sortBy('name')" style="text-decoration: none; color: inherit;">Name <span x-text="sortKey==='name'? (sortDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortBy('key')" style="text-decoration: none; color: inherit;">Key <span x-text="sortKey==='key'? (sortDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky" x-show="visibleCols.provider">Provider</th>
              <th class="sticky" x-show="visibleCols.tier">Tier</th>
              <th class="sticky" x-show="visibleCols.platform">Platform</th>
              <th class="sticky" x-show="visibleCols.environment">Environment</th>
              <th class="sticky" x-show="visibleCols.regions">Regions</th>
              <th class="sticky" x-show="visibleCols.external_id">External ID</th>
              <th class="sticky" x-show="visibleCols.description">Description</th>
              <th class="sticky" x-show="visibleCols.created"><a href="#" @click.prevent="sortBy('created')" style="text-decoration: none; color: inherit;">Created <span x-text="sortKey==='created'? (sortDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky" style="width: 80px;"></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="a in filteredAccounts()" :key="a.id">
              <tr x-data="{ menuOpen:false }" @click.outside="menuOpen=false">
                <td><input type="checkbox" :value="a.id" @change="toggleSelect(a.id)" :checked="selectedAccounts.includes(a.id)" /></td>
                <td><strong x-text="a.name"></strong></td>
                <td><code class="font-mono text-sm" x-text="a.key"></code></td>
                <td x-show="visibleCols.provider">
                  <span x-show="a.provider" :class="'badge ' + (a.provider==='aws' ? 'badge-warning' : a.provider==='gcp' ? 'badge-success' : 'badge-muted')" x-text="(a.provider || '').toUpperCase()"></span>
                  <span x-show="!a.provider" class="muted">â€”</span>
                </td>
                <td x-show="visibleCols.tier">
                  <span x-show="a.tier" :class="'badge ' + (a.tier==='prd' ? 'badge-danger' : a.tier==='stg' ? 'badge-warning' : 'badge-muted')" x-text="a.tier"></span>
                  <span x-show="!a.tier" class="muted">â€”</span>
                </td>
                <td x-show="visibleCols.platform" x-text="a.platform || 'â€”'" :class="!a.platform ? 'muted' : ''"></td>
                <td x-show="visibleCols.environment" x-text="a.environment || 'â€”'" :class="!a.environment ? 'muted' : ''"></td>
                <td x-show="visibleCols.regions">
                  <span x-show="Array.isArray(a.regions) && a.regions.length" class="text-sm" x-text="a.regions.slice(0,2).join(', ') + (a.regions.length > 2 ? ' +' + (a.regions.length - 2) : '')"></span>
                  <span x-show="!a.regions || !a.regions.length" class="muted">â€”</span>
                </td>
                <td x-show="visibleCols.external_id"><code class="font-mono text-sm" x-text="a.external_id || 'â€”'" :class="!a.external_id ? 'muted' : ''"></code></td>
                <td x-show="visibleCols.description" class="text-sm" x-text="a.description || 'â€”'" :class="!a.description ? 'muted' : ''" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></td>
                <td x-show="visibleCols.created" class="text-sm muted" x-text="new Date(a.created_at).toLocaleDateString()"></td>
                <td style="position:relative; text-align:right;">
                  <button class="btn ghost btn-sm" @click="menuOpen=!menuOpen">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                  </button>
                  <div x-show="menuOpen" x-cloak style="position:absolute; right:0; top: 100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow: var(--shadow-lg); z-index:9999; min-width:120px;">
                    <button class="btn ghost" style="display:block; width:100%; text-align:left; border-radius: 8px 8px 0 0;" @click="menuOpen=false; openEditAccount(a)">Edit</button>
                    <button class="btn ghost" style="display:block; width:100%; text-align:left; color: var(--danger); border-radius: 0 0 8px 8px;" @click="menuOpen=false; confirmDeleteAccount(a)">Delete</button>
                  </div>
                </td>
              </tr>
            </template>
            <tr x-show="filteredAccounts().length === 0">
              <td :colspan="accountsColumnsCount()" style="text-align: center; padding: 3rem;">
                <div style="color: var(--muted);">
                  <div style="font-size: 48px; margin-bottom: 1rem;">ðŸ¢</div>
                  <div style="font-size: 16px; font-weight: 500; margin-bottom: 0.5rem;" x-text="accounts.length === 0 ? 'No accounts yet' : 'No accounts match filters'"></div>
                  <div class="text-sm" x-text="accounts.length === 0 ? 'Create your first account to get started' : 'Try adjusting your search or filters'"></div>
                  <button x-show="accounts.length === 0" class="btn" style="margin-top: 1rem;" @click="showCreateForm = true">Create Account</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="pagination-info">
            <span x-show="filteredAccounts().length > 0">Showing <strong x-text="filteredAccounts().length"></strong> of <strong x-text="accounts.length"></strong> accounts</span>
            <span x-show="filteredAccounts().length === 0 && accounts.length > 0">No matches</span>
          </span>
        </div>
      </div><!-- end card -->
      <script>
        function accountsView() {
          return {
            accounts: [],
            acctForm: { key:'', name:'', provider:'', external_id:'', description:'', platform:'', tier:'', environment:'', regions_text:'' },
            acctMsg: '',
            creating: false,
            showCreateForm: false,
            search: '',
            filterProvider: '',
            filterTier: '',
            sortKey: 'name',
            sortDir: 'asc',
            selectedAccounts: [],
            bulkDeleteOpen: false,
            bulkCascade: false,
            confirmBulkDelete: false,
            editOpen: false,
            editForm: { id:null, name:'', provider:'', external_id:'', description:'', platform:'', tier:'', environment:'', regions_text:'', regions:[] },
            visibleCols: { provider:true, tier:true, platform:true, environment:true, regions:true, external_id:false, description:false, created:true },
            colLabels: { provider:'Provider', tier:'Tier', platform:'Platform', environment:'Environment', regions:'Regions', external_id:'External ID', description:'Description', created:'Created' },
            accountsColumnsCount(){
              // Always-visible: checkbox, Name, Key, Actions = 4
              let count = 4;
              for (const k in this.visibleCols) { if (this.visibleCols[k]) count++; }
              return count;
            },
            deleteOpen: false,
            deleteTarget: null,
            deleteChildren: [],
            deleteCascade: false,
            confirmAccountDelete: false,
            // Sorting
            sortBy(key) {
              if (this.sortKey === key) { this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc'; }
              else { this.sortKey = key; this.sortDir = 'asc'; }
            },
            // Filtering and sorting
            filteredAccounts() {
              let arr = this.accounts.slice();
              // Search filter
              if (this.search) {
                const q = this.search.toLowerCase();
                arr = arr.filter(a =>
                  (a.name||'').toLowerCase().includes(q) ||
                  (a.key||'').toLowerCase().includes(q) ||
                  (a.provider||'').toLowerCase().includes(q) ||
                  (a.description||'').toLowerCase().includes(q) ||
                  (a.platform||'').toLowerCase().includes(q)
                );
              }
              // Provider filter
              if (this.filterProvider) {
                arr = arr.filter(a => (a.provider||'').toLowerCase() === this.filterProvider || (a.key||'').startsWith(this.filterProvider + ':'));
              }
              // Tier filter
              if (this.filterTier) {
                arr = arr.filter(a => (a.tier||'').toLowerCase() === this.filterTier);
              }
              // Sorting
              const dir = this.sortDir === 'asc' ? 1 : -1;
              arr.sort((x, y) => {
                let va, vb;
                if (this.sortKey === 'created') { va = new Date(x.created_at); vb = new Date(y.created_at); }
                else { va = (x[this.sortKey]||'').toLowerCase(); vb = (y[this.sortKey]||'').toLowerCase(); }
                if (va < vb) return -dir;
                if (va > vb) return dir;
                return 0;
              });
              return arr;
            },
            // Selection
            toggleSelect(id) {
              const idx = this.selectedAccounts.indexOf(id);
              if (idx === -1) this.selectedAccounts.push(id);
              else this.selectedAccounts.splice(idx, 1);
            },
            toggleSelectAll(ev) {
              if (ev.target.checked) {
                this.selectedAccounts = this.filteredAccounts().map(a => a.id);
              } else {
                this.selectedAccounts = [];
              }
            },
            allSelected() {
              const filtered = this.filteredAccounts();
              return filtered.length > 0 && this.selectedAccounts.length === filtered.length;
            },
            indeterminate() {
              const filtered = this.filteredAccounts();
              return this.selectedAccounts.length > 0 && this.selectedAccounts.length < filtered.length;
            },
            // Bulk delete
            openBulkDelete() {
              this.bulkCascade = false;
              this.confirmBulkDelete = false;
              this.bulkDeleteOpen = true;
            },
            async performBulkDelete() {
              const force = this.bulkCascade ? '?force=1' : '';
              let failed = 0;
              for (const id of this.selectedAccounts) {
                try {
                  const res = await fetch(`/api/v1/accounts/${id}${force}`, { method: 'DELETE' });
                  if (!res.ok) failed++;
                } catch (e) { failed++; }
              }
              this.bulkDeleteOpen = false;
              this.selectedAccounts = [];
              await this.fetchAccounts();
              if (failed > 0) showToast(`Deleted with ${failed} error(s)`, 'error');
              else showToast('Accounts deleted');
            },
            async fetchAccounts() {
              try {
                const res = await fetch('/api/v1/accounts');
                this.accounts = await res.json();
              } catch (e) { this.acctMsg = 'Failed to load accounts'; }
            },
            async createAccount() {
              this.acctMsg = '';
              this.creating = true;
              try {
                // Basic validation: tier (if provided) must be one of dev/stg/sbx/prd
                const allowedTiers = ['dev','stg','sbx','prd'];
                if (this.acctForm.tier && !allowedTiers.includes(String(this.acctForm.tier).toLowerCase())) {
                  this.acctMsg = 'Tier must be one of dev, stg, sbx, prd'; showToast(this.acctMsg,'error'); this.creating = false; return;
                }
                // Parse regions from comma-separated input
                const regions = (this.acctForm.regions_text||'').split(',').map(s=>s.trim()).filter(Boolean);
                // Validate simple region token format
                const bad = regions.find(r => !/^[a-z0-9-]+$/.test(r));
                if (bad) { this.acctMsg = `Invalid region token: ${bad}`; showToast(this.acctMsg,'error'); this.creating = false; return; }
                const payload = {
                  key: this.acctForm.key,
                  name: this.acctForm.name,
                  provider: this.acctForm.provider,
                  external_id: this.acctForm.external_id,
                  description: this.acctForm.description,
                  platform: this.acctForm.platform,
                  tier: this.acctForm.tier || '',
                  environment: this.acctForm.environment,
                  regions: regions,
                };
                const res = await fetch('/api/v1/accounts', {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                if (!res.ok) { this.acctMsg = await parseError(res); showToast(this.acctMsg,'error'); this.creating = false; return; }
                this.acctForm = { key:'', name:'', provider:'', external_id:'', description:'', platform:'', tier:'', environment:'', regions_text:'' };
                await this.fetchAccounts();
                this.showCreateForm = false;
                showToast('Account created');
              } catch (e) { this.acctMsg = 'Create failed'; }
              finally { this.creating = false; }
            }
            ,
            openEditAccount(a) {
              this.editForm = { id:a.id, name:a.name, provider:a.provider||'', external_id:a.external_id||'', description:a.description||'', platform:a.platform||'', tier:a.tier||'', environment:a.environment||'', regions:Array.isArray(a.regions)?a.regions.slice():[], regions_text:(Array.isArray(a.regions)&&a.regions.length?a.regions.join(', '):'') };
              this.editOpen = true;
            }
            ,
            async saveAccount() {
              const f = this.editForm;
              try {
                // Validate tier
                const allowedTiers = ['dev','stg','sbx','prd'];
                if (f.tier && !allowedTiers.includes(String(f.tier).toLowerCase())) { this.acctMsg = 'Tier must be one of dev, stg, sbx, prd'; showToast(this.acctMsg,'error'); return; }
                const regions = (f.regions_text||'').split(',').map(s=>s.trim()).filter(Boolean);
                const bad = regions.find(r => !/^[a-z0-9-]+$/.test(r));
                if (bad) { this.acctMsg = `Invalid region token: ${bad}`; showToast(this.acctMsg,'error'); return; }
                const payload = { name:f.name, provider:f.provider, external_id:f.external_id, description:f.description, platform:f.platform, tier:f.tier||'', environment:f.environment, regions: regions };
                const res = await fetch(`/api/v1/accounts/${f.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                if (!res.ok) { this.acctMsg = await parseError(res); showToast(this.acctMsg,'error'); return; }
                this.editOpen = false;
                await this.fetchAccounts();
                this.editOpen = false; // ensure modal closes after refresh
                showToast('Account updated');
              } catch (e) { this.acctMsg = 'Update failed'; }
            }
            ,
            confirmDeleteAccount(a) {
              this.deleteTarget = a; this.deleteCascade = false; this.deleteChildren = []; this.confirmAccountDelete = false;
              // Fetch pools and compute affected pools
              fetch('/api/v1/pools').then(r=>r.json()).then(list => {
                const byParent = new Map();
                for (const p of list) { if (p.parent_id) { const arr = byParent.get(p.parent_id) || []; arr.push(p); byParent.set(p.parent_id, arr); } }
                const roots = list.filter(p => p.account_id === a.id);
                const byId = new Map(list.map(p=>[p.id,p]));
                const out = [];
                const stack = roots.map(r=>r.id);
                while (stack.length) {
                  const id = stack.pop();
                  const p = byId.get(id); if (p) out.push(p);
                  const children = byParent.get(id) || [];
                  for (const c of children) { stack.push(c.id); }
                }
                this.deleteChildren = out;
              });
              this.deleteOpen = true;
            }
            ,
            async deleteAccount(a) {
              if (!a) a = this.deleteTarget;
              if (!a) return;
              try {
                const force = this.deleteCascade ? '?force=1' : '';
                const res = await fetch(`/api/v1/accounts/${a.id}${force}`, { method: 'DELETE' });
                if (!res.ok) { this.acctMsg = await parseError(res); showToast(this.acctMsg,'error'); return; }
                await this.fetchAccounts();
                this.deleteOpen = false;
                this.acctMsg = 'Deleted'; showToast('Account deleted');
              } catch (e) { this.acctMsg = 'Delete failed'; }
            }
          }
        }
      </script>
      <!-- Edit Account Modal -->
      <div x-show="editOpen" x-cloak @click.self="editOpen=false" @keydown.escape.window="editOpen && (editOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:560px; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Edit Account</h3>
            <button class="btn ghost btn-sm" @click="editOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <div class="row" style="gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group" style="flex:1;">
                <label class="form-label">Name</label>
                <input type="text" placeholder="Account name" x-model="editForm.name" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label">Provider</label>
                <select x-model="editForm.provider" style="width: 100%;">
                  <option value="">Select...</option>
                  <option value="aws">AWS</option>
                  <option value="gcp">GCP</option>
                  <option value="azure">Azure</option>
                </select>
              </div>
            </div>
            <div class="row" style="gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group" style="flex:1;">
                <label class="form-label">External ID</label>
                <input type="text" placeholder="e.g., 123456789012" x-model="editForm.external_id" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label">Tier</label>
                <select x-model="editForm.tier" style="width: 100%;">
                  <option value="">Select...</option>
                  <option value="prd">Production</option>
                  <option value="stg">Staging</option>
                  <option value="dev">Development</option>
                  <option value="sbx">Sandbox</option>
                </select>
              </div>
            </div>
            <div class="row" style="gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group" style="flex:1;">
                <label class="form-label">Platform</label>
                <input type="text" placeholder="e.g., kubernetes" x-model="editForm.platform" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label">Environment</label>
                <input type="text" placeholder="e.g., production" x-model="editForm.environment" style="width: 100%;" />
              </div>
            </div>
            <div class="row" style="gap: 1rem; margin-bottom: 1rem;">
              <div class="form-group" style="flex:1;">
                <label class="form-label">Regions</label>
                <input type="text" placeholder="e.g., us-east-1, us-west-2" x-model="editForm.regions_text" style="width: 100%;" />
                <span class="form-hint">Comma-separated list</span>
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Description</label>
              <input type="text" placeholder="Optional description" x-model="editForm.description" style="width: 100%;" />
            </div>
            <div class="row" style="justify-content:flex-end; gap: 0.5rem;">
              <button class="btn btn-secondary" @click="editOpen=false">Cancel</button>
              <button class="btn" @click="saveAccount()">Save Changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Account Confirm Modal -->
      <div x-show="deleteOpen" x-cloak @click.self="deleteOpen=false" @keydown.escape.window="deleteOpen && (deleteOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:480px; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Delete Account</h3>
            <button class="btn ghost btn-sm" @click="deleteOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <p style="margin-bottom: 1rem;">Are you sure you want to delete <strong x-text="deleteTarget?.name"></strong>?</p>
            <template x-if="deleteChildren.length">
              <div style="background: var(--danger-light); border: 1px solid var(--danger); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                <p class="text-sm" style="color: var(--danger); font-weight: 500; margin-bottom: 0.5rem;">Warning: Associated pools will be affected</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.25rem; font-size: 13px;">
                  <template x-for="p in deleteChildren.slice(0,5)" :key="p.id">
                    <li x-text="p.name + ' (' + p.cidr + ')'"></li>
                  </template>
                  <li x-show="deleteChildren.length > 5" class="muted" x-text="'...and ' + (deleteChildren.length - 5) + ' more'"></li>
                </ul>
                <label style="display:flex; align-items:center; gap:.5rem; margin-top: 0.75rem; font-size: 13px;">
                  <input type="checkbox" x-model="deleteCascade" />
                  <span>Delete all associated pools</span>
                </label>
              </div>
            </template>
            <label style="display:flex; align-items:center; gap:.5rem; margin-bottom: 1rem; font-size: 13px;">
              <input type="checkbox" x-model="confirmAccountDelete" />
              <span>I understand this action cannot be undone</span>
            </label>
            <div class="row" style="justify-content:flex-end; gap: 0.5rem;">
              <button class="btn btn-secondary" @click="deleteOpen=false">Cancel</button>
              <button class="btn btn-danger" :disabled="(!confirmAccountDelete) || (deleteChildren.length && !deleteCascade)" @click="deleteAccount()">Delete Account</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Delete Accounts Modal -->
      <div x-show="bulkDeleteOpen" x-cloak @click.self="bulkDeleteOpen=false" @keydown.escape.window="bulkDeleteOpen && (bulkDeleteOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:460px; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Delete Selected Accounts</h3>
            <button class="btn ghost btn-sm" @click="bulkDeleteOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <p style="margin-bottom: 1rem;">You are about to delete <strong x-text="selectedAccounts.length"></strong> account(s).</p>
            <label style="display:flex; align-items:center; gap:.5rem; margin-bottom: 0.75rem; font-size: 13px;">
              <input type="checkbox" x-model="bulkCascade" />
              <span>Cascade delete associated pools</span>
            </label>
            <label style="display:flex; align-items:center; gap:.5rem; margin-bottom: 1rem; font-size: 13px;">
              <input type="checkbox" x-model="confirmBulkDelete" />
              <span>I understand this cannot be undone</span>
            </label>
            <div class="row" style="justify-content:flex-end; gap: 0.5rem;">
              <button class="btn btn-secondary" @click="bulkDeleteOpen=false">Cancel</button>
              <button class="btn btn-danger" :disabled="!confirmBulkDelete" @click="performBulkDelete()">Delete Accounts</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    </template>

    <template x-if="tab==='analytics'">
    <section x-data="allBlocksView()" x-init="init()">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">Analytics</h1>
          <p class="page-subtitle">View and analyze IP address allocations across your infrastructure</p>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-secondary" @click="load()" :disabled="loading">
            <span x-show="loading" class="spinner"></span>
            <svg x-show="!loading" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            <span x-text="loading ? 'Loadingâ€¦' : 'Refresh'"></span>
          </button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" x-text="total || 0"></div>
          <div class="stat-label">Total Blocks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="parentPools.length"></div>
          <div class="stat-label">Parent Pools</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="accounts.length"></div>
          <div class="stat-label">Accounts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="selected.length"></div>
          <div class="stat-label">Selected</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Blocks by Parent Pool</h3>
          </div>
          <div class="card-body" style="padding: 1rem;">
            <div id="chart-parent" x-ref="chartParent" style="min-height: 200px;"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Address Space by Account</h3>
          </div>
          <div class="card-body" style="padding: 1rem;">
            <div id="chart-account" x-ref="chartAccount" style="min-height: 200px;"></div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Allocations Over Time</h3>
        </div>
        <div class="card-body" style="padding: 1rem;">
          <div id="chart-time" x-ref="chartTime" style="min-height: 180px;"></div>
        </div>
      </div>

      <!-- Blocks Table Card -->
      <div class="card">
        <!-- Toolbar -->
        <div class="toolbar">
          <input type="text" class="toolbar-search" placeholder="Search blocks..." x-model="search" x-ref="analyticsSearch" />
          <div class="toolbar-divider"></div>
          <button class="btn btn-secondary btn-sm" @click="filtersOpen=!filtersOpen">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            Filters
            <span x-show="hasActiveFilters()" class="badge badge-success" style="margin-left: 4px; padding: 2px 6px;" x-text="activeFilterCount()"></span>
          </button>
          <button class="btn ghost btn-sm" @click="clearFilters()" x-show="hasActiveFilters()">Clear Filters</button>
          <div class="toolbar-group">
            <span class="toolbar-label">Show:</span>
            <select x-model="pageSize" @change="page=1; load()" style="width: 80px;">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">All</option>
            </select>
          </div>
          <span class="muted text-sm" x-text="msg"></span>
          <div class="toolbar-group ml-auto" x-data="{ analyticsBulkMenuOpen:false }" @click.outside="analyticsBulkMenuOpen=false">
            <span class="text-sm muted" x-show="selected.length" x-text="selected.length + ' selected'"></span>
            <div style="position: relative;">
              <button class="btn ghost btn-sm" @click="analyticsBulkMenuOpen=!analyticsBulkMenuOpen" :disabled="!selected.length" title="Bulk actions">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
              </button>
              <div x-show="analyticsBulkMenuOpen" x-cloak style="position:absolute; right:0; top: 100%; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow-lg); z-index:9999; min-width:160px; margin-top: 4px;">
                <button class="btn ghost" style="display:block; width:100%; text-align:left; border-radius: 8px 8px 0 0;" @click="analyticsBulkMenuOpen=false; openBulkAssign()">Assign Accountâ€¦</button>
                <button class="btn ghost" style="display:block; width:100%; text-align:left; color:var(--danger); border-radius: 0 0 8px 8px;" @click="analyticsBulkMenuOpen=false; openBulkDelete()">Deleteâ€¦</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper" style="max-height: 500px; overflow: auto;">
        <table style="min-width: 1000px;">
          <thead>
            <tr>
              <th class="sticky" style="width:40px;"><input type="checkbox" @change="toggleSelectAll($event)" :checked="allSelected()" :indeterminate="indeterminate()" /></th>
              <th class="sticky"><a href="#" @click.prevent="sortAnal('name')" style="text-decoration: none; color: inherit;">Name <span x-text="sortAnalKey==='name'? (sortAnalDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortAnal('cidr')" style="text-decoration: none; color: inherit;">CIDR <span x-text="sortAnalKey==='cidr'? (sortAnalDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortAnal('parent')" style="text-decoration: none; color: inherit;">Parent Pool <span x-text="sortAnalKey==='parent'? (sortAnalDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky"><a href="#" @click.prevent="sortAnal('account')" style="text-decoration: none; color: inherit;">Account <span x-text="sortAnalKey==='account'? (sortAnalDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
              <th class="sticky">Network IP</th>
              <th class="sticky">Broadcast IP</th>
              <th class="sticky"><a href="#" @click.prevent="sortAnal('created')" style="text-decoration: none; color: inherit;">Created <span x-text="sortAnalKey==='created'? (sortAnalDir==='asc'?'â†‘':'â†“') : ''"></span></a></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="b in filtered()" :key="b.id">
              <tr>
                <td><input type="checkbox" :value="b.id" @change="toggleSelect(b.id)" :checked="selected.includes(b.id)" /></td>
                <td><strong x-text="b.name"></strong></td>
                <td><code class="font-mono" x-text="b.cidr"></code></td>
                <td>
                  <span class="chip" x-text="b.parent_name"></span>
                </td>
                <td>
                  <span x-show="b.account_name" class="chip active" x-text="b.account_name"></span>
                  <span x-show="!b.account_name" class="muted">â€”</span>
                </td>
                <td class="font-mono text-sm" x-text="b.network_ip || 'â€”'" :class="!b.network_ip ? 'muted' : ''"></td>
                <td class="font-mono text-sm" x-text="b.broadcast_ip || 'â€”'" :class="!b.broadcast_ip ? 'muted' : ''"></td>
                <td class="text-sm muted" x-text="new Date(b.created_at).toLocaleDateString()"></td>
              </tr>
            </template>
            <tr x-show="filtered().length === 0">
              <td colspan="8" style="text-align: center; padding: 3rem;">
                <div style="color: var(--muted);">
                  <div style="font-size: 48px; margin-bottom: 1rem;">ðŸ“Š</div>
                  <div style="font-size: 16px; font-weight: 500; margin-bottom: 0.5rem;" x-text="total === 0 ? 'No blocks allocated' : 'No blocks match filters'"></div>
                  <div class="text-sm" x-text="total === 0 ? 'Allocate blocks from your pools to see them here' : 'Try adjusting your search or filters'"></div>
                  <button x-show="hasActiveFilters()" class="btn btn-secondary" style="margin-top: 1rem;" @click="clearFilters()">Clear Filters</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <span class="pagination-info">
            <span x-show="total > 0">Showing <strong x-text="fromItem"></strong>-<strong x-text="toItem"></strong> of <strong x-text="total"></strong> blocks</span>
            <span x-show="total === 0">No blocks</span>
          </span>
          <div class="pagination-controls">
            <button class="btn ghost btn-sm" @click="firstPage()" :disabled="page<=1">Â«</button>
            <button class="btn ghost btn-sm" @click="prevPage()" :disabled="page<=1">â€¹</button>
            <span class="text-sm" style="padding: 0 0.5rem;">Page <strong x-text="page"></strong> of <strong x-text="totalPages"></strong></span>
            <button class="btn ghost btn-sm" @click="nextPage()" :disabled="page>=totalPages">â€º</button>
            <button class="btn ghost btn-sm" @click="lastPage()" :disabled="page>=totalPages">Â»</button>
          </div>
        </div>
      </div><!-- end card -->

      <!-- Filters Modal -->
      <div x-show="filtersOpen" x-cloak @click.self="filtersOpen=false" @keydown.escape.window="filtersOpen && (filtersOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10020;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width: 800px; max-width: 95vw; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Filter Blocks</h3>
            <button class="btn ghost btn-sm" @click="filtersOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
              <!-- Accounts Filter -->
              <div>
                <div class="form-label" style="margin-bottom: 0.5rem;">Accounts</div>
                <div style="max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem;">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 0; border-bottom: 1px solid var(--border-light); margin-bottom: 4px;">
                    <input type="checkbox" @change="toggleAllAccounts($event)" :checked="allAccountsSelected()" :indeterminate="indeterminateAccounts()" />
                    <span class="text-sm" style="font-weight: 500;">Select All</span>
                  </label>
                  <template x-for="a in accounts" :key="a.id">
                    <label style="display:flex; align-items:center; gap:.5rem; padding: 3px 0;">
                      <input type="checkbox" :value="String(a.id)" @change="toggleInArray(selectedAccounts, String(a.id))" :checked="selectedAccounts.includes(String(a.id))" />
                      <span class="text-sm" x-text="a.name"></span>
                    </label>
                  </template>
                </div>
                <div class="form-group" style="margin-top: 0.5rem;">
                  <input type="text" placeholder="Filter by name..." x-model="fltAccountName" style="width: 100%; font-size: 13px;" />
                </div>
              </div>

              <!-- Parent Pools Filter -->
              <div>
                <div class="form-label" style="margin-bottom: 0.5rem;">Parent Pools</div>
                <div style="max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem;">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 0; border-bottom: 1px solid var(--border-light); margin-bottom: 4px;">
                    <input type="checkbox" @change="toggleAllPools($event)" :checked="allPoolsSelected()" :indeterminate="indeterminatePools()" />
                    <span class="text-sm" style="font-weight: 500;">Select All</span>
                  </label>
                  <template x-for="p in parentPools" :key="p.id">
                    <label style="display:flex; align-items:center; gap:.5rem; padding: 3px 0;">
                      <input type="checkbox" :value="String(p.id)" @change="toggleInArray(selectedPools, String(p.id))" :checked="selectedPools.includes(String(p.id))" />
                      <span class="text-sm" x-text="p.name + ' (' + p.cidr + ')'"></span>
                    </label>
                  </template>
                </div>
                <div class="form-group" style="margin-top: 0.5rem;">
                  <input type="text" placeholder="Filter by CIDR..." x-model="fltCIDR" style="width: 100%; font-size: 13px;" />
                </div>
              </div>

              <!-- Platform Filter -->
              <div>
                <div class="form-label" style="margin-bottom: 0.5rem;">Platform</div>
                <div style="max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem;">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 0; border-bottom: 1px solid var(--border-light); margin-bottom: 4px;">
                    <input type="checkbox" @change="toggleAllPlatforms($event)" :checked="allPlatformsSelected()" :indeterminate="indeterminatePlatforms()" />
                    <span class="text-sm" style="font-weight: 500;">Select All</span>
                  </label>
                  <template x-for="pl in platforms()" :key="pl">
                    <label style="display:flex; align-items:center; gap:.5rem; padding: 3px 0;">
                      <input type="checkbox" :value="pl" @change="toggleInArray(fltPlatforms, pl)" :checked="fltPlatforms.includes(pl)" />
                      <span class="text-sm" x-text="pl"></span>
                    </label>
                  </template>
                </div>
              </div>

              <!-- Environment/Tier Filter -->
              <div>
                <div class="form-label" style="margin-bottom: 0.5rem;">Environment / Tier</div>
                <div style="max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 0.5rem;">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 0; border-bottom: 1px solid var(--border-light); margin-bottom: 4px;">
                    <input type="checkbox" @change="toggleAllEnvs($event)" :checked="allEnvsSelected()" :indeterminate="indeterminateEnvs()" />
                    <span class="text-sm" style="font-weight: 500;">Select All</span>
                  </label>
                  <template x-for="env in environments()" :key="env">
                    <label style="display:flex; align-items:center; gap:.5rem; padding: 3px 0;">
                      <input type="checkbox" :value="env" @change="toggleInArray(fltEnvs, env)" :checked="fltEnvs.includes(env)" />
                      <span class="text-sm" x-text="env"></span>
                    </label>
                  </template>
                </div>
              </div>
            </div>

            <!-- Regions Filter (full width) -->
            <div style="margin-top: 1rem;">
              <div class="form-label" style="margin-bottom: 0.5rem;">Regions</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; max-height: 120px; overflow-y: auto;">
                <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 8px; background: var(--border-light); border-radius: var(--radius);">
                  <input type="checkbox" @change="toggleAllRegions($event)" :checked="allRegionsSelected()" :indeterminate="indeterminateRegions()" />
                  <span class="text-sm" style="font-weight: 500;">All</span>
                </label>
                <template x-for="rg in regions()" :key="rg">
                  <label style="display:flex; align-items:center; gap:.5rem; padding: 4px 8px; background: var(--border-light); border-radius: var(--radius);">
                    <input type="checkbox" :value="rg" @change="toggleInArray(fltRegions, rg)" :checked="fltRegions.includes(rg)" />
                    <span class="text-sm" x-text="rg"></span>
                  </label>
                </template>
              </div>
            </div>

            <div class="row" style="justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
              <button class="btn ghost" @click="clearFilters()">Clear All</button>
              <button class="btn btn-secondary" @click="filtersOpen=false">Cancel</button>
              <button class="btn" @click="filtersOpen=false; page=1; load()">Apply Filters</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Bulk Assign (Analytics) -->
      <div x-show="bulkAssignOpen" x-cloak @click.self="bulkAssignOpen=false" @keydown.escape.window="bulkAssignOpen && (bulkAssignOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:420px; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Assign Account</h3>
            <button class="btn ghost btn-sm" @click="bulkAssignOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <p class="text-sm muted" style="margin-bottom: 1rem;">Assign an account to <strong x-text="selected.length"></strong> selected block(s).</p>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Account</label>
              <select x-model.number="bulkAccountId" style="width: 100%;">
                <option :value="null">No Account</option>
                <template x-for="a in accounts" :key="a.id">
                  <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
                </template>
              </select>
            </div>
            <div class="row" style="justify-content:flex-end; gap: 0.5rem;">
              <button class="btn btn-secondary" @click="bulkAssignOpen=false">Cancel</button>
              <button class="btn" @click="performBulkAssign()">Apply</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Delete (Analytics) -->
      <div x-show="bulkDeleteOpen" x-cloak @click.self="bulkDeleteOpen=false" @keydown.escape.window="bulkDeleteOpen && (bulkDeleteOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" x-data="modalDrag()" @mousemove.window="move($event)" @mouseup.window="end()" :style="'width:460px; transform: translate(' + dx + 'px,' + dy + 'px)'">
          <div class="card-header" style="cursor:move" @mousedown.prevent="start($event)">
            <h3 class="card-title">Delete Selected Blocks</h3>
            <button class="btn ghost btn-sm" @click="bulkDeleteOpen=false">Ã—</button>
          </div>
          <div class="card-body">
            <p style="margin-bottom: 1rem;">You are about to delete <strong x-text="selected.length"></strong> block(s).</p>
            <label style="display:flex; align-items:center; gap:.5rem; margin-bottom: 0.75rem; font-size: 13px;">
              <input type="checkbox" x-model="bulkCascade" />
              <span>Cascade delete descendants</span>
            </label>
            <label style="display:flex; align-items:center; gap:.5rem; margin-bottom: 1rem; font-size: 13px;">
              <input type="checkbox" x-model="confirmBulkDelete" />
              <span>I understand this cannot be undone</span>
            </label>
            <div class="row" style="justify-content:flex-end; gap: 0.5rem;">
              <button class="btn btn-secondary" @click="bulkDeleteOpen=false">Cancel</button>
              <button class="btn btn-danger" :disabled="!confirmBulkDelete" @click="performBulkDelete()">Delete Blocks</button>
            </div>
          </div>
        </div>
      </div>
      <script>
        function allBlocksView() {
          return {
            accounts: [],
            parentPools: [],
            selectedAccounts: [],
            selectedPools: [],
            filtersOpen: false,
            blocks: [],
            rawBlocks: [],
            msg: '',
            search: '',
            fltAccountName: '',
            fltCIDR: '',
            fltPlatforms: [],
            fltEnvs: [],
            fltRegions: [],
            pageSize: '50',
            page: 1,
            pageInput: 1,
            total: 0,
            totalPages: 1,
            fromItem: 0,
            toItem: 0,
            editOpen:false,
            editForm:{ id:null, name:'', account_id:null },
            deleteOpen:false,
            deleteTarget:null,
            deleteDescendants: [],
            deleteCascade: false,
            confirmBlockDelete: false,
            chartParent: null,
            chartAccount: null,
            chartTime: null,
            selected: [],
            bulkOpen: false,
            bulkAssignOpen: false,
            bulkDeleteOpen: false,
            bulkAccountId: null,
            bulkCascade: false,
            confirmBulkDelete: false,
            sortAnalKey: 'created',
            sortAnalDir: 'desc',
            // Filter helper methods
            hasActiveFilters() {
              return this.selectedAccounts.length > 0 ||
                     this.selectedPools.length > 0 ||
                     this.fltAccountName !== '' ||
                     this.fltCIDR !== '' ||
                     this.fltPlatforms.length > 0 ||
                     this.fltEnvs.length > 0 ||
                     this.fltRegions.length > 0;
            },
            activeFilterCount() {
              let count = 0;
              if (this.selectedAccounts.length > 0) count++;
              if (this.selectedPools.length > 0) count++;
              if (this.fltAccountName !== '') count++;
              if (this.fltCIDR !== '') count++;
              if (this.fltPlatforms.length > 0) count++;
              if (this.fltEnvs.length > 0) count++;
              if (this.fltRegions.length > 0) count++;
              return count;
            },
            async init() {
              await Promise.all([this.fetchAccounts(), this.fetchParentPools()]);
              this.restoreFilters();
              await this.load();
              this.renderCharts();
            },
            async fetchAccounts() {
              try { const res = await fetch('/api/v1/accounts'); this.accounts = await res.json(); }
              catch (e) { this.msg = 'Failed to load accounts'; }
            },
            async fetchParentPools() {
              try { const res = await fetch('/api/v1/pools'); const all = await res.json(); this.parentPools = all.filter(p => !p.parent_id); }
              catch (e) { this.msg = 'Failed to load pools'; }
            },
            async load() {
              this.msg = '';
              try {
                this.loading = true;
                const q = new URLSearchParams();
                if (this.selectedAccounts.length) q.set('accounts', this.selectedAccounts.join(','));
                if (this.selectedPools.length) q.set('pools', this.selectedPools.join(','));
                if (this.pageSize !== 'all') { q.set('page_size', this.pageSize); q.set('page', this.page); }
                else { q.set('page_size', 'all'); }
                const res = await fetch('/api/v1/blocks?' + q.toString());
                if (!res.ok) { this.msg = await parseError(res); showToast(this.msg,'error'); return; }
              const data = await res.json();
              const items = Array.isArray(data) ? data : (data.items || []);
              this.rawBlocks = this.withDerivedIPs(items);
              const pageSizeNum = this.pageSize === 'all' ? items.length : parseInt(this.pageSize, 10);
              this.total = data.total ?? items.length;
              this.totalPages = this.pageSize === 'all' ? 1 : Math.max(1, Math.ceil(this.total / pageSizeNum));
              const startIdx = this.total === 0 ? 0 : ((this.page - 1) * (pageSizeNum || this.total)) + 1;
              const endIdx = this.total === 0 ? 0 : Math.min(this.total, (this.page - 1) * (pageSizeNum || this.total) + items.length);
              this.fromItem = startIdx;
              this.toItem = endIdx;
              this.pageInput = this.page;
              this.blocks = this.filtered();
              // prune selection
              const curIds = new Set(this.blocks.map(b=>b.id));
              this.selected = this.selected.filter(id=>curIds.has(id));
              this.renderCharts();
            } catch (e) { this.msg = 'Failed to load blocks'; }
            finally { this.loading = false; this.persistFilters(); }
            },
            clearFilters() { this.selectedAccounts = []; this.selectedPools = []; this.fltAccountName=''; this.fltCIDR=''; this.fltPlatforms=[]; this.fltEnvs=[]; this.fltRegions=[]; this.filtersOpen=false; this.page=1; this.load(); }
            ,
            // Master toggles for filter lists
            allAccountsSelected(){ return this.accounts.length>0 && this.selectedAccounts.length===this.accounts.length; },
            indeterminateAccounts(){ return this.selectedAccounts.length>0 && this.selectedAccounts.length<this.accounts.length; },
            toggleAllAccounts(ev){ if (ev.target.checked) { this.selectedAccounts = this.accounts.map(a=>String(a.id)); } else { this.selectedAccounts = []; } this.page=1; this.load(); },
            allPoolsSelected(){ return this.parentPools.length>0 && this.selectedPools.length===this.parentPools.length; },
            indeterminatePools(){ return this.selectedPools.length>0 && this.selectedPools.length<this.parentPools.length; },
            toggleAllPools(ev){ if (ev.target.checked) { this.selectedPools = this.parentPools.map(p=>String(p.id)); } else { this.selectedPools = []; } this.page=1; this.load(); },
            allPlatformsSelected(){ const opts=this.platforms(); return opts.length>0 && this.fltPlatforms.length===opts.length; },
            indeterminatePlatforms(){ const opts=this.platforms(); return this.fltPlatforms.length>0 && this.fltPlatforms.length<opts.length; },
            toggleAllPlatforms(ev){ const opts=this.platforms(); if (ev.target.checked) { this.fltPlatforms = opts.slice(); } else { this.fltPlatforms = []; } this.page=1; this.load(); },
            allEnvsSelected(){ const opts=this.environments(); return opts.length>0 && this.fltEnvs.length===opts.length; },
            indeterminateEnvs(){ const opts=this.environments(); return this.fltEnvs.length>0 && this.fltEnvs.length<opts.length; },
            toggleAllEnvs(ev){ const opts=this.environments(); if (ev.target.checked) { this.fltEnvs = opts.slice(); } else { this.fltEnvs = []; } this.page=1; this.load(); },
            allRegionsSelected(){ const opts=this.regions(); return opts.length>0 && this.fltRegions.length===opts.length; },
            indeterminateRegions(){ const opts=this.regions(); return this.fltRegions.length>0 && this.fltRegions.length<opts.length; },
            toggleAllRegions(ev){ const opts=this.regions(); if (ev.target.checked) { this.fltRegions = opts.slice(); } else { this.fltRegions = []; } this.page=1; this.load(); },
            
            filtered() {
              const src = this.rawBlocks;
              let arr = src;
              if (this.selectedAccounts.length) arr = arr.filter(b => this.selectedAccounts.includes(String(b.account_id)));
              if (this.selectedPools.length) arr = arr.filter(b => this.selectedPools.includes(String(b.parent_id)));
              if (this.fltAccountName) { const qn = this.fltAccountName.toLowerCase(); arr = arr.filter(b => (b.account_name||'').toLowerCase().includes(qn)); }
              if (this.fltCIDR) { const qc = this.fltCIDR.toLowerCase(); arr = arr.filter(b => (b.cidr||'').toLowerCase().includes(qc)); }
              if (this.fltPlatforms.length) arr = arr.filter(b => this.fltPlatforms.includes((b.account_platform||'').toLowerCase()));
              if (this.fltEnvs.length) {
                arr = arr.filter(b => {
                  const env = (b.account_environment||b.account_tier||'').toLowerCase();
                  return this.fltEnvs.includes(env);
                });
              }
              if (this.fltRegions.length) {
                arr = arr.filter(b => {
                  const regs = Array.isArray(b.account_regions) ? b.account_regions.map(r=>String(r).toLowerCase()) : [];
                  return this.fltRegions.some(r => regs.includes(r));
                });
              }
              const q = (this.search||'').toLowerCase();
              if (q) arr = arr.filter(b => String(b.id).includes(q) || (b.name||'').toLowerCase().includes(q) || (b.cidr||'').toLowerCase().includes(q) || (b.parent_name||'').toLowerCase().includes(q) || (b.account_name||'').toLowerCase().includes(q));
              const key=this.sortAnalKey, dir=this.sortAnalDir==='asc'?1:-1;
              const get=(b)=> key==='id'? b.id : key==='name'? (b.name||'') : key==='cidr'? (b.cidr||'') : key==='parent'? (b.parent_name||'') : key==='account'? (b.account_name||'') : (b.created_at||'');
              arr.sort((a,b)=> { const av=get(a), bv=get(b); return av>bv?dir: av<bv? -dir: 0; });
              return arr;
            }
            ,
            sortAnal(k){ this.sortAnalDir = (this.sortAnalKey===k && this.sortAnalDir==='asc') ? 'desc' : 'asc'; this.sortAnalKey = k; this.blocks = this.filtered(); },
            persistFilters(){ const obj={ a:this.selectedAccounts, p:this.selectedPools, an:this.fltAccountName, c:this.fltCIDR, pl:this.fltPlatforms, e:this.fltEnvs, r:this.fltRegions, ps:this.pageSize }; localStorage.setItem('cp.analytics.filters', JSON.stringify(obj)); },
            restoreFilters(){ try{ const raw = localStorage.getItem('cp.analytics.filters'); if(!raw) return; const o=JSON.parse(raw); this.selectedAccounts=o.a||[]; this.selectedPools=o.p||[]; this.fltAccountName=o.an||''; this.fltCIDR=o.c||''; this.fltPlatforms=o.pl||[]; this.fltEnvs=o.e||[]; this.fltRegions=o.r||[]; if (o.ps) this.pageSize=o.ps; }catch{} },
            toggleSelect(id){ const i=this.selected.indexOf(id); if(i>=0) this.selected.splice(i,1); else this.selected.push(id); },
            toggleSelectAll(ev){ if (ev.target.checked){ this.selected = this.filtered().map(b=>b.id); } else { this.selected = []; } },
            allSelected(){ const data=this.filtered(); return data.length>0 && this.selected.length===data.length; },
            indeterminate(){ const data=this.filtered(); return this.selected.length>0 && this.selected.length<data.length; },
            openBulkAssign(){ this.bulkAssignOpen=true; this.bulkAccountId=null; },
            async performBulkAssign(){ const target=this.bulkAccountId ?? null; for (const id of this.selected){ try { await fetch(`/api/v1/pools/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ account_id: target }) }); } catch{} } this.bulkAssignOpen=false; await this.load(); showToast('Assigned account'); },
            openBulkDelete(){ this.bulkDeleteOpen=true; this.bulkCascade=false; this.confirmBulkDelete=false; },
            async performBulkDelete(){ for (const id of this.selected){ const force=this.bulkCascade?'?force=1':''; try { await fetch(`/api/v1/pools/${id}${force}`, { method:'DELETE' }); } catch{} } this.bulkDeleteOpen=false; this.selected=[]; await this.load(); showToast('Deleted selected'); },
            platforms(){ const set=new Set(); for (const a of this.accounts) { const v=(a.platform||'').toLowerCase(); if (v) set.add(v); } return Array.from(set).sort(); },
            environments(){ const set=new Set(); for (const a of this.accounts) { const v=((a.environment||a.tier)||'').toLowerCase(); if (v) set.add(v); } return Array.from(set).sort(); },
            regions(){ const set=new Set(); for (const a of this.accounts) { const arr=Array.isArray(a.regions)?a.regions:[]; for (const r of arr) { const v=String(r).toLowerCase(); if (v) set.add(v); } } return Array.from(set).sort(); },
            toggleInArray(arr, val){ const i=arr.indexOf(val); if(i>=0) arr.splice(i,1); else arr.push(val); },
            summary(){
              const parts=[];
              if (this.selectedAccounts.length) parts.push(`${this.selectedAccounts.length} account(s)`);
              if (this.selectedPools.length) parts.push(`${this.selectedPools.length} parent pool(s)`);
              return parts.length? 'Filters: '+parts.join(', ') : 'No filters applied';
            },
            withDerivedIPs(items) {
              const out = [];
              for (const it of (items||[])) {
                const cidr = it.cidr;
                const derived = deriveIPv4Range(cidr);
                out.push({ ...it, network_ip: derived?.network || null, broadcast_ip: derived?.broadcast || null });
              }
              return out;
            },
            // ---------- Charts ----------
            ensureCharts() {
              if (typeof ApexCharts === 'undefined') return;
              if (!this.chartParent && this.$refs.chartParent) {
                this.chartParent = new ApexCharts(this.$refs.chartParent, {
                  chart: { type: 'bar', height: 260, toolbar: { show: false } },
                  series: [{ name: 'Blocks', data: [] }],
                  xaxis: { categories: [] },
                  dataLabels: { enabled: false },
                  grid: { borderColor: '#eee' }
                });
                this.chartParent.render();
              }
              if (!this.chartAccount && this.$refs.chartAccount) {
                this.chartAccount = new ApexCharts(this.$refs.chartAccount, {
                  chart: { type: 'donut', height: 260, toolbar: { show: false } },
                  series: [], labels: [], legend: { position: 'bottom' }
                });
                this.chartAccount.render();
              }
              if (!this.chartTime && this.$refs.chartTime) {
                this.chartTime = new ApexCharts(this.$refs.chartTime, {
                  chart: { type: 'line', height: 260, toolbar: { show: false } },
                  series: [{ name: 'Created', data: [] }],
                  xaxis: { type: 'category', categories: [] },
                  stroke: { curve: 'smooth' }, dataLabels: { enabled: false }, grid: { borderColor: '#eee' }
                });
                this.chartTime.render();
              }
            },
            renderCharts() {
              this.ensureCharts();
              if (!this.chartParent || !this.chartAccount || !this.chartTime) return;
              const rows = this.filtered();
              // Bar: count by parent pool
              const byParent = new Map();
              for (const r of rows) { const k = r.parent_name || `#${r.parent_id}`; byParent.set(k, (byParent.get(k)||0)+1); }
              const parentCats = Array.from(byParent.keys());
              const parentVals = parentCats.map(k => byParent.get(k));
              this.chartParent.updateOptions({ xaxis: { categories: parentCats } });
              this.chartParent.updateSeries([{ name: 'Blocks', data: parentVals }]);
              // Donut: address space by account (usable hosts)
              const byAcct = new Map();
              for (const r of rows) {
                const lab = r.account_name || '-';
                const bits = this.cidrBits(r.cidr);
                const usable = this.usableHosts(bits);
                byAcct.set(lab, (byAcct.get(lab)||0) + usable);
              }
              const acctLabels = Array.from(byAcct.keys());
              const acctVals = acctLabels.map(k => byAcct.get(k));
              this.chartAccount.updateOptions({ labels: acctLabels });
              this.chartAccount.updateSeries(acctVals);
              // Line: creations per day
              const byDay = new Map();
              for (const r of rows) {
                const d = new Date(r.created_at);
                if (isNaN(d.getTime())) continue;
                const key = d.getFullYear()+ '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                byDay.set(key, (byDay.get(key)||0)+1);
              }
              const dayCats = Array.from(byDay.keys()).sort();
              const dayVals = dayCats.map(k => byDay.get(k));
              this.chartTime.updateOptions({ xaxis: { categories: dayCats } });
              this.chartTime.updateSeries([{ name: 'Created', data: dayVals }]);
            },
            cidrBits(cidr){ if (!cidr) return null; const i=cidr.indexOf('/'); if(i<0) return null; const b=parseInt(cidr.slice(i+1),10); return isNaN(b)?null:b; },
            usableHosts(bits){ if (bits==null || bits<0 || bits>32) return 0; const total = Math.pow(2, 32-bits); if (bits <= 30) return Math.max(0, total - 2); return total; },
            async prevPage() { if (this.page > 1) { this.page--; await this.load(); } },
            async nextPage() { if (this.page < this.totalPages) { this.page++; await this.load(); } },
            async firstPage() { if (this.page !== 1) { this.page = 1; await this.load(); } },
            async lastPage() { if (this.page !== this.totalPages) { this.page = this.totalPages; await this.load(); } },
            async goToPage() {
              if (this.pageSize === 'all') return;
              let target = parseInt(this.pageInput, 10);
              if (!target || target < 1) target = 1;
              if (target > this.totalPages) target = this.totalPages;
              if (target === this.page) return;
              this.page = target;
              await this.load();
            },
            openEditBlock(b){ this.editForm = { id:b.id, name:b.name, account_id: null }; this.editOpen = true; }
            ,
            async saveEditBlock(){
              const f=this.editForm;
              try {
                const res = await fetch(`/api/v1/pools/${f.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name:f.name, account_id:f.account_id }) });
                if (!res.ok) { this.msg = await parseError(res); showToast(this.msg,'error'); return; }
                this.editOpen=false; await this.load(); showToast('Block updated');
              } catch(e){ this.msg='Update failed'; }
            }
            ,
            confirmDeleteBlock(b){
              this.deleteTarget=b; this.deleteCascade=false; this.deleteDescendants=[]; this.confirmBlockDelete=false;
              // fetch all pools to compute descendants of this sub-pool
              fetch('/api/v1/pools').then(r=>r.json()).then(list => {
                const byParent = new Map();
                for (const p of list) { if (p.parent_id) { const arr = byParent.get(p.parent_id) || []; arr.push(p); byParent.set(p.parent_id, arr); } }
                const out=[]; const stack=[b.id];
                while (stack.length){
                  const id=stack.pop();
                  const children = byParent.get(id) || [];
                  for (const c of children){ out.push(c); stack.push(c.id); }
                }
                this.deleteDescendants=out;
              });
              this.deleteOpen=true;
            }
            ,
            async deleteBlock(){ const b=this.deleteTarget; if(!b) return; try{ const force=this.deleteCascade?'?force=1':''; const res=await fetch(`/api/v1/pools/${b.id}${force}`, {method:'DELETE'}); if(!res.ok){ this.msg=await parseError(res); showToast(this.msg,'error'); return;} this.deleteOpen=false; await this.load(); showToast('Block deleted'); } catch(e){ this.msg='Delete failed'; } }
            ,
            downloadCsv() {
              const rows = this.filtered();
              const header = ['id','name','cidr','parent_id','parent_name','account_id','account_name','account_platform','account_environment','account_regions','network_ip','broadcast_ip','created_at'];
              const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
              const fmtRegions = v => Array.isArray(v) ? v.join('|') : '';
              const lines = [header.join(',')].concat(rows.map(r => [r.id,r.name,r.cidr,r.parent_id,r.parent_name,r.account_id||'',r.account_name||'',r.account_platform||'',(r.account_environment||r.account_tier||''),fmtRegions(r.account_regions),r.network_ip||'',r.broadcast_ip||'',r.created_at].map(esc).join(',')));
              const blob = new Blob([lines.join('\n')], {type:'text/csv'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'assigned_blocks.csv'; a.click();
              setTimeout(() => URL.revokeObjectURL(url), 2000);
            }
          }
        }
      </script>
      <!-- Edit Block Modal -->
      <div x-show="editOpen" x-cloak @click.self="editOpen=false" @keydown.escape.window="editOpen && (editOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" style="width:520px;">
          <h3>Edit Block</h3>
          <div class="row">
            <input type="text" placeholder="Name" x-model="editForm.name" style="flex:1;" />
            <select x-model.number="editForm.account_id" style="flex:1;">
              <option :value="null">No Account</option>
              <template x-for="a in accounts" :key="a.id">
                <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
              </template>
            </select>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:1rem;">
            <button class="btn ghost" @click="editOpen=false">Cancel</button>
            <button class="btn" @click="saveEditBlock()">Save</button>
          </div>
        </div>
      </div>
      <!-- Delete Block Confirm Modal -->
      <div x-show="deleteOpen" x-cloak @click.self="deleteOpen=false" @keydown.escape.window="deleteOpen && (deleteOpen=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10010;">
        <div class="card" style="width:420px;">
          <h3>Confirm Delete</h3>
          <p>Are you sure you want to delete <strong x-text="deleteTarget?.name"></strong>?</p>
          <template x-if="deleteTarget">
            <div>
              <p class="muted" x-show="deleteDescendants.length">This block has the following child sub-pools that will also be deleted:</p>
              <ul>
                <template x-for="p in deleteDescendants" :key="p.id">
                  <li x-text="p.name + ' ('+p.cidr+')'"></li>
                </template>
              </ul>
              <label x-show="deleteDescendants.length"><input type="checkbox" x-model="deleteCascade" /> Delete all children</label>
            </div>
          </template>
          <div class="row" style="justify-content:space-between; align-items:center; margin-top:1rem;">
            <label style="display:flex; align-items:center; gap:.4rem;"><input type="checkbox" x-model="confirmBlockDelete" /> I understand this action cannot be undone</label>
            <button class="btn ghost" @click="deleteOpen=false">Cancel</button>
            <button class="btn" :disabled="(!confirmBlockDelete) || (deleteDescendants.length && !deleteCascade)" @click="deleteBlock()">Delete</button>
          </div>
        </div>
      </div>
    </section>
    </template>
    </main>
    </div><!-- end tabState wrapper -->

      <script>
      // Data Import/Export modal helpers
      function modalDrag(){
        return {
          dx:0, dy:0, drag:false, sx:0, sy:0,
          start(e){
            this.drag=true;
            this.sx=e.clientX - this.dx;
            this.sy=e.clientY - this.dy;
          },
          move(e){
            if(!this.drag) return;
            this.dx = e.clientX - this.sx;
            this.dy = e.clientY - this.sy;
          },
          end(){ this.drag=false; },
          reset(){ this.dx=0; this.dy=0; }
        }
      }
      function dataIO(){
        return {
          open: false,
          // Export state
          exp: { accounts:true, pools:true, blocks:false },
          expFields: {
            accounts: { id:true, key:true, name:true, provider:true, external_id:true, description:true, platform:true, tier:true, environment:true, regions:true, created_at:true },
            pools: { id:true, name:true, cidr:true, parent_id:true, account_id:true, created_at:true },
            blocks: { id:true, name:true, cidr:true, parent_id:true, parent_name:true, account_id:true, account_name:true, account_platform:true, account_tier:true, account_environment:true, account_regions:true, created_at:true }
          },
          // Import state
          imp: { type: 'accounts', file: null, headers: [], rows: [], mapping: {}, preview: [], logs: [], unmapped: [], showUnmappedModal: false },
          msg: '',
          init(){},
          fieldsList(kind){
            return Object.keys(this.expFields[kind]);
          },
          buildExportURL(){
            const ds = [];
            if (this.exp.accounts) ds.push('accounts');
            if (this.exp.pools) ds.push('pools');
            if (this.exp.blocks) ds.push('blocks');
            const params = new URLSearchParams();
            params.set('datasets', ds.join(','));
            const pick = (obj)=> Object.keys(obj).filter(k=>obj[k]).join(',');
            if (this.exp.accounts) params.set('accounts_fields', pick(this.expFields.accounts));
            if (this.exp.pools) params.set('pools_fields', pick(this.expFields.pools));
            if (this.exp.blocks) params.set('blocks_fields', pick(this.expFields.blocks));
            return '/api/v1/export?' + params.toString();
          },
          downloadExport(){
            const url = this.buildExportURL();
            window.open(url, '_blank');
          },
          onImportFile(ev){
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            this.imp.file = file;
            const reader = new FileReader();
            reader.onload = () => {
              const text = reader.result || '';
              const { headers, rows } = this.parseCSV(String(text));
              this.imp.headers = headers;
              this.imp.rows = rows;
              this.autoMapHeaders();
              this.previewRows();
            };
            reader.readAsText(file);
          },
          normalizeName(s){ return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/-/g,'_'); },
          autoMapHeaders(){
            const kind = this.imp.type;
            const map = {};
            const norm = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
            const has = (s, ...subs) => subs.every(x => s.includes(x));
            for (const h of this.imp.headers){
              const n = norm(h);
              let guess = '';
              if (kind==='accounts'){
                // Match variations from example CSV: "Account ID, Key, Name, Provider, Environment, Regions"
                if (n==='key' || has(n,'account','key')) guess='key';
                else if (n==='name' || has(n,'account','name')) guess='name';
                else if (n==='provider' || has(n,'cloud','provider')) guess='provider';
                else if (n==='external id' || n==='externalid' || has(n,'external','id')) guess='external_id';
                else if (n==='description' || n==='desc' || n==='notes' || n==='note') guess='description';
                else if (n==='platform') guess='platform';
                else if (n==='tier') guess='tier';
                else if (n==='environment' || n==='env') guess='environment';
                else if (n==='region' || n==='regions' || has(n,'region')) guess='regions';
                // Note: "Account ID" is intentionally not mapped as IDs are auto-generated
                else guess='';
              } else if (kind==='pools'){
                // Match variations from example CSV: "CIDR Block, Platform, Environment, Region, Account ID, Notes"
                if (n==='name' || n==='label' || n==='pool name') guess='name';
                else if (n==='cidr' || n==='cidr block' || has(n,'cidr','block') || n==='subnet' || n==='network' || n==='prefix') guess='cidr';
                else if (n==='parent id' || n==='parentid' || has(n,'parent','id')) guess='parent_id';
                else if (n==='parent' || n==='parent name' || n==='parent pool') guess='parent_id';
                else if (n==='account id' || n==='acct id' || has(n,'account','id')) guess='account_id';
                else if (n==='account' || n==='acct' || n==='account name' || n==='account key') guess='account_id';
                // Note: Platform, Environment, Region, Notes in example CSV don't directly map to pool fields
                else guess='';
              } else if (kind==='blocks'){
                if (n==='name' || n==='label') guess='name';
                else if (n==='cidr' || n==='cidr block' || has(n,'cidr','block') || n==='subnet' || n==='network' || n==='prefix') guess='cidr';
                else if (n==='parent id' || n==='parentid' || has(n,'parent','id')) guess='parent_id';
                else if (n==='parent name' || n==='parent' || has(n,'parent','name')) guess='parent_name';
                else if (n==='account id' || n==='acct id' || has(n,'account','id')) guess='account_id';
                else if (n==='account name' || has(n,'account','name')) guess='account_name';
                else if (n==='account key' || has(n,'account','key')) guess='account_key';
                else if (n==='account' || n==='acct') guess='account_id';
                else guess='';
              }
              map[h] = guess;
            }
            this.imp.mapping = map;
            // After auto-mapping, check if there are unmapped columns and show review modal
            this.checkUnmappedColumns(true);
          },
          checkUnmappedColumns(autoShow = false){
            const unmapped = [];
            for (const [header, field] of Object.entries(this.imp.mapping)){
              if (!field) unmapped.push(header);
            }
            this.imp.unmapped = unmapped;
            // Show modal automatically on initial load
            if (autoShow) {
              this.imp.showUnmappedModal = true;
            }
          },
          closeUnmappedModal(){
            this.imp.showUnmappedModal = false;
          },
          getAvailableFields(){
            const kind = this.imp.type;
            if (kind === 'accounts') {
              return ['key', 'name', 'provider', 'external_id', 'description', 'platform', 'tier', 'environment', 'regions'];
            } else if (kind === 'pools') {
              return ['name', 'cidr', 'parent_id', 'account_id'];
            } else if (kind === 'blocks') {
              return ['name', 'cidr', 'parent_id', 'parent_name', 'account_id', 'account_name', 'account_key'];
            }
            return [];
          },
          getMappedColumns(){
            return Object.entries(this.imp.mapping).filter(([h, f]) => f !== '').map(([h, f]) => ({ header: h, field: f }));
          },
          applyUnmappedChanges(){
            // Just close the modal, changes are already applied via x-model
            this.closeUnmappedModal();
          },
          previewRows(){ this.imp.preview = this.imp.rows.slice(0, 5); },
          // Very simple CSV parser with quote handling for our own exports
          parseCSV(text){
            const lines = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.length>0);
            if (lines.length === 0) return { headers: [], rows: [] };
            const parseLine = (line)=>{
              const out=[]; let cur=''; let inq=false;
              for (let i=0;i<line.length;i++){
                const ch=line[i];
                if (inq){
                  if (ch==='"') { if (i+1<line.length && line[i+1]==='"'){ cur+='"'; i++; } else { inq=false; } }
                  else { cur+=ch; }
                } else {
                  if (ch===','){ out.push(cur); cur=''; }
                  else if (ch==='"'){ inq=true; }
                  else { cur+=ch; }
                }
              }
              out.push(cur);
              return out;
            };
            const headers = parseLine(lines[0]).map(h=>h.trim());
            const rows = lines.slice(1).map(ln=>parseLine(ln));
            return { headers, rows };
          },
          async startImport(){
            this.msg='';
            const kind=this.imp.type;
            if (!this.imp.rows.length){ this.msg='No rows to import'; return; }
            const headerIndex = {}; this.imp.headers.forEach((h,i)=>{ headerIndex[h]=i; });
            let ok=0, fail=0, shown=0;
            // Load accounts for lookup if needed
            let accounts=[]; let pools=[];
            if (kind==='pools' || kind==='blocks') {
              try { const res=await fetch('/api/v1/accounts'); accounts=await res.json(); } catch{}
              try { const res=await fetch('/api/v1/pools'); pools=await res.json(); } catch{}
            }
            for (const row of this.imp.rows){
              try {
                if (kind==='accounts'){
                  const obj={ key:'', name:'', provider:'', external_id:'', description:'', platform:'', tier:'', environment:'', regions:[] };
                  for (const [src, dst] of Object.entries(this.imp.mapping)){
                    if (!dst) continue; const idx=headerIndex[src]; if (idx==null) continue; const v=row[idx]||'';
                    if (dst==='regions') obj.regions = String(v).split(/[|,;]/).map(s=>s.trim()).filter(Boolean);
                    else if (dst==='key'||dst==='name'||dst==='provider'||dst==='external_id'||dst==='description'||dst==='platform'||dst==='tier'||dst==='environment') obj[dst]=String(v);
                  }
                  if (!obj.key || !obj.name) { fail++; if (shown<5) { shown++; showToast('Import error: account requires key and name','error'); } continue; }
                  const res = await fetch('/api/v1/accounts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj) });
                  if (!res.ok) { const err=await parseError(res); fail++; if (shown<5) { shown++; showToast(`Import error: ${err}`,'error'); } continue; }
                  ok++;
                } else if (kind==='pools') {
                  const obj={ name:'', cidr:'', parent_id:null, account_id:null };
                  let accountHint='';
                  for (const [src, dst] of Object.entries(this.imp.mapping)){
                    if (!dst) continue; const idx=headerIndex[src]; if (idx==null) continue; const v=row[idx]||'';
                    if (dst==='name'||dst==='cidr') obj[dst]=String(v);
                    else if (dst==='parent_id') { const n=parseInt(String(v),10); obj.parent_id= isNaN(n)? null : n; }
                    else if (dst==='account_id') {
                      if (/^\d+$/.test(String(v))) { const n=parseInt(String(v),10); obj.account_id = isNaN(n)? null : n; }
                      else { accountHint = String(v); }
                    }
                  }
                  if (!obj.name) { obj.name = obj.cidr || '(unnamed)'; }
                  if (!obj.cidr) { fail++; if (shown<5) { shown++; showToast('Import error: CIDR is required','error'); } continue; }
                  if (accountHint){
                    const m=accounts.find(a=>a.key===accountHint || a.name===accountHint);
                    if (m) obj.account_id = m.id; else obj.account_id = null;
                  }
                  const res = await fetch('/api/v1/pools', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj) });
                  if (!res.ok) { const err=await parseError(res); fail++; if (shown<5) { shown++; showToast(`Import error: ${err}`,'error'); } continue; }
                  ok++;
                } else if (kind==='blocks') {
                  // Blocks are sub-pools; require resolving parent_id
                  const obj={ name:'', cidr:'', parent_id:null, account_id:null };
                  let accountHint=''; let parentHintName='';
                  for (const [src, dst] of Object.entries(this.imp.mapping)){
                    if (!dst) continue; const idx=headerIndex[src]; if (idx==null) continue; const v=row[idx]||'';
                    if (dst==='name'||dst==='cidr') obj[dst]=String(v);
                    else if (dst==='parent_id') { const n=parseInt(String(v),10); obj.parent_id= isNaN(n)? null : n; }
                    else if (dst==='parent_name') { parentHintName = String(v); }
                    else if (dst==='account_id') {
                      if (/^\d+$/.test(String(v))) { const n=parseInt(String(v),10); obj.account_id = isNaN(n)? null : n; }
                      else { accountHint = String(v); }
                    } else if (dst==='account_name' || dst==='account_key') {
                      accountHint = String(v);
                    }
                  }
                  if (!obj.name) { obj.name = obj.cidr || '(unnamed)'; }
                  if (!obj.cidr) { fail++; if (shown<5) { shown++; showToast('Import error: CIDR is required','error'); } continue; }
                  // Resolve account by hint if needed
                  if (!obj.account_id && accountHint){
                    const m=accounts.find(a=>a.key===accountHint || a.name===accountHint);
                    if (m) obj.account_id = m.id;
                  }
                  // Resolve parent by name match that contains CIDR
                  if (!obj.parent_id) {
                    const pr = prefixRange(obj.cidr);
                    if (pr && parentHintName) {
                      const candidates = pools.filter(p=>!(!p || !p.cidr) && (p.name||'')===parentHintName && p.parent_id==null);
                      let chosen=null;
                      for (const p of candidates){ const r=prefixRange(p.cidr); if (!r) continue; if (pr.start>=r.start && pr.end<=r.end) { chosen=p; break; } }
                      if (chosen) obj.parent_id = chosen.id;
                    }
                  }
                  if (!obj.parent_id) { fail++; if (shown<5) { shown++; showToast(`Import error: Could not resolve parent for ${obj.cidr}`,'error'); } continue; }
                  const res = await fetch('/api/v1/pools', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj) });
                  if (!res.ok) { const err=await parseError(res); fail++; if (shown<5) { shown++; showToast(`Import error: ${err}`,'error'); } continue; }
                  ok++;
                }
              } catch (e) { fail++; if (shown<5) { shown++; showToast(`Import error: ${e}`,'error'); } }
            }
            showToast(`Import complete: ${ok} ok, ${fail} failed`, fail? 'error':'info');
          }
        }
      }
      async function parseError(res) {
        try { const data = await res.json(); return data.error || data.detail || res.statusText || 'Request failed'; }
        catch (e) { try { return await res.text(); } catch { return res.statusText || 'Request failed'; } }
      }
      function tabState(){
        return {
          tab: 'pools',
          init(){
            const h = (location.hash||'').replace('#','');
            const saved = localStorage.getItem('cp.tab');
            if (['pools','accounts','analytics'].includes(h)) this.tab = h;
            else if (['pools','accounts','analytics'].includes(saved)) this.tab = saved;
            this.$watch('tab', t => { history.replaceState(null,'','#'+t); localStorage.setItem('cp.tab', t); });
          },
          onKey(ev){
            // Paging shortcuts on pools blocks view
            if (this.tab==='pools') {
              const poolsCmp = this.$root.__x?.$data?.tab==='pools' ? this.$root.querySelector('section[x-data]')?.__x?.$data : null;
              if (!poolsCmp) return;
              if (ev.key==='j') { poolsCmp.nextPage?.(); }
              if (ev.key==='k') { poolsCmp.prevPage?.(); }
              if (ev.key==='g' && !ev.shiftKey) { poolsCmp.firstPage?.(); }
              if (ev.key==='G') { poolsCmp.lastPage?.(); }
            }
          }
        }
      }
      function toaster(){
        return {
          toasts: [],
          init(){
            window.showToast = (message, type='info') => {
              window.dispatchEvent(new CustomEvent('toast', { detail: { message, type } }));
            };
            window.addEventListener('toast', (e) => {
              const id = Math.random().toString(36).slice(2);
              const t = { id, message: e.detail.message, type: e.detail.type || 'info' };
              this.toasts.push(t);
              setTimeout(() => { this.toasts = this.toasts.filter(x => x.id !== id); }, 3000);
            });
          }
        }
      }
      </script>
      <script>
      // Compute IPv4 network and broadcast for a CIDR (e.g., 10.0.1.0/24)
      function deriveIPv4Range(cidr) {
        if (!cidr || typeof cidr !== 'string' || !cidr.includes('/')) return null;
        const [ipStr, prefixStr] = cidr.split('/');
        const oct = ipStr.split('.').map(n => parseInt(n, 10));
        const p = parseInt(prefixStr, 10);
        if (oct.length !== 4 || oct.some(n => isNaN(n) || n < 0 || n > 255)) return null;
        if (isNaN(p) || p < 0 || p > 32) return null;
        const toInt = (a,b,c,d) => ((a<<24)>>>0) + (b<<16) + (c<<8) + d;
        const toStr = (x) => [ (x>>>24)&255, (x>>>16)&255, (x>>>8)&255, x&255 ].join('.');
        const ip = toInt(oct[0],oct[1],oct[2],oct[3])>>>0;
        const mask = (p === 0) ? 0 : (~((1<<(32-p)) - 1))>>>0; // network mask
        const network = (ip & mask) >>> 0;
        const broadcast = (network | (~mask >>> 0)) >>> 0;
        return { network: toStr(network), broadcast: toStr(broadcast) };
      }
      function ipToInt(ipStr){
        const oct = (ipStr||'').split('.').map(n=>parseInt(n,10));
        if (oct.length!==4 || oct.some(n=>isNaN(n)||n<0||n>255)) return null;
        return ((oct[0]<<24)>>>0) + (oct[1]<<16) + (oct[2]<<8) + oct[3];
      }
      function prefixRange(cidr){
        if (!cidr || typeof cidr !== 'string' || !cidr.includes('/')) return null;
        const [ipStr, prefixStr] = cidr.split('/');
        const base = ipToInt(ipStr); const p = parseInt(prefixStr,10);
        if (base==null || isNaN(p) || p<0 || p>32) return null;
        const mask = (p===0) ? 0 : (~((1<<(32-p)) - 1))>>>0;
        const start = (base & mask)>>>0;
        const end = (start | (~mask>>>0))>>>0;
        return { start, end };
      }
      function pools() {
        return {
          list: [],
          topLevel: [],
          accounts: [],
          form: { name: '', cidr: '', account_id: null},
          msg: '',
          cidrError: '',
          creating: false,
          showCreateForm: false,
          selectedTop: [],
          bulkOpen: false,
          current: null,
          currentAccountId: null,
          updateMsg: '',
          editPoolOpen: false,
          editPoolForm: { id: null, name: '', account_id: null },
          bulkAssignTopOpen: false,
          bulkDeleteTopOpen: false,
          bulkAccountId: null,
          bulkCascade: false,
          confirmBulkDelete: false,
          deletePoolOpen: false,
          deletePoolTarget: null,
          deletePoolChildren: [],
          deletePoolCascade: false,
          confirmPoolDelete: false,
          blockPrefix: 24,
          currentPrefixBits: null,
          search: '',
          blocks: [],
          rawBlocks: [],
          loadingBlocks: false,
          creatingSub: false,
          showOnlyUsed: false,
          hideUnavailable: false,
          blockFilters: { hosts:'', status:'', account:'', network:'', broadcast:'' },
          subMsg: '',
          vizSearch: '',
          vizAccounts: [],
          vizSegments: [],
          pageSize: '50',
          page: 1,
          pageInput: 1,
          total: 0,
          totalPages: 1,
          fromItem: 0,
          toItem: 0,
          sortTopKey: 'created',
          sortTopDir: 'desc',
          sortBlockKey: 'cidr',
          sortBlockDir: 'asc',
          async init() {
            await Promise.all([this.fetchAccounts(), this.fetchList()]);
            // restore persisted state
            const pfx = localStorage.getItem('cp.pool.blockPrefix'); if (pfx) this.blockPrefix = parseInt(pfx,10)||this.blockPrefix;
            const psz = localStorage.getItem('cp.pool.pageSize'); if (psz) this.pageSize = psz;
            const curId = localStorage.getItem('cp.pool.currentId');
            if (curId) { const p = this.list.find(x=>String(x.id)===curId); if (p) this.selectPool(p); }
            const only = localStorage.getItem('cp.pool.showOnlyUsed'); if (only) this.showOnlyUsed = only==='1';
            const hide = localStorage.getItem('cp.pool.hideUnavailable'); if (hide) this.hideUnavailable = hide==='1';
          },
          async fetchAccounts() {
            try {
              const res = await fetch('/api/v1/accounts');
              this.accounts = await res.json();
            } catch (e) {
              // ignore
            }
          },
          async fetchList() {
            try {
              const res = await fetch('/api/v1/pools');
              this.list = await res.json();
              this.topLevel = this.list.filter(p => !p.parent_id);
              // prune selections no longer present
              const ids = new Set(this.topLevel.map(p=>p.id));
              this.selectedTop = this.selectedTop.filter(id=>ids.has(id));
            } catch (e) {
              this.msg = 'Failed to load pools';
            }
          },
          toggleSelectTop(id){ const i=this.selectedTop.indexOf(id); if(i>=0) this.selectedTop.splice(i,1); else this.selectedTop.push(id); },
          toggleSelectAllTop(ev){ if (ev.target.checked){ this.selectedTop = this.topLevel.map(p=>p.id); } else { this.selectedTop = []; } },
          allTopSelected(){ return this.topLevel.length>0 && this.selectedTop.length===this.topLevel.length; },
          indeterminateTop(){ return this.selectedTop.length>0 && this.selectedTop.length<this.topLevel.length; },
          sortedTop(){
            const q = (this.search||'').toLowerCase();
            let arr = this.topLevel.filter(p => !q || (String(p.id).includes(q) || (p.name||'').toLowerCase().includes(q) || (p.cidr||'').toLowerCase().includes(q) || (this.accountName(p.account_id)||'').toLowerCase().includes(q)));
            const key = this.sortTopKey, dir = this.sortTopDir==='asc'?1:-1;
            const get = (p)=> key==='id'? p.id : key==='name'? (p.name||'') : key==='cidr'? (p.cidr||'') : key==='account'? (this.accountName(p.account_id)||'') : (p.created_at||'');
            arr.sort((a,b)=> { const av=get(a), bv=get(b); return av>bv?dir: av<bv? -dir: 0; });
            return arr;
          },
          sortTop(k){ this.sortTopDir = (this.sortTopKey===k && this.sortTopDir==='asc') ? 'desc' : 'asc'; this.sortTopKey = k; },
          openBulkAssignTop(){ this.bulkAssignTopOpen=true; this.bulkAccountId=null; },
          async performBulkAssignTop(){
            const target = this.bulkAccountId ?? null;
            for (const id of this.selectedTop){
              try { await fetch(`/api/v1/pools/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ account_id: target }) }); } catch {}
            }
            this.bulkAssignTopOpen=false; await this.fetchList(); if(this.current){ const cur = this.list.find(x=>x.id===this.current.id); if(cur) this.current=cur; }
            showToast('Assigned account to selected');
          },
          openBulkDeleteTop(){ this.bulkDeleteTopOpen=true; this.bulkCascade=false; this.confirmBulkDelete=false; },
          async performBulkDeleteTop(){
            for (const id of this.selectedTop){
              const force = this.bulkCascade ? '&force=1' : '';
              try { await fetch(`/api/v1/pools/${id}${force}`, { method:'DELETE' }); } catch {}
            }
            this.bulkDeleteTopOpen=false; this.selectedTop=[]; await this.fetchList(); if (this.current && !this.list.find(x=>x.id===this.current.id)) this.current=null;
            showToast('Deleted selected pools');
          },
          accountName(id) {
            if (!id) return '-';
            const a = this.accounts.find(a => a.id === id);
            return a ? a.name : `#${id}`;
          },
          selectPool(p) { this.current = p; localStorage.setItem('cp.pool.currentId', String(p.id)); this.currentAccountId = p.account_id || null; this.blocks = []; this.subMsg=''; this.page=1; this.pageInput=1; this.total=0; this.totalPages=1; this.updateMsg=''; this.currentPrefixBits = this.cidrBits(p.cidr); if (this.currentPrefixBits!=null && (this.blockPrefix <= this.currentPrefixBits)) { this.blockPrefix = Math.min(32, this.currentPrefixBits+1); } this.computeViz(); },
          openEditPool(p) { this.editPoolForm = { id: p.id, name: p.name, account_id: p.account_id||null }; this.editPoolOpen = true; },
          async saveEditPool() {
            const f = this.editPoolForm;
            try {
              const res = await fetch(`/api/v1/pools/${f.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: f.name, account_id: f.account_id }) });
              if (!res.ok) { this.msg = await parseError(res); showToast(this.msg,'error'); return; }
              const updated = await res.json();
              const idx = this.list.findIndex(x => x.id === updated.id);
              if (idx >= 0) this.list[idx] = updated;
              if (this.current && this.current.id === updated.id) this.current = updated;
              this.editPoolOpen = false;
              showToast('Pool updated');
            } catch (e) { this.msg = 'Update failed'; }
          },
          confirmDeletePool(p) {
            this.deletePoolTarget = p; this.deletePoolCascade = false; this.confirmPoolDelete = false;
            // Build descendant list from this.list
            const byParent = new Map();
            for (const x of this.list) { if (x.parent_id) { const arr = byParent.get(x.parent_id) || []; arr.push(x); byParent.set(x.parent_id, arr); } }
            const out = [];
            const stack = [p.id];
            while (stack.length) {
              const id = stack.pop();
              const children = byParent.get(id) || [];
              for (const c of children) { out.push(c); stack.push(c.id); }
            }
            this.deletePoolChildren = out;
            this.deletePoolOpen = true;
          },
          async performDeletePool() {
            const p = this.deletePoolTarget; if (!p) return;
            try {
              const force = this.deletePoolCascade ? '&force=1' : '';
              const res = await fetch(`/api/v1/pools/${p.id}${force}`, { method:'DELETE' });
              if (!res.ok) { this.msg = await parseError(res); showToast(this.msg,'error'); return; }
              await this.fetchList(); if (this.current && this.current.id===p.id) this.current=null; this.deletePoolOpen=false;
              showToast('Pool deleted');
            } catch (e) { this.msg='Delete failed'; }
          },
          onPageSize() { this.page = 1; localStorage.setItem('cp.pool.pageSize', this.pageSize); this.loadBlocks(); },
          onBlockPrefixChange(){ if (this.currentPrefixBits!=null && this.blockPrefix <= this.currentPrefixBits) this.blockPrefix = Math.min(32, this.currentPrefixBits+1); localStorage.setItem('cp.pool.blockPrefix', String(this.blockPrefix)); },
          async loadBlocks() {
            if (!this.current) return;
            this.subMsg = '';
            try {
              this.loadingBlocks = true;
              const q = new URLSearchParams();
              q.set('new_prefix_len', this.blockPrefix);
              if (this.pageSize !== 'all') { q.set('page_size', this.pageSize); q.set('page', this.page); }
              else { q.set('page_size', 'all'); }
              const res = await fetch(`/api/v1/pools/${this.current.id}/blocks?${q.toString()}`);
              if (!res.ok) { this.subMsg = await parseError(res); showToast(this.subMsg,'error'); return; }
              const data = await res.json();
              if (Array.isArray(data)) {
                // Back-compat (shouldn't happen with new server)
                this.rawBlocks = this.withDerivedIPs(data);
                this.filterBlocks();
                this.total = data.length;
                this.totalPages = 1;
                this.fromItem = data.length ? 1 : 0;
                this.toItem = data.length;
              } else {
                this.rawBlocks = this.withDerivedIPs(data.items || []);
                this.total = data.total || 0;
                const pageSizeNum = this.pageSize === 'all' ? this.total : parseInt(this.pageSize, 10);
                this.totalPages = pageSizeNum > 0 ? Math.max(1, Math.ceil(this.total / pageSizeNum)) : 1;
                const startIdx = this.total === 0 ? 0 : ((this.page - 1) * (pageSizeNum || this.total)) + 1;
                const endIdx = this.total === 0 ? 0 : Math.min(this.total, (this.page - 1) * (pageSizeNum || this.total) + this.rawBlocks.length);
                this.fromItem = startIdx;
                this.toItem = endIdx;
                this.pageInput = this.page;
                this.filterBlocks();
              }
            } catch (e) { this.subMsg = 'Failed to load blocks'; }
            finally { this.loadingBlocks = false; }
          },
          filterBlocks() {
            const f = this.blockFilters;
            const normalize = (v) => (v ?? '').toString().toLowerCase();
            const hostsMatch = (b) => !f.hosts || normalize(b.hosts).includes(normalize(f.hosts));
            const statusStr = (b) => b.used ? 'used' : (this.blockUnavailable(b.cidr) ? 'unavailable' : 'free');
            const statusMatch = (b) => !f.status || statusStr(b).includes(normalize(f.status));
            const acct = (b) => (b.assigned_account_name || this.accountName(b.assigned_account_id) || '-');
            const accountMatch = (b) => !f.account || normalize(acct(b)).includes(normalize(f.account));
            const networkMatch = (b) => !f.network || normalize(b.network_ip || '').includes(normalize(f.network));
            const broadcastMatch = (b) => !f.broadcast || normalize(b.broadcast_ip || '').includes(normalize(f.broadcast));
            let arr = this.rawBlocks;
            if (this.showOnlyUsed) arr = arr.filter(b => b.used);
            if (this.hideUnavailable) arr = arr.filter(b => !(b.used || this.blockUnavailable(b.cidr)));
            localStorage.setItem('cp.pool.showOnlyUsed', this.showOnlyUsed?'1':'0');
            localStorage.setItem('cp.pool.hideUnavailable', this.hideUnavailable?'1':'0');
            arr = arr.filter(b => hostsMatch(b) && statusMatch(b) && accountMatch(b) && networkMatch(b) && broadcastMatch(b));
            // sorting
            const key = this.sortBlockKey, dir = this.sortBlockDir==='asc'?1:-1;
            const statusVal = (b)=> b.used?2 : (this.blockUnavailable(b.cidr)?1:0);
            const get = (b)=> key==='cidr'? (b.cidr||'') : key==='hosts'? (b.hosts||0) : key==='status'? statusVal(b) : key==='account'? (acct(b)||'') : (b.cidr||'');
            arr.sort((a,b)=> { const av=get(a), bv=get(b); return av>bv?dir: av<bv? -dir: 0; });
            this.blocks = arr;
          },
          sortBlocks(k){ this.sortBlockDir = (this.sortBlockKey===k && this.sortBlockDir==='asc') ? 'desc' : 'asc'; this.sortBlockKey = k; this.filterBlocks(); },
          copy(text){ if (!text) return; navigator.clipboard?.writeText(String(text)).then(()=>showToast('Copied')).catch(()=>{}); },
          blockUnavailable(cidr) {
            if (!this.current || !cidr) return false;
            // A block is unavailable if it overlaps any existing direct child of current
            const children = this.list.filter(p => p.parent_id === this.current.id);
            const br = prefixRange(cidr); if (!br) return false;
            for (const c of children) {
              if (c.cidr === cidr) return true; // exact match occupied
              const cr = prefixRange(c.cidr); if (!cr) continue;
              // intervals overlap if not disjoint
              if (!(br.end < cr.start || cr.end < br.start)) return true;
            }
            return false;
          },
          blockUnavailableReason(cidr) {
            if (!this.current || !cidr) return '';
            const children = this.list.filter(p => p.parent_id === this.current.id);
            const br = prefixRange(cidr); if (!br) return '';
            for (const c of children) {
              const cr = prefixRange(c.cidr); if (!cr) continue;
              if (c.cidr === cidr || !(br.end < cr.start || cr.end < br.start)) {
                const nm = c.name ? `\"${c.name}\"` : `#${c.id}`;
                return `Overlaps existing child ${nm} (${c.cidr})`;
              }
            }
            return '';
          },
          withDerivedIPs(items) {
            const out = [];
            for (const it of (items||[])) {
              const cidr = it.cidr;
              const derived = deriveIPv4Range(cidr);
              out.push({ ...it, network_ip: derived?.network || null, broadcast_ip: derived?.broadcast || null });
            }
            return out;
          },
          async prevPage() { if (this.page > 1) { this.page--; await this.loadBlocks(); } },
          async nextPage() { if (this.page < this.totalPages) { this.page++; await this.loadBlocks(); } },
          async firstPage() { if (this.page !== 1) { this.page = 1; await this.loadBlocks(); } },
          async lastPage() { if (this.page !== this.totalPages) { this.page = this.totalPages; await this.loadBlocks(); } },
          async goToPage() {
            if (this.pageSize === 'all') return;
            let target = parseInt(this.pageInput, 10);
            if (!target || target < 1) target = 1;
            if (target > this.totalPages) target = this.totalPages;
            if (target === this.page) return;
            this.page = target;
            await this.loadBlocks();
          },
          validateCIDR() {
            const c = (this.form?.cidr || '').trim();
            this.cidrError = '';
            if (!c) { this.cidrError = 'CIDR is required'; return; }
            const pr = prefixRange(c);
            if (!pr) { this.cidrError = 'Invalid CIDR (use e.g., 10.0.0.0/16)'; return; }
            // Ensure the IP is aligned to the network address for the prefix
            const [ipStr] = c.split('/');
            const base = ipToInt(ipStr);
            if (base == null) { this.cidrError = 'Invalid IPv4 address'; return; }
            if (base !== pr.start) { this.cidrError = 'CIDR must start at network address'; return; }
          },
          async createTop() {
            this.msg = '';
            this.validateCIDR(); if (this.cidrError) { showToast(this.cidrError,'error'); return; }
            try {
              this.creating = true;
              const res = await fetch('/api/v1/pools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.form)
              });
              if (!res.ok) { this.msg = await parseError(res); showToast(this.msg, 'error'); return; }
              this.form = { name: '', cidr: '', account_id: null };
              await Promise.all([this.fetchList(), this.fetchAccounts()]);
              this.msg = 'Created';
              showToast('Pool created');
            } catch (e) {
              this.msg = 'Network error';
              showToast(this.msg, 'error');
            } finally { this.creating = false; }
          },
          async updateCurrentPoolAccount() {
            if (!this.current) return;
            this.updateMsg = '';
            try {
              const res = await fetch(`/api/v1/pools/${this.current.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ account_id: this.currentAccountId ?? null })
              });
              if (!res.ok) { this.updateMsg = await parseError(res); showToast(this.updateMsg,'error'); return; }
              const p = await res.json();
              // Update current and list
              this.current = p;
              const idx = this.list.findIndex(x => x.id === p.id);
              if (idx >= 0) this.list[idx] = p;
              await this.loadBlocks();
              this.updateMsg = 'Updated';
              this.computeViz();
            } catch (e) { this.updateMsg = 'Update failed'; }
          },
          cidrBits(cidr){ if (!cidr) return null; const i = cidr.indexOf('/'); if (i<0) return null; const b = parseInt(cidr.slice(i+1),10); return isNaN(b)?null:b; },
          computeViz() {
            if (!this.current) { this.vizSegments = []; return; }
            const curRange = prefixRange(this.current.cidr);
            if (!curRange) { this.vizSegments = []; return; }
            const base = curRange.start, total = (curRange.end - curRange.start + 1)>>>0;
            const q = (this.vizSearch||'').toLowerCase();
            const selected = this.vizAccounts || [];
            const segs = [];
            for (const p of this.list) {
              if (!p || p.id === this.current.id) continue;
              const pr = prefixRange(p.cidr);
              if (!pr) continue;
              if (!(pr.start >= base && pr.end <= curRange.end)) continue;
              if (selected.length) {
                const aid = p.account_id != null ? String(p.account_id) : '';
                if (!selected.includes(aid)) continue;
              }
              if (q) {
                const hay = ((p.name||'')+' '+(p.cidr||'')).toLowerCase();
                if (!hay.includes(q)) continue;
              }
              const left = ((pr.start - base) / total) * 100;
              const width = (Math.max(1, (pr.end - pr.start + 1)) / total) * 100;
              const color = this.colorForAccount(p.account_id);
              segs.push({ id:p.id, left, width, title:`${p.name||'-'} (${p.cidr})`, color });
            }
            this.vizSegments = segs;
          },
          vizLegend(){
            const ids = new Set();
            for (const p of this.list) { if (p.parent_id && this.current && p.cidr && prefixRange(p.cidr)) { if (this.current && prefixRange(this.current.cidr)) { const pr = prefixRange(p.cidr), cr = prefixRange(this.current.cidr); if (pr && cr && pr.start>=cr.start && pr.end<=cr.end) { if (p.account_id!=null) ids.add(String(p.account_id)); } } } }
            const out = [];
            for (const id of ids) {
              const a = this.accounts.find(x=>String(x.id)===id);
              out.push({ key: id, label: a? a.name : ('#'+id), color: this.colorForAccount(parseInt(id,10)) });
            }
            return out.sort((a,b)=> a.label.localeCompare(b.label));
          },
          toggleVizChip(key){ const i=this.vizAccounts.indexOf(key); if(i>=0) this.vizAccounts.splice(i,1); else this.vizAccounts.push(key); this.computeViz(); },
          vizSelectAll(){ this.vizAccounts = this.accounts.map(a=>String(a.id)); this.computeViz(); },
          vizClearAll(){ this.vizAccounts = []; this.computeViz(); },
          colorForAccount(id){
            if (!id) return '#93c5fd';
            const colors = ['#93c5fd','#86efac','#fca5a5','#fbbf24','#a5b4fc','#67e8f9','#f9a8d4','#c4b5fd'];
            const i = Math.abs(parseInt(id,10)||0) % colors.length;
            return colors[i];
          },
          // Master toggle for viz accounts multi-select
          vizAllSelected(){ return this.accounts.length>0 && this.vizAccounts.length===this.accounts.length; },
          vizIndeterminate(){ return this.vizAccounts.length>0 && this.vizAccounts.length<this.accounts.length; },
          toggleVizAll(ev){ if (ev.target.checked) { this.vizAccounts = this.accounts.map(a=>String(a.id)); } else { this.vizAccounts = []; } this.computeViz(); },
          async createSub(b) {
            if (!this.current) return;
            const name = prompt(`Name for sub-pool ${b.cidr}`);
            if (!name) return;
            const accountId = this.form.account_id || null;
            try {
              const res = await fetch('/api/v1/pools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, cidr: b.cidr, parent_id: this.current.id, account_id: accountId })
              });
              if (!res.ok) { this.subMsg = await parseError(res); showToast(this.subMsg,'error'); return; }
              await this.fetchList();
              await this.loadBlocks(); this.computeViz(); showToast('Sub-pool created');
              this.subMsg = 'Sub-pool created';
            } catch (e) {
              this.subMsg = 'Network error creating sub-pool';
            }
          },
          selectPoolById(id) {
            const p = this.list.find(p => p.id === id);
            if (p) this.selectPool(p);
          }
        }
      }
    </script>
    <!-- Data Import/Export Modal Root -->
    <div id="data-io-root" x-data="dataIO()" x-init="init()" x-show="open" x-cloak @open-data-io.window="open=true" @click.self="open=false" @keydown.escape.window="open && (open=false)" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:10020;">
      <div class="card" style="width: 960px; max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="card-header">
          <div>
            <h3 class="card-title">Data Import / Export</h3>
            <p class="text-sm muted" style="margin: 0;">Transfer data between CloudPAM and external systems</p>
          </div>
          <button class="btn ghost btn-sm" @click="open=false">Ã—</button>
        </div>
        <div class="card-body" style="overflow-y: auto; flex: 1;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Export Section -->
            <div>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <h4 style="margin: 0; font-size: 16px;">Export Data</h4>
              </div>

              <!-- Accounts Export -->
              <div style="background: var(--border-light); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-bottom: 0.75rem;">
                  <input type="checkbox" x-model="exp.accounts" />
                  <span>Accounts</span>
                  <span class="badge badge-muted" x-text="Object.keys(expFields.accounts).filter(f => expFields.accounts[f]).length + ' fields'"></span>
                </label>
                <div x-show="exp.accounts" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem 1rem; margin-left: 1.5rem;">
                  <template x-for="f in fieldsList('accounts')" :key="'acc-'+f">
                    <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 13px;">
                      <input type="checkbox" x-model="expFields.accounts[f]" />
                      <span x-text="f"></span>
                    </label>
                  </template>
                </div>
              </div>

              <!-- Pools Export -->
              <div style="background: var(--border-light); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-bottom: 0.75rem;">
                  <input type="checkbox" x-model="exp.pools" />
                  <span>Pools</span>
                  <span class="badge badge-muted" x-text="Object.keys(expFields.pools).filter(f => expFields.pools[f]).length + ' fields'"></span>
                </label>
                <div x-show="exp.pools" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem 1rem; margin-left: 1.5rem;">
                  <template x-for="f in fieldsList('pools')" :key="'pool-'+f">
                    <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 13px;">
                      <input type="checkbox" x-model="expFields.pools[f]" />
                      <span x-text="f"></span>
                    </label>
                  </template>
                </div>
              </div>

              <!-- Blocks Export -->
              <div style="background: var(--border-light); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-bottom: 0.75rem;">
                  <input type="checkbox" x-model="exp.blocks" />
                  <span>Blocks</span>
                  <span class="badge badge-muted" x-text="Object.keys(expFields.blocks).filter(f => expFields.blocks[f]).length + ' fields'"></span>
                </label>
                <div x-show="exp.blocks" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem 1rem; margin-left: 1.5rem;">
                  <template x-for="f in fieldsList('blocks')" :key="'blk-'+f">
                    <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 13px;">
                      <input type="checkbox" x-model="expFields.blocks[f]" />
                      <span x-text="f"></span>
                    </label>
                  </template>
                </div>
              </div>

              <button class="btn" @click="downloadExport()" :disabled="!exp.accounts && !exp.pools && !exp.blocks">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download ZIP
              </button>
            </div>

            <!-- Import Section -->
            <div>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <h4 style="margin: 0; font-size: 16px;">Import Data</h4>
              </div>

              <div style="background: var(--border-light); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                <div class="form-group" style="margin-bottom: 1rem;">
                  <label class="form-label">Data Type</label>
                  <select x-model="imp.type" @change="autoMapHeaders()" style="width: 100%;">
                    <option value="accounts">Accounts</option>
                    <option value="pools">Pools</option>
                    <option value="blocks">Blocks</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">CSV File</label>
                  <div style="border: 2px dashed var(--border); border-radius: var(--radius); padding: 1.5rem; text-align: center; background: var(--card);">
                    <input type="file" accept=".csv,text/csv" @change="onImportFile($event)" style="display: none;" x-ref="fileInput" />
                    <button class="btn btn-secondary" @click="$refs.fileInput.click()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Choose File
                    </button>
                    <p class="text-sm muted" style="margin: 0.5rem 0 0 0;">or drag and drop a CSV file</p>
                  </div>
                </div>
              </div>

              <!-- Import Details (shown after file selection) -->
              <div x-show="imp.headers.length">
                <!-- Column Mapping Status -->
                <div style="border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 500;">Column Mapping</span>
                    <button class="btn ghost btn-sm" @click="imp.showUnmappedModal=true">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                      Adjust
                    </button>
                  </div>
                  <div style="display: flex; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                      <span class="badge badge-success" x-text="getMappedColumns().length"></span>
                      <span class="text-sm">mapped</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                      <span class="badge" :class="imp.unmapped.length > 0 ? 'badge-warning' : 'badge-muted'" x-text="imp.unmapped.length"></span>
                      <span class="text-sm">unmapped</span>
                    </div>
                  </div>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                  <button class="btn" @click="startImport()" :disabled="getMappedColumns().length === 0">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Start Import
                  </button>
                  <span x-text="msg" class="muted text-sm" style="display: flex; align-items: center;"></span>
                </div>

                <!-- Preview -->
                <div style="margin-bottom: 1rem;">
                  <div class="form-label" style="margin-bottom: 0.5rem;">Preview (first 5 rows)</div>
                  <div class="table-wrapper" style="max-height: 180px; border: 1px solid var(--border); border-radius: var(--radius);">
                    <table style="font-size: 12px;">
                      <thead>
                        <tr>
                          <template x-for="h in imp.headers" :key="'ph-'+h">
                            <th style="padding: 0.5rem; white-space: nowrap;" x-text="h"></th>
                          </template>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="r in imp.preview" :key="r.join('-')">
                          <tr>
                            <template x-for="(c,i) in r" :key="i">
                              <td style="padding: 0.5rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="c"></td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Logs -->
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span class="form-label" style="margin: 0;">Import Log</span>
                    <button class="btn ghost btn-sm" @click="downloadLog()" :disabled="!imp.logs.length">Download</button>
                  </div>
                  <pre style="white-space: pre-wrap; background: var(--border-light); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; max-height: 120px; overflow: auto; font-size: 12px; margin: 0;" x-text="imp.logs.length ? imp.logs.join('\n') : 'No logs yet'"></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Column Mapping Review Modal -->
      <div x-show="imp.showUnmappedModal" x-cloak @click.self="closeUnmappedModal()" @keydown.escape.window="imp.showUnmappedModal && closeUnmappedModal()" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:10030;">
        <div class="card" style="width: 600px; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
          <div class="card-header">
            <h3 class="card-title">Column Mapping</h3>
            <button class="btn ghost btn-sm" @click="closeUnmappedModal()">Ã—</button>
          </div>
          <div class="card-body" style="overflow-y: auto;">
            <!-- Mapped columns -->
            <div x-show="getMappedColumns().length > 0" style="margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <span style="font-weight: 500; color: var(--success);">Mapped Columns (<span x-text="getMappedColumns().length"></span>)</span>
              </div>
              <div style="background: var(--success-light); border: 1px solid var(--success); border-radius: var(--radius); padding: 0.75rem;">
                <template x-for="m in getMappedColumns()" :key="'mapped-'+m.header">
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.375rem 0; font-size: 13px;">
                    <span style="color: var(--text-secondary);" x-text="m.header"></span>
                    <span style="color: var(--success); padding: 0 0.5rem;">â†’</span>
                    <code style="background: var(--card); padding: 0.125rem 0.5rem; border-radius: var(--radius); font-size: 12px;" x-text="m.field"></code>
                  </div>
                </template>
              </div>
            </div>

            <!-- Unmapped columns -->
            <div x-show="imp.unmapped.length > 0">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span style="font-weight: 500; color: var(--warning);">Unmapped Columns (<span x-text="imp.unmapped.length"></span>)</span>
              </div>
              <p class="text-sm muted" style="margin-bottom: 0.75rem;">Select a target field or leave as "(ignore)" to skip:</p>
              <div style="background: var(--warning-light); border: 1px solid var(--warning); border-radius: var(--radius); padding: 0.75rem;">
                <template x-for="col in imp.unmapped" :key="'unmapped-map-'+col">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <div style="flex: 1; font-size: 13px; color: var(--text-secondary);" x-text="col"></div>
                    <select x-model="imp.mapping[col]" @change="checkUnmappedColumns()" style="flex: 1; font-size: 13px;">
                      <option value="">(ignore)</option>
                      <template x-for="f in getAvailableFields()" :key="'field-opt-'+f">
                        <option :value="f" x-text="f"></option>
                      </template>
                    </select>
                  </div>
                </template>
              </div>
            </div>

            <div x-show="imp.unmapped.length === 0 && getMappedColumns().length > 0" style="margin-top: 1rem; text-align: center;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="margin-bottom: 0.5rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <p style="color: var(--success); font-weight: 500; margin: 0;">All columns mapped successfully!</p>
            </div>

            <div class="row" style="justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
              <button class="btn btn-secondary" @click="closeUnmappedModal()">Cancel</button>
              <button class="btn" @click="applyUnmappedChanges()">Apply Mapping</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
