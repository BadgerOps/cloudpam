<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CloudPAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      [x-cloak] { display: none !important; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
      .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
      .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
      .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
      .spinner { width:14px; height:14px; border:2px solid #c7d2fe; border-top-color:#4f46e5; border-radius:50%; display:inline-block; animation: spin .7s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <!-- Sentry Browser SDK -->
    <script src="https://browser.sentry-cdn.com/8.0.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
      (function initSentry() {
        const sentryDSN = document.querySelector('meta[name="sentry-dsn"]')?.content;
        if (!sentryDSN || !window.Sentry) return;
        try {
          window.Sentry.init({
            dsn: sentryDSN,
            integrations: [window.Sentry.browserTracingIntegration(), window.Sentry.replayIntegration({ maskAllText: false, blockAllMedia: false })],
            tracesSampleRate: 1.0,
            replaysSessionSampleRate: 0.1,
            replaysOnErrorSampleRate: 1.0,
          });
        } catch (err) { console.error('Failed to initialize Sentry:', err); }
      })();
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <!-- Toast Container -->
    <div x-data="toaster()" x-init="init()" class="fixed right-4 bottom-4 flex flex-col gap-2 z-50">
      <template x-for="t in toasts" :key="t.id">
        <div :class="'bg-white border rounded-lg shadow-lg px-4 py-3 min-w-60 ' + (t.type==='error' ? 'border-red-200' : 'border-blue-200')">
          <div class="font-medium text-sm" x-text="t.type==='error'?'Error':'Info'"></div>
          <div class="text-sm text-gray-600" x-text="t.message"></div>
        </div>
      </template>
    </div>

    <!-- Main App -->
    <div x-data="app()" x-init="init()" class="h-screen flex">
      <!-- Sidebar -->
      <aside class="w-64 bg-gray-900 text-white flex flex-col flex-shrink-0">
        <div class="p-4 border-b border-gray-800">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-600 rounded-lg">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
            </div>
            <div>
              <h1 class="font-bold text-lg">CloudPAM</h1>
              <p class="text-xs text-gray-400">IP Address Management</p>
            </div>
          </div>
        </div>

        <nav class="flex-1 p-4 space-y-1">
          <button @click="tab='dashboard'" :class="'w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ' + (tab==='dashboard' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
            <span>Dashboard</span>
          </button>
          <button @click="tab='pools'" :class="'w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ' + (tab==='pools' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>
            <span>Address Pools</span>
          </button>
          <button @click="tab='accounts'" :class="'w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ' + (tab==='accounts' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
            <span>Cloud Accounts</span>
          </button>
          <button @click="tab='discovery'" :class="'w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ' + (tab==='discovery' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            <span>Discovery</span>
          </button>
          <button @click="tab='audit'" :class="'w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ' + (tab==='audit' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800')">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Audit Log</span>
          </button>
        </nav>

        <div class="p-4 border-t border-gray-800">
          <button @click="$dispatch('open-data-io')" class="w-full flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-800 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
            <span>Import/Export</span>
          </button>
          <button class="w-full flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-800 rounded-lg mt-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span>Settings</span>
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0">
          <div class="flex items-center gap-4 flex-1">
            <div class="relative w-96">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
              <input type="text" x-model="searchQuery" placeholder="Search pools, CIDRs, accounts..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
            </div>
          </div>
          <div class="flex items-center gap-4">
            <button class="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
              <span x-show="alerts.length > 0" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <div class="flex items-center gap-2 pl-4 border-l border-gray-200">
              <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
              </div>
              <span class="text-sm font-medium text-gray-700">Admin</span>
            </div>
          </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-hidden flex">
          <!-- Dashboard View -->
          <template x-if="tab==='dashboard'">
            <div class="flex-1 overflow-auto p-6 space-y-6">
              <!-- Stats Row -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-white rounded-xl border border-gray-200 p-5">
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-sm text-gray-500">Total Pools</p>
                      <p class="text-2xl font-bold text-gray-900 mt-1" x-text="pools.length"></p>
                      <p class="text-xs text-gray-400 mt-1">Across all regions</p>
                    </div>
                    <div class="p-3 rounded-lg bg-blue-100 text-blue-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>
                    </div>
                  </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 p-5">
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-sm text-gray-500">Allocated IPs</p>
                      <p class="text-2xl font-bold text-gray-900 mt-1" x-text="formatHostCount(totalAllocatedIPs)"></p>
                      <p class="text-xs text-gray-400 mt-1" x-text="'of ' + formatHostCount(totalIPs) + ' total'"></p>
                    </div>
                    <div class="p-3 rounded-lg bg-green-100 text-green-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
                    </div>
                  </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 p-5">
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-sm text-gray-500">Cloud Accounts</p>
                      <p class="text-2xl font-bold text-gray-900 mt-1" x-text="accounts.length"></p>
                      <p class="text-xs text-gray-400 mt-1" x-text="accountsSummary"></p>
                    </div>
                    <div class="p-3 rounded-lg bg-purple-100 text-purple-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
                    </div>
                  </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 p-5">
                  <div class="flex items-start justify-between">
                    <div>
                      <p class="text-sm text-gray-500">Active Alerts</p>
                      <p class="text-2xl font-bold text-gray-900 mt-1" x-text="alerts.length"></p>
                      <p class="text-xs text-gray-400 mt-1" x-text="alertsSummary"></p>
                    </div>
                    <div class="p-3 rounded-lg bg-amber-100 text-amber-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Two Column Layout: Tree + Alerts -->
              <div class="grid grid-cols-3 gap-6">
                <!-- Address Space Tree -->
                <div class="col-span-2 bg-white rounded-xl border border-gray-200">
                  <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Address Space</h2>
                    <div class="flex items-center gap-2">
                      <button @click="expandAllNodes()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">Expand All</button>
                      <button @click="collapseAllNodes()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">Collapse All</button>
                      <button @click="tab='pools'; showCreateForm=true" class="flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Add Pool
                      </button>
                    </div>
                  </div>
                  <div class="p-4 max-h-96 overflow-auto scrollbar-thin">
                    <template x-for="pool in hierarchyTree" :key="pool.id">
                      <div x-data="{ open: expandedNodes.has(pool.id) }">
                        <div @click="selectPool(pool)" :class="'flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer transition-colors ' + (selectedPool?.id === pool.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-gray-50')">
                          <button @click.stop="toggleNode(pool.id)" class="p-0.5 hover:bg-gray-200 rounded">
                            <template x-if="pool.children && pool.children.length > 0">
                              <svg x-show="expandedNodes.has(pool.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </template>
                            <template x-if="pool.children && pool.children.length > 0">
                              <svg x-show="!expandedNodes.has(pool.id)" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </template>
                            <template x-if="!pool.children || pool.children.length === 0">
                              <div class="w-4"></div>
                            </template>
                          </button>
                          <div :class="'w-2.5 h-2.5 rounded-full ' + getPoolTypeColor(pool.type)"></div>
                          <span class="font-medium text-gray-900 flex-1" x-text="pool.name"></span>
                          <code class="text-xs bg-gray-100 px-2 py-0.5 rounded font-mono text-gray-600" x-text="pool.cidr"></code>
                          <span class="text-xs text-gray-400 w-16 text-right" x-text="formatHostCount(getHostCount(pool.cidr))"></span>
                          <template x-if="pool.utilization !== undefined">
                            <div class="w-20 flex items-center gap-1">
                              <div class="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                <div :class="'h-full rounded-full ' + getUtilizationColor(pool.utilization)" :style="'width: ' + pool.utilization + '%'"></div>
                              </div>
                              <span class="text-xs text-gray-500 w-8" x-text="pool.utilization + '%'"></span>
                            </div>
                          </template>
                          <template x-if="pool.status">
                            <span x-html="getStatusIcon(pool.status)"></span>
                          </template>
                          <template x-if="pool.source === 'discovered'">
                            <span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">cloud</span>
                          </template>
                        </div>
                        <!-- Children (recursive) -->
                        <template x-if="pool.children && pool.children.length > 0 && expandedNodes.has(pool.id)">
                          <div class="ml-6">
                            <template x-for="child in pool.children" :key="child.id">
                              <div x-data="treeNode(child)" x-init="initNode()"></div>
                            </template>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template x-if="hierarchyTree.length === 0">
                      <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" /></svg>
                        <p class="font-medium">No address pools yet</p>
                        <p class="text-sm">Create your first pool to get started</p>
                        <button @click="tab='pools'; showCreateForm=true" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Pool</button>
                      </div>
                    </template>
                  </div>
                  <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center gap-4">
                      <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-purple-500"></div> Root</span>
                      <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Region</span>
                      <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Environment</span>
                      <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-amber-500"></div> Account</span>
                    </div>
                  </div>
                </div>

                <!-- Alerts Panel -->
                <div class="bg-white rounded-xl border border-gray-200">
                  <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Alerts</h2>
                    <button class="text-sm text-blue-600 hover:underline">View All</button>
                  </div>
                  <div class="p-4 space-y-3 max-h-96 overflow-auto scrollbar-thin">
                    <template x-for="alert in alerts" :key="alert.id">
                      <div :class="'border-l-4 rounded-r-lg p-3 ' + getAlertColors(alert.severity)">
                        <div class="flex items-start gap-3">
                          <span x-html="getAlertIcon(alert.severity)"></span>
                          <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900" x-text="alert.title"></p>
                            <p class="text-sm text-gray-600 mt-0.5" x-text="alert.message"></p>
                            <p class="text-xs text-gray-400 mt-1" x-text="alert.time"></p>
                          </div>
                        </div>
                      </div>
                    </template>
                    <template x-if="alerts.length === 0">
                      <div class="text-center py-8 text-gray-500">
                        <svg class="w-10 h-10 mx-auto mb-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <p class="text-sm">No active alerts</p>
                      </div>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Cloud Accounts Table -->
              <div class="bg-white rounded-xl border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                  <h2 class="font-semibold text-gray-900">Cloud Accounts</h2>
                  <button @click="tab='accounts'; showCreateForm=true" class="flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    Add Account
                  </button>
                </div>
                <table class="w-full">
                  <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Provider</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tier</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Regions</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"></th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    <template x-for="account in accounts.slice(0, 5)" :key="account.id">
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                          <div class="flex items-center gap-2">
                            <span class="text-lg" x-text="getProviderEmoji(account.provider)"></span>
                            <div>
                              <p class="font-medium text-gray-900" x-text="account.name"></p>
                              <p class="text-xs text-gray-500" x-text="account.key"></p>
                            </div>
                          </div>
                        </td>
                        <td class="px-4 py-3">
                          <span :class="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getProviderBadgeClass(account.provider)" x-text="(account.provider || '').toUpperCase()"></span>
                        </td>
                        <td class="px-4 py-3">
                          <span x-show="account.tier" :class="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getTierBadgeClass(account.tier)" x-text="account.tier"></span>
                          <span x-show="!account.tier" class="text-gray-400">-</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                          <span x-show="account.regions && account.regions.length" x-text="account.regions.slice(0,2).join(', ') + (account.regions.length > 2 ? ' +' + (account.regions.length - 2) : '')"></span>
                          <span x-show="!account.regions || !account.regions.length" class="text-gray-400">-</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500" x-text="new Date(account.created_at).toLocaleDateString()"></td>
                        <td class="px-4 py-3">
                          <button @click="tab='accounts'" class="text-blue-600 hover:text-blue-700 text-sm">View</button>
                        </td>
                      </tr>
                    </template>
                    <template x-if="accounts.length === 0">
                      <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                          <p>No cloud accounts configured</p>
                          <button @click="tab='accounts'; showCreateForm=true" class="mt-2 text-blue-600 hover:underline">Add your first account</button>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
                <template x-if="accounts.length > 5">
                  <div class="px-4 py-3 border-t border-gray-200 bg-gray-50">
                    <button @click="tab='accounts'" class="text-sm text-blue-600 hover:underline">View all <span x-text="accounts.length"></span> accounts</button>
                  </div>
                </template>
              </div>

              <!-- Recent Activity -->
              <div class="bg-white rounded-xl border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                  <h2 class="font-semibold text-gray-900">Recent Activity</h2>
                  <button @click="tab='audit'" class="text-sm text-blue-600 hover:underline">View Audit Log</button>
                </div>
                <div class="p-4">
                  <div class="space-y-3">
                    <template x-for="activity in recentActivity" :key="activity.id">
                      <div class="flex items-center gap-3 text-sm">
                        <div :class="'w-2 h-2 rounded-full ' + getActivityColor(activity.action)"></div>
                        <span class="text-gray-600">
                          <span class="font-medium text-gray-900" x-text="activity.user"></span>
                          <span x-text="' ' + activity.action + ' '"></span>
                          <span class="font-medium" x-text="activity.entity"></span>
                          <span> "</span>
                          <code class="text-xs bg-gray-100 px-1 rounded" x-text="activity.name"></code>
                          <span>"</span>
                        </span>
                        <span class="text-gray-400 ml-auto" x-text="activity.time"></span>
                      </div>
                    </template>
                    <template x-if="recentActivity.length === 0">
                      <div class="text-center py-4 text-gray-500 text-sm">No recent activity</div>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <!-- Pools View -->
          <template x-if="tab==='pools'">
            <div class="flex-1 overflow-auto p-6" x-data="poolsView()" x-init="init()">
              <!-- Page Header -->
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 class="text-2xl font-semibold text-gray-900">IP Pools</h1>
                  <p class="text-gray-500">Manage your IP address pools and allocations</p>
                </div>
                <button @click="showCreateForm = !showCreateForm" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                  New Pool
                </button>
              </div>

              <!-- Create Form -->
              <div x-show="showCreateForm" x-cloak class="bg-white rounded-xl border border-gray-200 mb-6">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                  <h3 class="font-semibold">Create New Pool</h3>
                  <button @click="showCreateForm = false" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="p-4">
                  <div class="grid grid-cols-4 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                      <input type="text" x-model="form.name" placeholder="e.g., Production VPC" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">CIDR Block</label>
                      <input type="text" x-model="form.cidr" @blur="validateCIDR()" placeholder="e.g., 10.0.0.0/16" :class="'w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none ' + (cidrError ? 'border-red-500' : 'border-gray-300')" />
                      <p x-show="cidrError" class="text-red-500 text-xs mt-1" x-text="cidrError"></p>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Account (optional)</label>
                      <select x-model.number="form.account_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option :value="null">No Account</option>
                        <template x-for="a in $store.app.accounts" :key="a.id">
                          <option :value="a.id" x-text="a.name + (a.provider ? ' ('+a.provider+')' : '')"></option>
                        </template>
                      </select>
                    </div>
                    <div class="flex items-end">
                      <button @click="createPool()" :disabled="creating || !!cidrError" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="creating" class="spinner mr-2"></span>
                        <span x-text="creating ? 'Creating...' : 'Create Pool'"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pools Table -->
              <div class="bg-white rounded-xl border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center gap-4">
                  <input type="text" x-model="search" placeholder="Search pools..." class="flex-1 max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
                  <select x-model="pageSize" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                  </select>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CIDR</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"></th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      <template x-for="p in filteredPools()" :key="p.id">
                        <tr class="hover:bg-gray-50">
                          <td class="px-4 py-3 font-medium text-gray-900" x-text="p.name"></td>
                          <td class="px-4 py-3"><code class="text-sm bg-gray-100 px-2 py-0.5 rounded" x-text="p.cidr"></code></td>
                          <td class="px-4 py-3">
                            <span x-show="p.account_id" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700" x-text="accountName(p.account_id)"></span>
                            <span x-show="!p.account_id" class="text-gray-400">-</span>
                          </td>
                          <td class="px-4 py-3 text-sm text-gray-500" x-text="new Date(p.created_at).toLocaleDateString()"></td>
                          <td class="px-4 py-3">
                            <button @click="viewPool(p)" class="text-blue-600 hover:text-blue-700 text-sm font-medium">View</button>
                          </td>
                        </tr>
                      </template>
                      <template x-if="filteredPools().length === 0">
                        <tr>
                          <td colspan="5" class="px-4 py-12 text-center">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" /></svg>
                            <p class="text-gray-500 font-medium">No pools found</p>
                            <button @click="showCreateForm = true" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Pool</button>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Pool Detail Panel -->
              <template x-if="current">
                <div class="fixed inset-0 z-50">
                  <div class="absolute inset-0 bg-black/30" @click="current = null"></div>
                  <div class="absolute top-0 right-0 w-full max-w-2xl h-full bg-white shadow-xl flex flex-col">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center gap-4">
                      <button @click="current = null" class="p-1 text-gray-400 hover:text-gray-600 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                      </button>
                      <div class="flex-1">
                        <h2 class="text-xl font-semibold text-gray-900" x-text="current.name"></h2>
                        <code class="text-sm text-gray-500" x-text="current.cidr"></code>
                      </div>
                    </div>
                    <div class="flex-1 overflow-auto p-6">
                      <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                          <p class="text-xs text-gray-500 mb-1">Total IPs</p>
                          <p class="text-lg font-semibold" x-text="formatHostCount(getHostCount(current.cidr))"></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                          <p class="text-xs text-gray-500 mb-1">Account</p>
                          <p class="text-lg font-semibold" x-text="accountName(current.account_id) || 'None'"></p>
                        </div>
                      </div>
                      <div class="mb-6">
                        <h3 class="font-medium text-gray-900 mb-3">Sub-allocations</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                          <table class="w-full">
                            <thead class="bg-gray-50">
                              <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">CIDR</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Name</th>
                                <th class="px-3 py-2"></th>
                              </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                              <template x-for="b in blocks" :key="b.cidr">
                                <tr>
                                  <td class="px-3 py-2"><code class="text-xs" x-text="b.cidr"></code></td>
                                  <td class="px-3 py-2">
                                    <span x-show="b.used" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">Used</span>
                                    <span x-show="!b.used" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">Free</span>
                                  </td>
                                  <td class="px-3 py-2 text-sm" x-text="b.assigned_name || '-'"></td>
                                  <td class="px-3 py-2">
                                    <button x-show="!b.used" @click="allocateBlock(b)" class="text-blue-600 hover:text-blue-700 text-xs font-medium">Allocate</button>
                                  </td>
                                </tr>
                              </template>
                              <template x-if="blocks.length === 0">
                                <tr>
                                  <td colspan="4" class="px-3 py-6 text-center text-gray-500">
                                    <button @click="loadBlocks()" class="text-blue-600 hover:text-blue-700">Load blocks</button>
                                  </td>
                                </tr>
                              </template>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <!-- Accounts View -->
          <template x-if="tab==='accounts'">
            <div class="flex-1 overflow-auto p-6" x-data="accountsView()" x-init="init()">
              <!-- Page Header -->
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 class="text-2xl font-semibold text-gray-900">Cloud Accounts</h1>
                  <p class="text-gray-500">Manage cloud accounts and projects</p>
                </div>
                <button @click="showCreateForm = !showCreateForm" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                  New Account
                </button>
              </div>

              <!-- Create Form -->
              <div x-show="showCreateForm" x-cloak class="bg-white rounded-xl border border-gray-200 mb-6">
                <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                  <h3 class="font-semibold">Create New Account</h3>
                  <button @click="showCreateForm = false" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="p-4">
                  <div class="grid grid-cols-4 gap-4 mb-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Key *</label>
                      <input type="text" x-model="form.key" placeholder="e.g., aws:123456789012" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                      <input type="text" x-model="form.name" placeholder="e.g., Production AWS" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
                      <select x-model="form.provider" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Select...</option>
                        <option value="aws">AWS</option>
                        <option value="gcp">GCP</option>
                        <option value="azure">Azure</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Tier</label>
                      <select x-model="form.tier" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Select...</option>
                        <option value="prd">Production</option>
                        <option value="stg">Staging</option>
                        <option value="dev">Development</option>
                        <option value="sbx">Sandbox</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex justify-end">
                    <button @click="createAccount()" :disabled="creating" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                      <span x-show="creating" class="spinner mr-2"></span>
                      <span x-text="creating ? 'Creating...' : 'Create Account'"></span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Accounts Table -->
              <div class="bg-white rounded-xl border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200">
                  <input type="text" x-model="search" placeholder="Search accounts..." class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                      <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Provider</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tier</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Regions</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-4 py-3"></th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      <template x-for="a in filteredAccounts()" :key="a.id">
                        <tr class="hover:bg-gray-50">
                          <td class="px-4 py-3 font-medium text-gray-900" x-text="a.name"></td>
                          <td class="px-4 py-3"><code class="text-xs text-gray-600" x-text="a.key"></code></td>
                          <td class="px-4 py-3">
                            <span x-show="a.provider" :class="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getProviderBadgeClass(a.provider)" x-text="(a.provider || '').toUpperCase()"></span>
                            <span x-show="!a.provider" class="text-gray-400">-</span>
                          </td>
                          <td class="px-4 py-3">
                            <span x-show="a.tier" :class="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getTierBadgeClass(a.tier)" x-text="a.tier"></span>
                            <span x-show="!a.tier" class="text-gray-400">-</span>
                          </td>
                          <td class="px-4 py-3 text-sm text-gray-600">
                            <span x-show="a.regions && a.regions.length" x-text="a.regions.slice(0,2).join(', ') + (a.regions.length > 2 ? ' +' + (a.regions.length - 2) : '')"></span>
                            <span x-show="!a.regions || !a.regions.length" class="text-gray-400">-</span>
                          </td>
                          <td class="px-4 py-3 text-sm text-gray-500" x-text="new Date(a.created_at).toLocaleDateString()"></td>
                          <td class="px-4 py-3">
                            <button @click="deleteAccount(a)" class="text-red-600 hover:text-red-700 text-sm font-medium">Delete</button>
                          </td>
                        </tr>
                      </template>
                      <template x-if="filteredAccounts().length === 0">
                        <tr>
                          <td colspan="7" class="px-4 py-12 text-center">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
                            <p class="text-gray-500 font-medium">No accounts found</p>
                            <button @click="showCreateForm = true" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Account</button>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </template>

          <!-- Discovery View (Placeholder) -->
          <template x-if="tab==='discovery'">
            <div class="flex-1 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Cloud Discovery</h2>
                <p class="text-gray-500 mb-4">Automatically discover and sync cloud resources</p>
                <p class="text-sm text-gray-400">Coming in a future release</p>
              </div>
            </div>
          </template>

          <!-- Audit View (Placeholder) -->
          <template x-if="tab==='audit'">
            <div class="flex-1 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Audit Log</h2>
                <p class="text-gray-500 mb-4">Track all changes and actions in the system</p>
                <p class="text-sm text-gray-400">Coming in a future release</p>
              </div>
            </div>
          </template>

          <!-- Pool Detail Slide Panel (when selected from dashboard) -->
          <template x-if="selectedPool && tab === 'dashboard'">
            <div class="w-96 bg-white border-l border-gray-200 overflow-auto flex-shrink-0">
              <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Pool Details</h3>
                <button @click="selectedPool = null" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
              </div>
              <div class="p-4 space-y-4">
                <div>
                  <h4 class="text-2xl font-bold text-gray-900" x-text="selectedPool.name"></h4>
                  <code class="text-sm bg-gray-100 px-2 py-1 rounded" x-text="selectedPool.cidr"></code>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Type</p>
                    <p class="font-medium capitalize" x-text="selectedPool.type || 'subnet'"></p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Source</p>
                    <p class="font-medium capitalize" x-text="selectedPool.source || 'manual'"></p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Total IPs</p>
                    <p class="font-medium" x-text="formatHostCount(getHostCount(selectedPool.cidr))"></p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Status</p>
                    <p class="font-medium capitalize" x-text="selectedPool.status || 'active'"></p>
                  </div>
                </div>
                <template x-if="selectedPool.utilization !== undefined">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600">Utilization</span>
                      <span class="font-medium" x-text="selectedPool.utilization + '%'"></span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                      <div :class="'h-full rounded-full ' + getUtilizationColor(selectedPool.utilization)" :style="'width: ' + selectedPool.utilization + '%'"></div>
                    </div>
                  </div>
                </template>
                <template x-if="selectedPool.cloudId">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-600 mb-1">Cloud Resource</p>
                    <code class="text-sm" x-text="selectedPool.cloudId"></code>
                  </div>
                </template>
                <template x-if="selectedPool.driftDetails">
                  <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                      <svg class="w-5 h-5 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                      <div>
                        <p class="font-medium text-amber-800">Drift Detected</p>
                        <p class="text-sm text-amber-700 mt-1" x-text="selectedPool.driftDetails"></p>
                      </div>
                    </div>
                  </div>
                </template>
                <div class="pt-4 border-t border-gray-200 space-y-2">
                  <button @click="tab='pools'" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    Allocate Subnet
                  </button>
                  <button class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    View Audit Log
                  </button>
                </div>
              </div>
            </div>
          </template>
        </main>
      </div>
    </div>

    <!-- Import/Export Modal -->
    <div x-data="dataIO()" x-show="open" x-cloak @open-data-io.window="open=true" @click.self="open=false" @keydown.escape.window="open=false" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-auto">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Data Import / Export</h3>
          <button @click="open=false" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-2 gap-6">
            <div>
              <h4 class="font-medium mb-3">Export Data</h4>
              <div class="space-y-2 mb-4">
                <label class="flex items-center gap-2">
                  <input type="checkbox" x-model="exp.accounts" />
                  <span>Accounts</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" x-model="exp.pools" />
                  <span>Pools</span>
                </label>
              </div>
              <button @click="downloadExport()" :disabled="!exp.accounts && !exp.pools" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                Download ZIP
              </button>
            </div>
            <div>
              <h4 class="font-medium mb-3">Import Data</h4>
              <input type="file" accept=".csv" @change="onImportFile($event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
              <button x-show="imp.rows.length > 0" @click="startImport()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Import <span x-text="imp.rows.length"></span> rows
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global store for shared state
      document.addEventListener('alpine:init', () => {
        Alpine.store('app', {
          pools: [],
          accounts: [],
          async fetchPools() {
            try {
              const res = await fetch('/api/v1/pools');
              this.pools = await res.json();
            } catch (e) { console.error('Failed to fetch pools', e); }
          },
          async fetchAccounts() {
            try {
              const res = await fetch('/api/v1/accounts');
              this.accounts = await res.json();
            } catch (e) { console.error('Failed to fetch accounts', e); }
          }
        });
      });

      // Toast notifications
      function toaster() {
        return {
          toasts: [],
          init() {
            window.showToast = (message, type = 'info') => {
              const id = Math.random().toString(36).slice(2);
              this.toasts.push({ id, message, type });
              setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 3000);
            };
          }
        };
      }

      // Helper functions
      function formatHostCount(count) {
        if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
        if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
        return count.toString();
      }

      function getHostCount(cidr) {
        if (!cidr) return 0;
        const prefix = parseInt(cidr.split('/')[1], 10);
        return Math.pow(2, 32 - prefix);
      }

      function cidrToRange(cidr) {
        if (!cidr || !cidr.includes('/')) return null;
        const [ipStr, prefixStr] = cidr.split('/');
        const oct = ipStr.split('.').map(n => parseInt(n, 10));
        const p = parseInt(prefixStr, 10);
        if (oct.length !== 4 || oct.some(n => isNaN(n) || n < 0 || n > 255)) return null;
        if (isNaN(p) || p < 0 || p > 32) return null;
        const toInt = (a,b,c,d) => ((a<<24)>>>0) + (b<<16) + (c<<8) + d;
        const ip = toInt(oct[0],oct[1],oct[2],oct[3])>>>0;
        const mask = (p === 0) ? 0 : (~((1<<(32-p)) - 1))>>>0;
        const start = (ip & mask) >>> 0;
        const end = (start | (~mask >>> 0)) >>> 0;
        return { start, end };
      }

      // Main App
      function app() {
        return {
          tab: 'dashboard',
          searchQuery: '',
          pools: [],
          accounts: [],
          selectedPool: null,
          expandedNodes: new Set([]),
          showCreateForm: false,

          // Mock data for demo
          alerts: [
            { id: 1, type: 'drift', severity: 'warning', title: 'CIDR Drift Detected', message: 'staging-main VPC CIDR changed', time: '15 min ago' },
            { id: 2, type: 'utilization', severity: 'warning', title: 'High Utilization', message: 'core-networking is 72% utilized', time: '1 hour ago' },
          ],
          recentActivity: [
            { id: 1, action: 'created', entity: 'Pool', name: 'workload-002', user: 'admin', time: '10 min ago' },
            { id: 2, action: 'updated', entity: 'Pool', name: 'staging-main', user: 'admin', time: '1 hour ago' },
          ],

          async init() {
            // Restore tab from URL hash or localStorage
            const hash = location.hash.replace('#', '');
            const saved = localStorage.getItem('cp.tab');
            if (['dashboard', 'pools', 'accounts', 'discovery', 'audit'].includes(hash)) this.tab = hash;
            else if (['dashboard', 'pools', 'accounts', 'discovery', 'audit'].includes(saved)) this.tab = saved;

            this.$watch('tab', t => {
              history.replaceState(null, '', '#' + t);
              localStorage.setItem('cp.tab', t);
            });

            await this.loadData();
          },

          async loadData() {
            try {
              const [poolsRes, accountsRes] = await Promise.all([
                fetch('/api/v1/pools'),
                fetch('/api/v1/accounts')
              ]);
              this.pools = await poolsRes.json();
              this.accounts = await accountsRes.json();
              Alpine.store('app').pools = this.pools;
              Alpine.store('app').accounts = this.accounts;

              // Auto-expand root nodes
              this.pools.filter(p => !p.parent_id).forEach(p => this.expandedNodes.add(p.id));
            } catch (e) {
              console.error('Failed to load data', e);
            }
          },

          get hierarchyTree() {
            const byParent = new Map();
            for (const p of this.pools) {
              const key = p.parent_id || 'root';
              if (!byParent.has(key)) byParent.set(key, []);
              byParent.get(key).push(p);
            }

            const buildTree = (parentId) => {
              const children = byParent.get(parentId) || [];
              return children.map(p => ({
                ...p,
                type: this.inferPoolType(p),
                children: buildTree(p.id)
              }));
            };

            return buildTree('root');
          },

          inferPoolType(pool) {
            if (!pool.parent_id) return 'root';
            const prefix = parseInt(pool.cidr?.split('/')[1] || '0', 10);
            if (prefix <= 12) return 'region';
            if (prefix <= 16) return 'environment';
            return 'account';
          },

          get totalIPs() {
            return this.pools.filter(p => !p.parent_id).reduce((sum, p) => sum + getHostCount(p.cidr), 0);
          },

          get totalAllocatedIPs() {
            return this.pools.filter(p => p.parent_id).reduce((sum, p) => sum + getHostCount(p.cidr), 0);
          },

          get accountsSummary() {
            const aws = this.accounts.filter(a => a.provider === 'aws').length;
            const gcp = this.accounts.filter(a => a.provider === 'gcp').length;
            const parts = [];
            if (aws) parts.push(aws + ' AWS');
            if (gcp) parts.push(gcp + ' GCP');
            return parts.join(', ') || 'None configured';
          },

          get alertsSummary() {
            const errors = this.alerts.filter(a => a.severity === 'error').length;
            const warnings = this.alerts.filter(a => a.severity === 'warning').length;
            const parts = [];
            if (errors) parts.push(errors + ' error' + (errors > 1 ? 's' : ''));
            if (warnings) parts.push(warnings + ' warning' + (warnings > 1 ? 's' : ''));
            return parts.join(', ') || 'All clear';
          },

          toggleNode(id) {
            if (this.expandedNodes.has(id)) {
              this.expandedNodes.delete(id);
            } else {
              this.expandedNodes.add(id);
            }
            this.expandedNodes = new Set(this.expandedNodes);
          },

          expandAllNodes() {
            this.pools.forEach(p => this.expandedNodes.add(p.id));
            this.expandedNodes = new Set(this.expandedNodes);
          },

          collapseAllNodes() {
            this.expandedNodes.clear();
            this.expandedNodes = new Set();
          },

          selectPool(pool) {
            this.selectedPool = pool;
          },

          getPoolTypeColor(type) {
            const colors = { root: 'bg-purple-500', region: 'bg-blue-500', environment: 'bg-green-500', account: 'bg-amber-500' };
            return colors[type] || 'bg-gray-400';
          },

          getUtilizationColor(util) {
            if (util > 80) return 'bg-red-500';
            if (util > 60) return 'bg-amber-500';
            return 'bg-green-500';
          },

          getStatusIcon(status) {
            const icons = {
              synced: '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
              drift: '<svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
              planned: '<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
            };
            return icons[status] || '';
          },

          getAlertColors(severity) {
            const colors = { error: 'border-l-red-500 bg-red-50', warning: 'border-l-amber-500 bg-amber-50', info: 'border-l-blue-500 bg-blue-50' };
            return colors[severity] || 'border-l-gray-500 bg-gray-50';
          },

          getAlertIcon(severity) {
            const base = 'w-5 h-5';
            if (severity === 'error') return `<svg class="${base} text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            if (severity === 'warning') return `<svg class="${base} text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            return `<svg class="${base} text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
          },

          getActivityColor(action) {
            const colors = { created: 'bg-green-500', updated: 'bg-blue-500', deleted: 'bg-red-500', discovered: 'bg-purple-500', synced: 'bg-gray-400' };
            return colors[action] || 'bg-gray-400';
          },

          getProviderEmoji(provider) {
            const emojis = { aws: '', gcp: '', azure: '' };
            return emojis[provider] || '';
          },

          getProviderBadgeClass(provider) {
            const classes = { aws: 'bg-amber-100 text-amber-700', gcp: 'bg-blue-100 text-blue-700', azure: 'bg-sky-100 text-sky-700' };
            return classes[provider] || 'bg-gray-100 text-gray-700';
          },

          getTierBadgeClass(tier) {
            const classes = { prd: 'bg-red-100 text-red-700', stg: 'bg-amber-100 text-amber-700', dev: 'bg-green-100 text-green-700', sbx: 'bg-gray-100 text-gray-700' };
            return classes[tier] || 'bg-gray-100 text-gray-700';
          },

          formatHostCount,
          getHostCount
        };
      }

      // Tree node component for recursive rendering
      function treeNode(pool) {
        return {
          pool,
          initNode() {
            // Just render the node
          }
        };
      }

      // Pools View
      function poolsView() {
        return {
          pools: [],
          search: '',
          pageSize: '50',
          showCreateForm: false,
          form: { name: '', cidr: '', account_id: null },
          cidrError: '',
          creating: false,
          current: null,
          blocks: [],

          async init() {
            this.pools = Alpine.store('app').pools;
            this.$watch('$store.app.pools', (val) => { this.pools = val; });
          },

          filteredPools() {
            const q = this.search.toLowerCase();
            let arr = this.pools.filter(p => !p.parent_id);
            if (q) {
              arr = arr.filter(p =>
                (p.name || '').toLowerCase().includes(q) ||
                (p.cidr || '').toLowerCase().includes(q)
              );
            }
            return arr;
          },

          accountName(id) {
            if (!id) return '';
            const a = Alpine.store('app').accounts.find(a => a.id === id);
            return a ? a.name : '#' + id;
          },

          validateCIDR() {
            const c = (this.form.cidr || '').trim();
            this.cidrError = '';
            if (!c) { this.cidrError = 'CIDR is required'; return; }
            const range = cidrToRange(c);
            if (!range) { this.cidrError = 'Invalid CIDR format'; return; }
          },

          async createPool() {
            this.validateCIDR();
            if (this.cidrError) return;

            this.creating = true;
            try {
              const res = await fetch('/api/v1/pools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.form)
              });
              if (!res.ok) {
                const err = await res.json();
                showToast(err.error || 'Failed to create pool', 'error');
                return;
              }
              this.form = { name: '', cidr: '', account_id: null };
              this.showCreateForm = false;
              await Alpine.store('app').fetchPools();
              this.pools = Alpine.store('app').pools;
              showToast('Pool created');
            } catch (e) {
              showToast('Failed to create pool', 'error');
            } finally {
              this.creating = false;
            }
          },

          viewPool(p) {
            this.current = p;
            this.blocks = [];
            this.loadBlocks();
          },

          async loadBlocks() {
            if (!this.current) return;
            try {
              const res = await fetch(`/api/v1/pools/${this.current.id}/blocks?new_prefix_len=24&page_size=20`);
              if (res.ok) {
                const data = await res.json();
                this.blocks = Array.isArray(data) ? data : (data.items || []);
              }
            } catch (e) {
              console.error('Failed to load blocks', e);
            }
          },

          async allocateBlock(b) {
            const name = prompt(`Name for sub-pool ${b.cidr}:`);
            if (!name) return;

            try {
              const res = await fetch('/api/v1/pools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, cidr: b.cidr, parent_id: this.current.id })
              });
              if (res.ok) {
                await Alpine.store('app').fetchPools();
                this.pools = Alpine.store('app').pools;
                this.loadBlocks();
                showToast('Block allocated');
              }
            } catch (e) {
              showToast('Failed to allocate', 'error');
            }
          },

          formatHostCount,
          getHostCount,
          getProviderBadgeClass(p) { return app().getProviderBadgeClass(p); },
          getTierBadgeClass(t) { return app().getTierBadgeClass(t); }
        };
      }

      // Accounts View
      function accountsView() {
        return {
          accounts: [],
          search: '',
          showCreateForm: false,
          form: { key: '', name: '', provider: '', tier: '' },
          creating: false,

          async init() {
            this.accounts = Alpine.store('app').accounts;
            this.$watch('$store.app.accounts', (val) => { this.accounts = val; });
          },

          filteredAccounts() {
            const q = this.search.toLowerCase();
            if (!q) return this.accounts;
            return this.accounts.filter(a =>
              (a.name || '').toLowerCase().includes(q) ||
              (a.key || '').toLowerCase().includes(q) ||
              (a.provider || '').toLowerCase().includes(q)
            );
          },

          async createAccount() {
            if (!this.form.key || !this.form.name) {
              showToast('Key and name are required', 'error');
              return;
            }

            this.creating = true;
            try {
              const res = await fetch('/api/v1/accounts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.form)
              });
              if (!res.ok) {
                const err = await res.json();
                showToast(err.error || 'Failed to create account', 'error');
                return;
              }
              this.form = { key: '', name: '', provider: '', tier: '' };
              this.showCreateForm = false;
              await Alpine.store('app').fetchAccounts();
              this.accounts = Alpine.store('app').accounts;
              showToast('Account created');
            } catch (e) {
              showToast('Failed to create account', 'error');
            } finally {
              this.creating = false;
            }
          },

          async deleteAccount(a) {
            if (!confirm(`Delete account "${a.name}"?`)) return;

            try {
              const res = await fetch(`/api/v1/accounts/${a.id}`, { method: 'DELETE' });
              if (res.ok) {
                await Alpine.store('app').fetchAccounts();
                this.accounts = Alpine.store('app').accounts;
                showToast('Account deleted');
              }
            } catch (e) {
              showToast('Failed to delete', 'error');
            }
          },

          getProviderBadgeClass(p) {
            const classes = { aws: 'bg-amber-100 text-amber-700', gcp: 'bg-blue-100 text-blue-700', azure: 'bg-sky-100 text-sky-700' };
            return classes[p] || 'bg-gray-100 text-gray-700';
          },

          getTierBadgeClass(t) {
            const classes = { prd: 'bg-red-100 text-red-700', stg: 'bg-amber-100 text-amber-700', dev: 'bg-green-100 text-green-700', sbx: 'bg-gray-100 text-gray-700' };
            return classes[t] || 'bg-gray-100 text-gray-700';
          }
        };
      }

      // Data Import/Export
      function dataIO() {
        return {
          open: false,
          exp: { accounts: true, pools: true },
          imp: { file: null, headers: [], rows: [], type: 'accounts' },

          buildExportURL() {
            const ds = [];
            if (this.exp.accounts) ds.push('accounts');
            if (this.exp.pools) ds.push('pools');
            return '/api/v1/export?datasets=' + ds.join(',');
          },

          downloadExport() {
            window.open(this.buildExportURL(), '_blank');
          },

          onImportFile(ev) {
            const file = ev.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
              const lines = (reader.result || '').split('\n').filter(l => l.trim());
              if (lines.length === 0) return;

              this.imp.headers = lines[0].split(',').map(h => h.trim());
              this.imp.rows = lines.slice(1).map(l => l.split(',').map(c => c.trim()));
            };
            reader.readAsText(file);
          },

          async startImport() {
            showToast(`Importing ${this.imp.rows.length} rows...`);
            // Simplified import - would need full implementation
            this.imp = { file: null, headers: [], rows: [], type: 'accounts' };
            this.open = false;
          }
        };
      }
    </script>
  </body>
</html>
