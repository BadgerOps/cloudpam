name: Auto Release

on:
  push:
    branches: [master]
    paths:
      - 'docs/CHANGELOG.md'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create release from changelog
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.changelog.outputs.tag }}
      skip: ${{ steps.changelog.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Extract latest version from CHANGELOG
        id: changelog
        run: |
          set -euo pipefail

          # Extract the first non-Unreleased version heading
          VERSION=$(grep -m1 -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' docs/CHANGELOG.md || true)

          if [ -z "$VERSION" ]; then
            echo "No version found in CHANGELOG.md"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TAG="v${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists, skipping release"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Extract the changelog body for this version
          # Match from "## [x.y.z]" to the next "## [" or end of file
          BODY=$(awk "/^## \\[${VERSION}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" docs/CHANGELOG.md)

          # Write body to file to avoid quoting issues
          echo "$BODY" > /tmp/release-body.md

      - name: Create GitHub Release
        if: steps.changelog.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.changelog.outputs.tag }}" \
            --title "CloudPAM ${{ steps.changelog.outputs.tag }}" \
            --notes-file /tmp/release-body.md \
            --target "${{ github.sha }}"

  # Call downstream workflows directly since GITHUB_TOKEN events
  # don't trigger other workflows (GitHub Actions limitation).
  container-images:
    needs: release
    if: needs.release.outputs.skip != 'true'
    uses: ./.github/workflows/container-images.yml
    with:
      tag: ${{ needs.release.outputs.tag }}
    permissions:
      contents: read
      packages: write

  release-builds:
    needs: release
    if: needs.release.outputs.skip != 'true'
    uses: ./.github/workflows/release-builds.yml
    with:
      tag: ${{ needs.release.outputs.tag }}
    permissions:
      contents: write
