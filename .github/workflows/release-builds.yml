name: Release Builds

on:
  release:
    types: [published]
  workflow_call:
    inputs:
      tag:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-server:
    name: Build server binary
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      CGO_ENABLED: 0
      VERSION: ${{ inputs.tag || github.event.release.tag_name }}
    steps:
      - name: Checkout tag
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.tag || github.event.release.tag_name }}

      - name: Setup Go
        uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
        with:
          go-version: '1.24.x'

      - name: Build binary (-tags sqlite)
        run: |
          set -euxo pipefail
          BIN=cloudpam
          EXT=""; [ "$GOOS" = "windows" ] && EXT=".exe"
          OUT="$BIN$EXT"
          mkdir -p build
          echo "Building ${GOOS}/${GOARCH} -> build/${OUT}"
          go build -trimpath -tags sqlite -ldflags "-s -w -X main.version=${VERSION}" -o "build/${OUT}" ./cmd/cloudpam

      - name: Package archive
        run: |
          set -euxo pipefail
          ASSET_BASE="cloudpam_${VERSION}_${GOOS}_${GOARCH}"
          mkdir -p dist
          if [ "$GOOS" = "windows" ]; then
            (cd build && zip -9 "../dist/${ASSET_BASE}.zip" cloudpam.exe)
          else
            tar -C build -czf "dist/${ASSET_BASE}.tar.gz" cloudpam
          fi

      - name: Attach asset to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ inputs.tag || github.event.release.tag_name }}
          files: |
            dist/*.tar.gz
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-agent:
    name: Build agent binary
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      CGO_ENABLED: 0
      VERSION: ${{ inputs.tag || github.event.release.tag_name }}
    steps:
      - name: Checkout tag
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.tag || github.event.release.tag_name }}

      - name: Setup Go
        uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
        with:
          go-version: '1.24.x'

      - name: Build agent binary
        run: |
          set -euxo pipefail
          BIN=cloudpam-agent
          EXT=""; [ "$GOOS" = "windows" ] && EXT=".exe"
          OUT="$BIN$EXT"
          mkdir -p build
          echo "Building ${GOOS}/${GOARCH} -> build/${OUT}"
          go build -trimpath -ldflags "-s -w -X main.version=${VERSION}" -o "build/${OUT}" ./cmd/cloudpam-agent

      - name: Package archive
        run: |
          set -euxo pipefail
          ASSET_BASE="cloudpam-agent_${VERSION}_${GOOS}_${GOARCH}"
          mkdir -p dist
          if [ "$GOOS" = "windows" ]; then
            (cd build && zip -9 "../dist/${ASSET_BASE}.zip" cloudpam-agent.exe)
          else
            tar -C build -czf "dist/${ASSET_BASE}.tar.gz" cloudpam-agent
          fi

      - name: Attach asset to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ inputs.tag || github.event.release.tag_name }}
          files: |
            dist/*.tar.gz
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  checksums:
    name: Upload SHA256SUMS
    runs-on: ubuntu-latest
    needs: [build-server, build-agent]
    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
        with:
          repository: ${{ github.repository }}
          tag: ${{ inputs.tag || github.event.release.tag_name }}
          fileName: "cloudpam*"
          out-file-path: downloads
      - name: Generate checksums
        run: |
          cd downloads
          sha256sum * > SHA256SUMS.txt
          ls -la
      - name: Upload checksum to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ inputs.tag || github.event.release.tag_name }}
          files: downloads/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sbom:
    name: Upload SBOM (SPDX)
    runs-on: ubuntu-latest
    needs: [build-server, build-agent]
    steps:
      - name: Checkout tag
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.tag || github.event.release.tag_name }}
      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        with:
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ inputs.tag || github.event.release.tag_name }}
          files: sbom.spdx.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
