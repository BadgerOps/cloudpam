openapi: 3.1.0
info:
  title: CloudPAM API
  version: "0.4.0"
  description: |
    REST API for managing CloudPAM pools, accounts, blocks, data exports,
    authentication, audit logging, and schema planning.
servers:
  - url: http://localhost:8080
    description: Local development server
security:
  - BearerAuth: []
tags:
  - name: System
    description: Health, readiness, and system endpoints
  - name: Pools
    description: IP address pool management
  - name: Accounts
    description: Cloud account management
  - name: Blocks
    description: Block enumeration and assignment
  - name: Export
    description: Data export (CSV in ZIP)
  - name: Import
    description: Data import (CSV)
  - name: Schema
    description: Schema planner endpoints for bulk IP address planning
  - name: Auth
    description: API key management
  - name: Audit
    description: Audit log queries
paths:
  /healthz:
    get:
      summary: Liveness probe
      tags: [System]
      security: []
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /readyz:
    get:
      summary: Readiness probe with dependency checks
      tags: [System]
      security: []
      responses:
        "200":
          description: All checks pass
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
        "503":
          description: One or more checks failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
  /metrics:
    get:
      summary: Prometheus metrics endpoint
      tags: [System]
      security: []
      responses:
        "200":
          description: Prometheus text format metrics
          content:
            text/plain:
              schema:
                type: string
  /api/v1/test-sentry:
    get:
      summary: Test Sentry integration
      tags: [System]
      security: []
      parameters:
        - name: type
          in: query
          description: "Test type: message, error, or panic"
          schema:
            type: string
            enum: [message, error, panic]
      responses:
        "200":
          description: Test executed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
                  usage:
                    type: string
  /api/v1/pools:
    get:
      summary: List pools
      tags: [Pools]
      parameters:
        - name: include_stats
          in: query
          description: Include utilization statistics for each pool
          schema:
            type: boolean
      responses:
        "200":
          description: Pools returned successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Pool"
        default:
          $ref: "#/components/responses/Error"
    post:
      summary: Create pool
      tags: [Pools]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePool"
      responses:
        "201":
          description: Pool created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pool"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/pools/hierarchy:
    get:
      summary: Get pool hierarchy as nested tree with stats
      tags: [Pools]
      responses:
        "200":
          description: Hierarchical pool tree
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PoolWithStats"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/pools/{poolId}:
    parameters:
      - $ref: "#/components/parameters/PoolId"
    get:
      summary: Get pool
      tags: [Pools]
      responses:
        "200":
          description: Pool found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pool"
        default:
          $ref: "#/components/responses/Error"
    patch:
      summary: Update pool metadata
      tags: [Pools]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePool"
      responses:
        "200":
          description: Pool updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pool"
        default:
          $ref: "#/components/responses/Error"
    delete:
      summary: Delete pool
      tags: [Pools]
      parameters:
        - $ref: "#/components/parameters/ForceFlag"
      responses:
        "204":
          description: Pool deleted
        default:
          $ref: "#/components/responses/Error"
  /api/v1/pools/{poolId}/blocks:
    parameters:
      - $ref: "#/components/parameters/PoolId"
    get:
      summary: Enumerate candidate blocks within a pool CIDR
      tags: [Blocks]
      parameters:
        - $ref: "#/components/parameters/NewPrefixLen"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: Blocks listed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BlocksResponse"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/pools/{poolId}/stats:
    parameters:
      - $ref: "#/components/parameters/PoolId"
    get:
      summary: Get utilization statistics for a pool
      tags: [Pools]
      responses:
        "200":
          description: Pool stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PoolWithStats"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/accounts:
    get:
      summary: List accounts
      tags: [Accounts]
      responses:
        "200":
          description: Accounts returned successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Account"
        default:
          $ref: "#/components/responses/Error"
    post:
      summary: Create account
      tags: [Accounts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAccount"
      responses:
        "201":
          description: Account created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Account"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/accounts/{accountId}:
    parameters:
      - $ref: "#/components/parameters/AccountId"
    get:
      summary: Get account
      tags: [Accounts]
      responses:
        "200":
          description: Account found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Account"
        default:
          $ref: "#/components/responses/Error"
    patch:
      summary: Update account
      tags: [Accounts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AccountUpdate"
      responses:
        "200":
          description: Account updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Account"
        default:
          $ref: "#/components/responses/Error"
    delete:
      summary: Delete account
      tags: [Accounts]
      parameters:
        - $ref: "#/components/parameters/ForceFlag"
      responses:
        "204":
          description: Account deleted
        default:
          $ref: "#/components/responses/Error"
  /api/v1/blocks:
    get:
      summary: List assigned sub-pools
      tags: [Blocks]
      parameters:
        - $ref: "#/components/parameters/AccountsFilter"
        - $ref: "#/components/parameters/PoolsFilter"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: Assigned blocks listed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssignedBlocksResponse"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/export:
    get:
      summary: Export datasets as CSV inside ZIP archive
      tags: [Export]
      parameters:
        - name: datasets
          in: query
          description: Comma-separated datasets to include (accounts, pools, blocks)
          required: true
          schema:
            type: string
        - name: accounts_fields
          in: query
          description: Comma-separated account columns to include
          schema:
            type: string
        - name: pools_fields
          in: query
          description: Comma-separated pool columns to include
          schema:
            type: string
        - name: blocks_fields
          in: query
          description: Comma-separated block columns to include
          schema:
            type: string
        - $ref: "#/components/parameters/AccountsFilter"
        - $ref: "#/components/parameters/PoolsFilter"
      responses:
        "200":
          description: ZIP archive streaming response
          content:
            application/zip:
              schema:
                type: string
                format: binary
        default:
          $ref: "#/components/responses/Error"
  /api/v1/import/accounts:
    post:
      summary: Import accounts from CSV
      tags: [Import]
      requestBody:
        required: true
        content:
          text/csv:
            schema:
              type: string
              description: CSV with header row. Required columns; key, name. Optional; provider, external_id, description, platform, tier, environment, regions.
      responses:
        "200":
          description: Import results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImportResult"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/import/pools:
    post:
      summary: Import pools from CSV
      tags: [Import]
      requestBody:
        required: true
        content:
          text/csv:
            schema:
              type: string
              description: CSV with header row. Required columns; name, cidr. Optional; parent_id, account_id, account_key, type, status, source, description.
      responses:
        "200":
          description: Import results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImportResult"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/schema/check:
    post:
      summary: Check schema for conflicts with existing pools
      tags: [Schema]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SchemaCheckRequest"
      responses:
        "200":
          description: Conflict check results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchemaCheckResponse"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/schema/apply:
    post:
      summary: Bulk-create pools from a schema plan
      tags: [Schema]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SchemaApplyRequest"
      responses:
        "200":
          description: Schema apply results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchemaApplyResponse"
        "409":
          description: Conflict with existing pools (when skip_conflicts is false)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/auth/keys:
    get:
      summary: List API keys (without secrets)
      tags: [Auth]
      responses:
        "200":
          description: API keys listed
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      $ref: "#/components/schemas/APIKeyInfo"
                required: [keys]
        default:
          $ref: "#/components/responses/Error"
    post:
      summary: Create API key
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAPIKey"
      responses:
        "201":
          description: API key created. The plaintext key is returned only once.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyCreated"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/auth/keys/{keyId}:
    parameters:
      - name: keyId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: API key identifier
    delete:
      summary: Revoke API key
      tags: [Auth]
      responses:
        "204":
          description: API key revoked
        "404":
          description: API key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        default:
          $ref: "#/components/responses/Error"
  /api/v1/audit:
    get:
      summary: Query audit log
      tags: [Audit]
      parameters:
        - name: limit
          in: query
          description: Maximum events to return (default 50, max 1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          description: Number of events to skip
          schema:
            type: integer
            minimum: 0
        - name: actor
          in: query
          description: Filter by actor (API key prefix or "anonymous")
          schema:
            type: string
        - name: action
          in: query
          description: "Filter by action: create, update, delete, read"
          schema:
            type: string
            enum: [create, update, delete, read]
        - name: resource_type
          in: query
          description: "Filter by resource type: pool, account, api_key"
          schema:
            type: string
            enum: [pool, account, api_key]
        - name: since
          in: query
          description: Events on or after this time (RFC 3339)
          schema:
            type: string
            format: date-time
        - name: until
          in: query
          description: Events on or before this time (RFC 3339)
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: Audit events
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuditListResponse"
        default:
          $ref: "#/components/responses/Error"
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication. Keys use the format `cpam_<base64url>`.
        Pass in the Authorization header as `Bearer cpam_...`.
  parameters:
    PoolId:
      name: poolId
      in: path
      required: true
      schema:
        type: integer
        format: int64
      description: Pool identifier
    AccountId:
      name: accountId
      in: path
      required: true
      schema:
        type: integer
        format: int64
      description: Account identifier
    ForceFlag:
      name: force
      in: query
      description: Force cascading delete (1, true, yes)
      schema:
        type: string
    NewPrefixLen:
      name: new_prefix_len
      in: query
      required: true
      description: Desired prefix length for generated blocks
      schema:
        type: integer
        minimum: 1
        maximum: 32
    Page:
      name: page
      in: query
      description: Page number (1-indexed)
      schema:
        type: integer
        minimum: 1
    PageSize:
      name: page_size
      in: query
      description: Number of items per page; specify "all" to disable pagination
      schema:
        oneOf:
          - type: integer
            minimum: 0
          - type: string
            enum: ["all"]
    AccountsFilter:
      name: accounts
      in: query
      description: Comma-separated account IDs to filter by
      schema:
        type: string
        example: "1,2"
    PoolsFilter:
      name: pools
      in: query
      description: Comma-separated parent pool IDs to filter by
      schema:
        type: string
        example: "10,11"
  responses:
    Error:
      description: Error response
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      required: [status]
    ReadinessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, unhealthy]
        checks:
          type: object
          additionalProperties:
            type: string
            enum: [ok, error]
          example:
            database: ok
      required: [status, checks]
    Error:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
      required: [error]
    PoolType:
      type: string
      enum: [supernet, region, environment, vpc, subnet]
    PoolStatus:
      type: string
      enum: [planned, active, deprecated]
    PoolSource:
      type: string
      enum: [manual, discovered, imported]
    Pool:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        cidr:
          type: string
        parent_id:
          type: integer
          format: int64
          nullable: true
        account_id:
          type: integer
          format: int64
          nullable: true
        type:
          $ref: "#/components/schemas/PoolType"
        status:
          $ref: "#/components/schemas/PoolStatus"
        source:
          $ref: "#/components/schemas/PoolSource"
        description:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, name, cidr, type, status, source, created_at, updated_at]
    PoolStats:
      type: object
      properties:
        total_ips:
          type: integer
          format: int64
        used_ips:
          type: integer
          format: int64
        available_ips:
          type: integer
          format: int64
        utilization:
          type: number
          format: double
          description: Utilization percentage (0-100)
        child_count:
          type: integer
        direct_children:
          type: integer
      required: [total_ips, used_ips, available_ips, utilization, child_count, direct_children]
    PoolWithStats:
      type: object
      allOf:
        - $ref: "#/components/schemas/Pool"
        - type: object
          properties:
            stats:
              $ref: "#/components/schemas/PoolStats"
            children:
              type: array
              items:
                $ref: "#/components/schemas/PoolWithStats"
          required: [stats]
    CreatePool:
      type: object
      properties:
        name:
          type: string
        cidr:
          type: string
        parent_id:
          type: integer
          format: int64
          nullable: true
        account_id:
          type: integer
          format: int64
          nullable: true
        type:
          $ref: "#/components/schemas/PoolType"
        status:
          $ref: "#/components/schemas/PoolStatus"
        source:
          $ref: "#/components/schemas/PoolSource"
        description:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
      required: [name, cidr]
    UpdatePool:
      type: object
      properties:
        name:
          type: string
          nullable: true
        account_id:
          type: integer
          format: int64
          nullable: true
        type:
          $ref: "#/components/schemas/PoolType"
        status:
          $ref: "#/components/schemas/PoolStatus"
        description:
          type: string
          nullable: true
        tags:
          type: object
          additionalProperties:
            type: string
          nullable: true
    BlockInfo:
      type: object
      properties:
        cidr:
          type: string
        prefix_len:
          type: integer
        hosts:
          type: integer
          format: int64
        used:
          type: boolean
        assigned_id:
          type: integer
          format: int64
        assigned_name:
          type: string
        assigned_account_id:
          type: integer
          format: int64
        assigned_account_name:
          type: string
        exists_elsewhere:
          type: boolean
        exists_elsewhere_id:
          type: integer
          format: int64
        exists_elsewhere_name:
          type: string
      required: [cidr, prefix_len, hosts, used]
    BlocksResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/BlockInfo"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
      required: [items, total, page, page_size]
    Account:
      type: object
      properties:
        id:
          type: integer
          format: int64
        key:
          type: string
        name:
          type: string
        provider:
          type: string
        external_id:
          type: string
        description:
          type: string
        platform:
          type: string
        tier:
          type: string
        environment:
          type: string
        regions:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
      required: [id, key, name, created_at]
    CreateAccount:
      type: object
      properties:
        key:
          type: string
        name:
          type: string
        provider:
          type: string
        external_id:
          type: string
        description:
          type: string
        platform:
          type: string
        tier:
          type: string
        environment:
          type: string
        regions:
          type: array
          items:
            type: string
      required: [key, name]
    AccountUpdate:
      type: object
      properties:
        name:
          type: string
        provider:
          type: string
        external_id:
          type: string
        description:
          type: string
        platform:
          type: string
        tier:
          type: string
        environment:
          type: string
        regions:
          type: array
          items:
            type: string
    AssignedBlock:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        cidr:
          type: string
        parent_id:
          type: integer
          format: int64
        parent_name:
          type: string
        account_id:
          type: integer
          format: int64
          nullable: true
        account_name:
          type: string
        account_platform:
          type: string
        account_tier:
          type: string
        account_environment:
          type: string
        account_regions:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
      required: [id, name, cidr, parent_id, parent_name, created_at]
    AssignedBlocksResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AssignedBlock"
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
      required: [items, total, page, page_size]
    ImportResult:
      type: object
      properties:
        created:
          type: integer
          description: Number of records successfully created
        skipped:
          type: integer
          description: Number of records skipped (duplicates)
        errors:
          type: array
          items:
            type: string
          description: List of row-level error messages
      required: [created, skipped, errors]
    CreateAPIKey:
      type: object
      properties:
        name:
          type: string
          maxLength: 255
          description: Human-readable name for the key
        scopes:
          type: array
          items:
            type: string
            enum: ["pools:read", "pools:write", "accounts:read", "accounts:write", "audit:read", "keys:read", "keys:write", "*"]
          description: Permissions granted to this key
        expires_in_days:
          type: integer
          minimum: 1
          description: Key expires after this many days (omit for no expiration)
      required: [name]
    APIKeyCreated:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key:
          type: string
          description: Plaintext API key (shown only once)
          example: "cpam_abc12345..."
        prefix:
          type: string
          description: Key prefix for identification
        name:
          type: string
        scopes:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
      required: [id, key, prefix, name, scopes, created_at]
    APIKeyInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        prefix:
          type: string
        name:
          type: string
        scopes:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
        revoked:
          type: boolean
      required: [id, prefix, name, scopes, created_at, revoked]
    AuditEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        actor:
          type: string
          description: API key prefix or "anonymous"
        actor_type:
          type: string
          enum: [api_key, anonymous]
        action:
          type: string
          enum: [create, update, delete, read]
        resource_type:
          type: string
          enum: [pool, account, api_key]
        resource_id:
          type: string
        resource_name:
          type: string
        changes:
          type: object
          nullable: true
          properties:
            before:
              type: object
              additionalProperties: true
            after:
              type: object
              additionalProperties: true
        request_id:
          type: string
        ip_address:
          type: string
        status_code:
          type: integer
      required: [id, timestamp, actor, actor_type, action, resource_type, resource_id, status_code]
    SchemaPoolEntry:
      type: object
      properties:
        ref:
          type: string
          description: Unique reference ID within this schema
        name:
          type: string
        cidr:
          type: string
        type:
          type: string
          enum: [supernet, region, environment, vpc, subnet]
        parent_ref:
          type: string
          description: Reference to parent pool's ref (empty for root)
      required: [ref, name, cidr, type]
    SchemaCheckRequest:
      type: object
      properties:
        pools:
          type: array
          items:
            $ref: "#/components/schemas/SchemaPoolEntry"
      required: [pools]
    SchemaConflict:
      type: object
      properties:
        planned_cidr:
          type: string
        planned_name:
          type: string
        existing_pool_id:
          type: integer
          format: int64
        existing_pool_name:
          type: string
        existing_cidr:
          type: string
        overlap_type:
          type: string
          enum: [overlap, contains, contained_by]
      required: [planned_cidr, planned_name, existing_pool_id, existing_pool_name, existing_cidr, overlap_type]
    SchemaCheckResponse:
      type: object
      properties:
        conflicts:
          type: array
          items:
            $ref: "#/components/schemas/SchemaConflict"
        total_pools:
          type: integer
        conflict_count:
          type: integer
      required: [conflicts, total_pools, conflict_count]
    SchemaApplyRequest:
      type: object
      properties:
        pools:
          type: array
          items:
            $ref: "#/components/schemas/SchemaPoolEntry"
          description: Pools in topological order (parents before children)
        status:
          type: string
          enum: [planned, active, deprecated]
          description: Status to assign to all created pools (default "planned")
        tags:
          type: object
          additionalProperties:
            type: string
          description: Tags to apply to all created pools
        skip_conflicts:
          type: boolean
          description: Skip conflict check with existing pools (default false)
      required: [pools]
    SchemaApplyResponse:
      type: object
      properties:
        created:
          type: integer
          description: Number of pools successfully created
        skipped:
          type: integer
          description: Number of pools skipped due to errors
        errors:
          type: array
          items:
            type: string
          description: List of error messages for failed pools
        root_pool_id:
          type: integer
          format: int64
          description: ID of the root pool (first pool without a parent_ref)
        pool_map:
          type: object
          additionalProperties:
            type: integer
            format: int64
          description: Mapping of ref to created pool ID
      required: [created, skipped, errors, root_pool_id, pool_map]
    AuditListResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/AuditEvent"
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
      required: [events, total, limit, offset]
