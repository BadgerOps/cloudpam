openapi: 3.1.0
info:
  title: CloudPAM Observability API
  description: |
    API endpoints for audit logging, metrics, and health checks.

    ## Audit Log API

    The audit log API provides access to the complete history of administrative
    actions performed in CloudPAM. Events are stored in the database and can be
    queried, filtered, and exported for compliance and security purposes.

    ## Health Checks

    Health endpoints support Kubernetes liveness and readiness probes, as well
    as detailed component health status for debugging.

    ## Metrics

    Prometheus-compatible metrics are exposed at `/metrics` for scraping.
  version: 1.0.0
  contact:
    name: CloudPAM Team

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Audit
    description: Audit log operations
  - name: Health
    description: Health and readiness checks
  - name: Metrics
    description: Prometheus metrics

paths:
  # ---------------------------------------------------------------------------
  # Audit Log Endpoints
  # ---------------------------------------------------------------------------
  /audit/events:
    get:
      summary: List audit events
      description: |
        Returns a paginated list of audit events with optional filtering.
        Events are sorted by timestamp descending (newest first).
      operationId: listAuditEvents
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/CursorParam'
        - name: actor_id
          in: query
          description: Filter by actor ID
          schema:
            type: string
            format: uuid
        - name: actor_type
          in: query
          description: Filter by actor type
          schema:
            type: string
            enum: [user, api_token, system]
        - name: action
          in: query
          description: Filter by action (supports prefix matching with *)
          schema:
            type: string
          examples:
            exact:
              value: pool.create
              summary: Exact action match
            prefix:
              value: pool.*
              summary: All pool actions
        - name: resource_type
          in: query
          description: Filter by resource type
          schema:
            type: string
            enum: [pool, account, user, role, team, api_token, sso_config, schema_plan]
        - name: resource_id
          in: query
          description: Filter by resource ID
          schema:
            type: string
            format: uuid
        - name: outcome
          in: query
          description: Filter by outcome
          schema:
            type: string
            enum: [success, failure]
        - name: from
          in: query
          description: Start of time range (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End of time range (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: q
          in: query
          description: Full-text search across event data
          schema:
            type: string
      responses:
        '200':
          description: Paginated list of audit events
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - meta
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
                  filters:
                    $ref: '#/components/schemas/AvailableFilters'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/events/{eventId}:
    get:
      summary: Get audit event details
      description: Returns detailed information about a specific audit event.
      operationId: getAuditEvent
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: eventId
          in: path
          required: true
          description: Audit event ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Audit event details
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                properties:
                  data:
                    $ref: '#/components/schemas/AuditEventDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /audit/export:
    post:
      summary: Export audit log
      description: |
        Exports audit events in the specified format. Supports CSV, JSON, and PDF.
        Large exports may be processed asynchronously.
      operationId: exportAuditLog
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditExportRequest'
      responses:
        '200':
          description: Export completed (for small exports)
          content:
            text/csv:
              schema:
                type: string
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditEvent'
            application/pdf:
              schema:
                type: string
                format: binary
        '202':
          description: Export started (for large exports)
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [pending, processing]
                  estimated_completion:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/statistics:
    get:
      summary: Get audit statistics
      description: Returns aggregate statistics about audit events.
      operationId: getAuditStatistics
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: from
          in: query
          description: Start of time range
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End of time range
          schema:
            type: string
            format: date-time
        - name: granularity
          in: query
          description: Time bucket granularity
          schema:
            type: string
            enum: [hour, day, week, month]
            default: day
      responses:
        '200':
          description: Audit statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditStatistics'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/retention:
    get:
      summary: Get audit retention settings
      description: Returns the current audit log retention configuration.
      operationId: getAuditRetention
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Retention settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditRetentionSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      summary: Update audit retention settings
      description: Updates the audit log retention configuration.
      operationId: updateAuditRetention
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditRetentionSettings'
      responses:
        '200':
          description: Updated retention settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditRetentionSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/export-config:
    get:
      summary: Get SIEM export configuration
      description: Returns the current SIEM/log export configuration.
      operationId: getAuditExportConfig
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Export configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditExportConfig'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      summary: Update SIEM export configuration
      description: Updates the SIEM/log export configuration.
      operationId: updateAuditExportConfig
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditExportConfig'
      responses:
        '200':
          description: Updated export configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditExportConfig'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /audit/export-config/test:
    post:
      summary: Test SIEM export configuration
      description: Sends a test event to the configured SIEM destination.
      operationId: testAuditExportConfig
      tags:
        - Audit
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Test successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Test failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ---------------------------------------------------------------------------
  # Health Endpoints
  # ---------------------------------------------------------------------------
  /health:
    get:
      summary: Liveness check
      description: |
        Simple liveness check for Kubernetes probes.
        Returns 200 if the service is running.
      operationId: healthLiveness
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]

  /ready:
    get:
      summary: Readiness check
      description: |
        Readiness check for Kubernetes probes.
        Returns 200 if the service is ready to accept traffic.
        Checks database connectivity and other dependencies.
      operationId: healthReadiness
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /health/detailed:
    get:
      summary: Detailed health status
      description: |
        Returns detailed health status of all components.
        Requires authentication.
      operationId: healthDetailed
      tags:
        - Health
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Detailed health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ---------------------------------------------------------------------------
  # Metrics Endpoint
  # ---------------------------------------------------------------------------
  /metrics:
    get:
      summary: Prometheus metrics
      description: |
        Prometheus-compatible metrics endpoint.
        Returns metrics in Prometheus text format.
      operationId: getMetrics
      tags:
        - Metrics
      security: []
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP http_requests_total Total HTTP requests
                # TYPE http_requests_total counter
                http_requests_total{method="GET",path="/api/v1/pools",status="200"} 1234

components:
  # ---------------------------------------------------------------------------
  # Security Schemes
  # ---------------------------------------------------------------------------
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  # ---------------------------------------------------------------------------
  # Parameters
  # ---------------------------------------------------------------------------
  parameters:
    LimitParam:
      name: limit
      in: query
      description: Maximum number of items to return
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    CursorParam:
      name: cursor
      in: query
      description: Pagination cursor for next page
      schema:
        type: string

  # ---------------------------------------------------------------------------
  # Responses
  # ---------------------------------------------------------------------------
  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
          description: Total number of items (if available)
        limit:
          type: integer
        cursor:
          type: string
          description: Cursor for next page (null if no more pages)
        has_more:
          type: boolean

    AuditEvent:
      type: object
      required:
        - id
        - timestamp
        - actor
        - action
        - resource
        - outcome
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        actor:
          $ref: '#/components/schemas/AuditActor'
        action:
          type: string
          description: Action performed (e.g., pool.create, user.login)
        resource:
          $ref: '#/components/schemas/AuditResource'
        outcome:
          type: string
          enum: [success, failure]
        summary:
          type: string
          description: Human-readable summary of the event

    AuditEventDetail:
      allOf:
        - $ref: '#/components/schemas/AuditEvent'
        - type: object
          properties:
            changes:
              $ref: '#/components/schemas/AuditChanges'
            metadata:
              type: object
              additionalProperties: true
            request_id:
              type: string
              description: Correlation ID for the request
            related_events:
              type: array
              description: Related audit events (same resource or actor)
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  timestamp:
                    type: string
                    format: date-time
                  action:
                    type: string
                  summary:
                    type: string

    AuditActor:
      type: object
      required:
        - type
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [user, api_token, system]
        email:
          type: string
          format: email
        name:
          type: string
        ip_address:
          type: string

    AuditResource:
      type: object
      required:
        - type
        - id
      properties:
        type:
          type: string
        id:
          type: string
          format: uuid
        name:
          type: string

    AuditChanges:
      type: object
      properties:
        before:
          type: object
          additionalProperties: true
          description: State before the change (null for creates)
        after:
          type: object
          additionalProperties: true
          description: State after the change (null for deletes)

    AuditExportRequest:
      type: object
      required:
        - format
      properties:
        format:
          type: string
          enum: [csv, json, pdf]
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        filters:
          type: object
          properties:
            actor_ids:
              type: array
              items:
                type: string
                format: uuid
            actions:
              type: array
              items:
                type: string
            resource_types:
              type: array
              items:
                type: string
            outcomes:
              type: array
              items:
                type: string
                enum: [success, failure]

    AuditStatistics:
      type: object
      properties:
        total_events:
          type: integer
        time_range:
          type: object
          properties:
            from:
              type: string
              format: date-time
            to:
              type: string
              format: date-time
        events_by_action:
          type: object
          additionalProperties:
            type: integer
        events_by_resource_type:
          type: object
          additionalProperties:
            type: integer
        events_by_outcome:
          type: object
          properties:
            success:
              type: integer
            failure:
              type: integer
        events_over_time:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              count:
                type: integer
        top_actors:
          type: array
          items:
            type: object
            properties:
              actor:
                $ref: '#/components/schemas/AuditActor'
              event_count:
                type: integer

    AuditRetentionSettings:
      type: object
      properties:
        retention_days:
          type: integer
          minimum: 0
          description: Days to retain audit logs (0 = forever)
        auto_delete_enabled:
          type: boolean
          description: Whether to automatically delete old events

    AuditExportConfig:
      type: object
      properties:
        enabled:
          type: boolean
        destinations:
          type: array
          items:
            $ref: '#/components/schemas/AuditExportDestination'

    AuditExportDestination:
      type: object
      required:
        - type
        - endpoint
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [syslog, webhook, s3, gcs, splunk]
        endpoint:
          type: string
          description: Destination endpoint (URL, address, bucket)
        format:
          type: string
          enum: [json, cef, leef]
          default: json
        enabled:
          type: boolean
          default: true
        credentials:
          type: object
          description: Authentication credentials (write-only)
          writeOnly: true

    AvailableFilters:
      type: object
      properties:
        actions:
          type: array
          items:
            type: string
        resource_types:
          type: array
          items:
            type: string
        actor_types:
          type: array
          items:
            type: string

    HealthStatus:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        checks:
          type: object
          additionalProperties:
            type: object
            properties:
              status:
                type: string
                enum: [healthy, degraded, unhealthy]
              message:
                type: string

    DetailedHealthStatus:
      type: object
      required:
        - status
        - components
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        uptime:
          type: string
          description: Service uptime duration
        version:
          type: string
          description: Application version
        components:
          type: object
          additionalProperties:
            type: object
            properties:
              status:
                type: string
                enum: [healthy, degraded, unhealthy]
              message:
                type: string
              last_checked:
                type: string
                format: date-time
              duration_ms:
                type: number
                description: Time taken for health check
