#!/usr/bin/env bash
# Pre-commit hook: runs golangci-lint on staged Go files.
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or:      just install-hooks
set -euo pipefail

# Only run if Go files are staged.
STAGED_GO=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
if [ -z "$STAGED_GO" ]; then
  exit 0
fi

# Find golangci-lint.
LINT=""
for candidate in golangci-lint "$HOME/go/bin/golangci-lint" "$(go env GOPATH 2>/dev/null)/bin/golangci-lint"; do
  if command -v "$candidate" >/dev/null 2>&1; then LINT="$candidate"; break; fi
done

if [ -z "$LINT" ]; then
  echo "pre-commit: golangci-lint not found, skipping lint check."
  echo "  Install: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | sh -s -- -b \$(go env GOPATH)/bin v2.1.6"
  exit 0
fi

echo "pre-commit: running golangci-lint..."
$LINT run --timeout=5m --new-from-rev=HEAD
